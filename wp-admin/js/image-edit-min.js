!function(i){var t=window.imageEdit={iasapi:{},hold:{},postid:"",_view:!1,handleCropToolClick:function(e,a,s){var o=i("#image-preview-"+e),n=this.iasapi.getSelection();isNaN(n.x1)&&(this.setCropSelection(e,{x1:0,y1:0,x2:o.innerWidth(),y2:o.innerHeight(),width:o.innerWidth(),height:o.innerHeight()}),n=this.iasapi.getSelection()),0===n.x1&&0===n.y1&&0===n.x2&&0===n.y2?(this.iasapi.setSelection(0,0,o.innerWidth(),o.innerHeight(),!0),this.iasapi.setOptions({show:!0}),this.iasapi.update()):t.crop(e,a,s)},intval:function(i){return 0|i},setDisabled:function(i,t){t?i.removeClass("disabled").prop("disabled",!1):i.addClass("disabled").prop("disabled",!0)},init:function(t){var e=this,a=i("#image-editor-"+e.postid),s=e.intval(i("#imgedit-x-"+t).val()),o=e.intval(i("#imgedit-y-"+t).val());e.postid!==t&&a.length&&e.close(e.postid),e.hold.w=e.hold.ow=s,e.hold.h=e.hold.oh=o,e.hold.xy_ratio=s/o,e.hold.sizer=parseFloat(i("#imgedit-sizer-"+t).val()),e.postid=t,i("#imgedit-response-"+t).empty(),i('input[type="text"]',"#imgedit-panel-"+t).keypress(function(t){var e=t.keyCode;if(36<e&&e<41&&i(this).blur(),13===e)return t.preventDefault(),t.stopPropagation(),!1})},toggleEditor:function(t,e){var a=i("#imgedit-wait-"+t);e?a.fadeIn("fast"):a.fadeOut("fast")},toggleHelp:function(t){var e=i(t);return e.attr("aria-expanded","false"===e.attr("aria-expanded")?"true":"false").parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast"),!1},getTarget:function(t){return i('input[name="imgedit-target-'+t+'"]:checked',"#imgedit-save-target-"+t).val()||"full"},scaleChanged:function(t,e,a){var s=i("#imgedit-scale-width-"+t),o=i("#imgedit-scale-height-"+t),n=i("#imgedit-scale-warn-"+t),d="",r="";!1!==this.validateNumeric(a)&&(e?(r=""!==s.val()?Math.round(s.val()/this.hold.xy_ratio):"",o.val(r)):(d=""!==o.val()?Math.round(o.val()*this.hold.xy_ratio):"",s.val(d)),r&&r>this.hold.oh||d&&d>this.hold.ow?n.css("visibility","visible"):n.css("visibility","hidden"))},getSelRatio:function(t){var e=this.hold.w,a=this.hold.h,s=this.intval(i("#imgedit-crop-width-"+t).val()),o=this.intval(i("#imgedit-crop-height-"+t).val());return s&&o?s+":"+o:e&&a?e+":"+a:"1:1"},filterHistory:function(t,e){var a=i("#imgedit-history-"+t).val(),s,o,n,d,r=[];if(""!==a){if(a=JSON.parse(a),(s=this.intval(i("#imgedit-undone-"+t).val()))>0)for(;s>0;)a.pop(),s--;if(e){if(!a.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";(n=(n=a[a.length-1]).c||n.r||n.f||!1)&&(this.hold.w=n.fw,this.hold.h=n.fh)}for(o in a)(d=a[o]).hasOwnProperty("c")?r[o]={c:{x:d.c.x,y:d.c.y,w:d.c.w,h:d.c.h}}:d.hasOwnProperty("r")?r[o]={r:d.r.r}:d.hasOwnProperty("f")&&(r[o]={f:d.f.f});return JSON.stringify(r)}return""},refreshEditor:function(e,a,s){var o=this,n,d;o.toggleEditor(e,1),n={action:"imgedit-preview",_ajax_nonce:a,postid:e,history:o.filterHistory(e,1),rand:o.intval(1e6*Math.random())},d=i('<img id="image-preview-'+e+'" alt="" />').on("load",{history:n.history},function(a){var o,n,r=i("#imgedit-crop-"+e),l=t,h;""!==a.data.history&&(h=JSON.parse(a.data.history))[h.length-1].hasOwnProperty("c")&&(l.setDisabled(i("#image-undo-"+e),!0),i("#image-undo-"+e).focus()),r.empty().append(d),o=Math.max(l.hold.w,l.hold.h),n=Math.max(i(d).width(),i(d).height()),l.hold.sizer=o>n?n/o:1,l.initCrop(e,d,r),null!=s&&s(),i("#imgedit-history-"+e).val()&&"0"===i("#imgedit-undone-"+e).val()?i("input.imgedit-submit-btn","#imgedit-panel-"+e).removeAttr("disabled"):i("input.imgedit-submit-btn","#imgedit-panel-"+e).prop("disabled",!0),l.toggleEditor(e,0)}).on("error",function(){i("#imgedit-crop-"+e).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>"),o.toggleEditor(e,0)}).attr("src",ajaxurl+"?"+i.param(n))},action:function(t,e,a){var s=this,o,n,d,r,l;if(s.notsaved(t))return!1;if(o={action:"image-editor",_ajax_nonce:e,postid:t},"scale"===a){if(n=i("#imgedit-scale-width-"+t),d=i("#imgedit-scale-height-"+t),r=s.intval(n.val()),l=s.intval(d.val()),r<1)return n.focus(),!1;if(l<1)return d.focus(),!1;if(r===s.hold.ow||l===s.hold.oh)return!1;o.do="scale",o.fwidth=r,o.fheight=l}else{if("restore"!==a)return!1;o.do="restore"}s.toggleEditor(t,1),i.post(ajaxurl,o,function(e){i("#image-editor-"+t).empty().append(e),s.toggleEditor(t,0),s._view&&s._view.refresh()})},save:function(e,a){var s,o=this.getTarget(e),n=this.filterHistory(e,0),d=this;if(""===n)return!1;this.toggleEditor(e,1),s={action:"image-editor",_ajax_nonce:a,postid:e,history:n,target:o,context:i("#image-edit-context").length?i("#image-edit-context").val():null,do:"save"},i.post(ajaxurl,s,function(a){var s=JSON.parse(a);if(s.error)return i("#imgedit-response-"+e).html('<div class="error"><p>'+s.error+"</p></div>"),void t.close(e);s.fw&&s.fh&&i("#media-dims-"+e).html(s.fw+" &times; "+s.fh),s.thumbnail&&i(".thumbnail","#thumbnail-head-"+e).attr("src",""+s.thumbnail),s.msg&&i("#imgedit-response-"+e).html('<div class="updated"><p>'+s.msg+"</p></div>"),d._view?d._view.save():t.close(e)})},open:function(e,a,s){this._view=s;var o,n,d=i("#image-editor-"+e),r=i("#media-head-"+e),l=i("#imgedit-open-btn-"+e),h=l.siblings(".spinner");if(!l.hasClass("button-activated"))return h.addClass("is-active"),n={action:"image-editor",_ajax_nonce:a,postid:e,do:"open"},o=i.ajax({url:ajaxurl,type:"post",data:n,beforeSend:function(){l.addClass("button-activated")}}).done(function(i){d.html(i),r.fadeOut("fast",function(){d.fadeIn("fast"),l.removeClass("button-activated"),h.removeClass("is-active")}),t.init(e)})},imgLoaded:function(t){var e=i("#image-preview-"+t),a=i("#imgedit-crop-"+t);void 0===this.hold.sizer&&this.init(t),this.initCrop(t,e,a),this.setCropSelection(t,{x1:0,y1:0,x2:0,y2:0,width:e.innerWidth(),height:e.innerHeight()}),this.toggleEditor(t,0),i(".imgedit-wrap .imgedit-help-toggle").eq(0).focus()},initCrop:function(e,a,s){var o=this,n=i("#imgedit-sel-width-"+e),d=i("#imgedit-sel-height-"+e),r;o.iasapi=i(a).imgAreaSelect({parent:s,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,onInit:function(t){(r=i(t)).next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute"),s.children().on("mousedown, touchstart",function(i){var t=!1,a,s;i.shiftKey&&(a=o.iasapi.getSelection(),s=o.getSelRatio(e),t=a&&a.width&&a.height?a.width+":"+a.height:s),o.iasapi.setOptions({aspectRatio:t})})},onSelectStart:function(){t.setDisabled(i("#imgedit-crop-sel-"+e),1)},onSelectEnd:function(i,a){t.setCropSelection(e,a)},onSelectChange:function(i,e){var a=t.hold.sizer;n.val(t.round(e.width/a)),d.val(t.round(e.height/a))}})},setCropSelection:function(t,e){var a;if(!(e=e||0)||e.width<3&&e.height<3)return this.setDisabled(i(".imgedit-crop","#imgedit-panel-"+t),1),this.setDisabled(i("#imgedit-crop-sel-"+t),1),i("#imgedit-sel-width-"+t).val(""),i("#imgedit-sel-height-"+t).val(""),i("#imgedit-selection-"+t).val(""),!1;a={x:e.x1,y:e.y1,w:e.width,h:e.height},this.setDisabled(i(".imgedit-crop","#imgedit-panel-"+t),1),i("#imgedit-selection-"+t).val(JSON.stringify(a))},close:function(t,e){if((e=e||!1)&&this.notsaved(t))return!1;this.iasapi={},this.hold={},this._view?this._view.back():i("#image-editor-"+t).fadeOut("fast",function(){i("#media-head-"+t).fadeIn("fast",function(){i("#imgedit-open-btn-"+t).focus()}),i(this).empty()})},notsaved:function(t){var e=i("#imgedit-history-"+t).val(),a=""!==e?JSON.parse(e):[],s;return this.intval(i("#imgedit-undone-"+t).val())<a.length&&!confirm(i("#imgedit-leaving-"+t).html())},addStep:function(t,e,a){for(var s=this,o=i("#imgedit-history-"+e),n=""!==o.val()?JSON.parse(o.val()):[],d=i("#imgedit-undone-"+e),r=s.intval(d.val());r>0;)n.pop(),r--;d.val(0),n.push(t),o.val(JSON.stringify(n)),s.refreshEditor(e,a,function(){s.setDisabled(i("#image-undo-"+e),!0),s.setDisabled(i("#image-redo-"+e),!1)})},rotate:function(t,e,a,s){if(i(s).hasClass("disabled"))return!1;this.addStep({r:{r:t,fw:this.hold.h,fh:this.hold.w}},e,a)},flip:function(t,e,a,s){if(i(s).hasClass("disabled"))return!1;this.addStep({f:{f:t,fw:this.hold.w,fh:this.hold.h}},e,a)},crop:function(t,e,a){var s=i("#imgedit-selection-"+t).val(),o=this.intval(i("#imgedit-sel-width-"+t).val()),n=this.intval(i("#imgedit-sel-height-"+t).val());if(i(a).hasClass("disabled")||""===s)return!1;(s=JSON.parse(s)).w>0&&s.h>0&&o>0&&n>0&&(s.fw=o,s.fh=n,this.addStep({c:s},t,e))},undo:function(t,e){var a=this,s=i("#image-undo-"+t),o=i("#imgedit-undone-"+t),n=a.intval(o.val())+1;s.hasClass("disabled")||(o.val(n),a.refreshEditor(t,e,function(){var e=i("#imgedit-history-"+t),o=""!==e.val()?JSON.parse(e.val()):[];a.setDisabled(i("#image-redo-"+t),!0),a.setDisabled(s,n<o.length),o.length===n&&i("#image-redo-"+t).focus()}))},redo:function(t,e){var a=this,s=i("#image-redo-"+t),o=i("#imgedit-undone-"+t),n=a.intval(o.val())-1;s.hasClass("disabled")||(o.val(n),a.refreshEditor(t,e,function(){a.setDisabled(i("#image-undo-"+t),!0),a.setDisabled(s,n>0),0===n&&i("#image-undo-"+t).focus()}))},setNumSelection:function(t,e){var a,s=i("#imgedit-sel-width-"+t),o=i("#imgedit-sel-height-"+t),n=this.intval(s.val()),d=this.intval(o.val()),r=i("#image-preview-"+t),l=r.height(),h=r.width(),g=this.hold.sizer,c,v,p,u,m=this.iasapi;if(!1!==this.validateNumeric(e))return n<1?(s.val(""),!1):d<1?(o.val(""),!1):void(n&&d&&(a=m.getSelection())&&(p=a.x1+Math.round(n*g),u=a.y1+Math.round(d*g),c=a.x1,v=a.y1,p>h&&(c=0,p=h,s.val(Math.round(p/g))),u>l&&(v=0,u=l,o.val(Math.round(u/g))),m.setSelection(c,v,p,u),m.update(),this.setCropSelection(t,m.getSelection())))},round:function(i){var t;return i=Math.round(i),this.hold.sizer>.6?i:"1"===(t=i.toString().slice(-1))?i-1:"9"===t?i+1:i},setRatioSelection:function(t,e,a){var s,o,n=this.intval(i("#imgedit-crop-width-"+t).val()),d=this.intval(i("#imgedit-crop-height-"+t).val()),r=i("#image-preview-"+t).height();!1!==this.validateNumeric(a)&&n&&d&&(this.iasapi.setOptions({aspectRatio:n+":"+d}),(s=this.iasapi.getSelection(!0))&&((o=Math.ceil(s.y1+(s.x2-s.x1)/(n/d)))>r&&(o=r,e?i("#imgedit-crop-height-"+t).val(""):i("#imgedit-crop-width-"+t).val("")),this.iasapi.setSelection(s.x1,s.y1,s.x2,o),this.iasapi.update()))},validateNumeric:function(t){if(!this.intval(i(t).val()))return i(t).val(""),!1}}}(jQuery);