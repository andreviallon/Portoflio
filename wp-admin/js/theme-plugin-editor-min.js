window.wp||(window.wp={}),wp.themePluginEditor=function($){"use strict";var e,t;e={l10n:{lintError:{singular:"",plural:""},saveAlert:"",saveError:""},codeEditor:{},instance:null,noticeElements:{},dirty:!1,lintErrors:[]},e.init=function t(i,s){e.form=i,s&&$.extend(e,s),e.noticeTemplate=wp.template("wp-file-editor-notice"),e.noticesContainer=e.form.find(".editor-notices"),e.submitButton=e.form.find(":input[name=submit]"),e.spinner=e.form.find(".submit .spinner"),e.form.on("submit",e.submit),e.textarea=e.form.find("#newcontent"),e.textarea.on("change",e.onChange),e.warning=$(".file-editor-warning"),e.warning.length>0&&e.showWarning(),!1!==e.codeEditor&&_.defer(function(){e.initCodeEditor()}),$(e.initFileBrowser),$(window).on("beforeunload",function(){if(e.dirty)return e.l10n.saveAlert})},e.showWarning=function(){var t=e.warning.find(".file-editor-warning-message").text();$("#wpwrap").attr("aria-hidden","true"),$(document.body).addClass("modal-open").append(e.warning.detach()),e.warning.removeClass("hidden").find(".file-editor-warning-go-back").focus(),e.warningTabbables=e.warning.find("a, button"),e.warningTabbables.on("keydown",e.constrainTabbing),e.warning.on("click",".file-editor-warning-dismiss",e.dismissWarning),setTimeout(function(){wp.a11y.speak(wp.sanitize.stripTags(t.replace(/\s+/g," ")),"assertive")},1e3)},e.constrainTabbing=function(t){var i,s;9===t.which&&(i=e.warningTabbables.first()[0],s=e.warningTabbables.last()[0],s!==t.target||t.shiftKey?i===t.target&&t.shiftKey&&(s.focus(),t.preventDefault()):(i.focus(),t.preventDefault()))},e.dismissWarning=function(){wp.ajax.post("dismiss-wp-pointer",{pointer:e.themeOrPlugin+"_editor_notice"}),e.warning.remove(),$("#wpwrap").removeAttr("aria-hidden"),$("body").removeClass("modal-open")},e.onChange=function(){e.dirty=!0,e.removeNotice("file_saved")},e.submit=function(t){var i={},s;if(t.preventDefault(),$.each(e.form.serializeArray(),function(){i[this.name]=this.value}),e.instance&&(i.newcontent=e.instance.codemirror.getValue()),!e.isSaving){if(e.lintErrors.length)return void e.instance.codemirror.setCursor(e.lintErrors[0].from.line);e.isSaving=!0,e.textarea.prop("readonly",!0),e.instance&&e.instance.codemirror.setOption("readOnly",!0),e.spinner.addClass("is-active"),s=wp.ajax.post("edit-theme-plugin-file",i),e.lastSaveNoticeCode&&e.removeNotice(e.lastSaveNoticeCode),s.done(function(t){e.lastSaveNoticeCode="file_saved",e.addNotice({code:e.lastSaveNoticeCode,type:"success",message:t.message,dismissible:!0}),e.dirty=!1}),s.fail(function(t){var i=$.extend({code:"save_error",message:e.l10n.saveError},t,{type:"error",dismissible:!0});e.lastSaveNoticeCode=i.code,e.addNotice(i)}),s.always(function(){e.spinner.removeClass("is-active"),e.isSaving=!1,e.textarea.prop("readonly",!1),e.instance&&e.instance.codemirror.setOption("readOnly",!1)})}},e.addNotice=function(t){var i;if(!t.code)throw new Error("Missing code.");return e.removeNotice(t.code),i=$(e.noticeTemplate(t)),i.hide(),i.find(".notice-dismiss").on("click",function(){e.removeNotice(t.code),t.onDismiss&&t.onDismiss(t)}),wp.a11y.speak(t.message),e.noticesContainer.append(i),i.slideDown("fast"),e.noticeElements[t.code]=i,i},e.removeNotice=function(t){return!!e.noticeElements[t]&&(e.noticeElements[t].slideUp("fast",function(){$(this).remove()}),delete e.noticeElements[t],!0)},e.initCodeEditor=function t(){var i,s;i=$.extend({},e.codeEditor),i.onTabPrevious=function(){$("#templateside").find(":tabbable").last().focus()},i.onTabNext=function(){$("#template").find(":tabbable:not(.CodeMirror-code)").first().focus()},i.onChangeLintingErrors=function(t){e.lintErrors=t,0===t.length&&e.submitButton.toggleClass("disabled",!1)},i.onUpdateErrorNotice=function t(s){var o,r;e.submitButton.toggleClass("disabled",s.length>0),0!==s.length?(o=1===s.length?e.l10n.lintError.singular.replace("%d","1"):e.l10n.lintError.plural.replace("%d",String(s.length)),r=e.addNotice({code:"lint_errors",type:"error",message:o,dismissible:!1}),r.find("input[type=checkbox]").on("click",function(){i.onChangeLintingErrors([]),e.removeNotice("lint_errors")})):e.removeNotice("lint_errors")},s=wp.codeEditor.initialize($("#newcontent"),i),s.codemirror.on("change",e.onChange),$(s.codemirror.display.lineDiv).attr({role:"textbox","aria-multiline":"true","aria-labelledby":"theme-plugin-editor-label","aria-describedby":"editor-keyboard-trap-help-1 editor-keyboard-trap-help-2 editor-keyboard-trap-help-3 editor-keyboard-trap-help-4"}),$("#theme-plugin-editor-label").on("click",function(){s.codemirror.focus()}),e.instance=s},e.initFileBrowser=function e(){var i=$("#templateside");i.find('[role="group"]').parent().attr("aria-expanded",!1),i.find(".notice").parents("[aria-expanded]").attr("aria-expanded",!0),i.find('[role="tree"]').each(function(){new t(this).init()}),i.find(".current-file:first").each(function(){this.scrollIntoViewIfNeeded?this.scrollIntoViewIfNeeded():this.scrollIntoView(!1)})};/**
	 * Creates a new TreeitemLink.
	 *
	 * @since 4.9.0
	 * @class
	 * @private
	 * @see {@link https://www.w3.org/TR/wai-aria-practices-1.1/examples/treeview/treeview-2/treeview-2b.html|W3C Treeview Example}
	 * @license W3C-20150513
	 */
var i=function(){var e=function(e,t,i){if("object"==typeof e){e.tabIndex=-1,this.tree=t,this.groupTreeitem=i,this.domNode=e,this.label=e.textContent.trim(),this.stopDefaultClick=!1,e.getAttribute("aria-label")&&(this.label=e.getAttribute("aria-label").trim()),this.isExpandable=!1,this.isVisible=!1,this.inGroup=!1,i&&(this.inGroup=!0);for(var s=e.firstElementChild;s;){if("ul"==s.tagName.toLowerCase()){s.setAttribute("role","group"),this.isExpandable=!0;break}s=s.nextElementSibling}this.keyCode=Object.freeze({RETURN:13,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40})}};return e.prototype.init=function(){this.domNode.tabIndex=-1,this.domNode.getAttribute("role")||this.domNode.setAttribute("role","treeitem"),this.domNode.addEventListener("keydown",this.handleKeydown.bind(this)),this.domNode.addEventListener("click",this.handleClick.bind(this)),this.domNode.addEventListener("focus",this.handleFocus.bind(this)),this.domNode.addEventListener("blur",this.handleBlur.bind(this)),this.isExpandable?(this.domNode.firstElementChild.addEventListener("mouseover",this.handleMouseOver.bind(this)),this.domNode.firstElementChild.addEventListener("mouseout",this.handleMouseOut.bind(this))):(this.domNode.addEventListener("mouseover",this.handleMouseOver.bind(this)),this.domNode.addEventListener("mouseout",this.handleMouseOut.bind(this)))},e.prototype.isExpanded=function(){return!!this.isExpandable&&"true"===this.domNode.getAttribute("aria-expanded")},e.prototype.handleKeydown=function(e){function t(e){return 1===e.length&&e.match(/\S/)}function i(e){"*"==r?(e.tree.expandAllSiblingItems(e),o=!0):t(r)&&(e.tree.setFocusByFirstCharacter(e,r),o=!0)}var s=e.currentTarget,o=!1,r=e.key,n;if(this.stopDefaultClick=!1,!(e.altKey||e.ctrlKey||e.metaKey)){if(e.shift)e.keyCode==this.keyCode.SPACE||e.keyCode==this.keyCode.RETURN?(e.stopPropagation(),this.stopDefaultClick=!0):t(r)&&i(this);else switch(e.keyCode){case this.keyCode.SPACE:case this.keyCode.RETURN:this.isExpandable?(this.isExpanded()?this.tree.collapseTreeitem(this):this.tree.expandTreeitem(this),o=!0):(e.stopPropagation(),this.stopDefaultClick=!0);break;case this.keyCode.UP:this.tree.setFocusToPreviousItem(this),o=!0;break;case this.keyCode.DOWN:this.tree.setFocusToNextItem(this),o=!0;break;case this.keyCode.RIGHT:this.isExpandable&&(this.isExpanded()?this.tree.setFocusToNextItem(this):this.tree.expandTreeitem(this)),o=!0;break;case this.keyCode.LEFT:this.isExpandable&&this.isExpanded()?(this.tree.collapseTreeitem(this),o=!0):this.inGroup&&(this.tree.setFocusToParentItem(this),o=!0);break;case this.keyCode.HOME:this.tree.setFocusToFirstItem(),o=!0;break;case this.keyCode.END:this.tree.setFocusToLastItem(),o=!0;break;default:t(r)&&i(this);break}o&&(e.stopPropagation(),e.preventDefault())}},e.prototype.handleClick=function(e){e.target!==this.domNode&&e.target!==this.domNode.firstElementChild||this.isExpandable&&(this.isExpanded()?this.tree.collapseTreeitem(this):this.tree.expandTreeitem(this),e.stopPropagation())},e.prototype.handleFocus=function(e){var t=this.domNode;this.isExpandable&&(t=t.firstElementChild),t.classList.add("focus")},e.prototype.handleBlur=function(e){var t=this.domNode;this.isExpandable&&(t=t.firstElementChild),t.classList.remove("focus")},e.prototype.handleMouseOver=function(e){e.currentTarget.classList.add("hover")},e.prototype.handleMouseOut=function(e){e.currentTarget.classList.remove("hover")},e}();/**
	 * Creates a new TreeLinks.
	 *
	 * @since 4.9.0
	 * @class
	 * @private
	 * @see {@link https://www.w3.org/TR/wai-aria-practices-1.1/examples/treeview/treeview-2/treeview-2b.html|W3C Treeview Example}
	 * @license W3C-20150513
	 */
return t=function(){var e=function(e){"object"==typeof e&&(this.domNode=e,this.treeitems=[],this.firstChars=[],this.firstTreeitem=null,this.lastTreeitem=null)};return e.prototype.init=function(){function e(t,s,o){for(var r=t.firstElementChild,n=o;r;)("li"===r.tagName.toLowerCase()&&"span"===r.firstElementChild.tagName.toLowerCase()||"a"===r.tagName.toLowerCase())&&(n=new i(r,s,o),n.init(),s.treeitems.push(n),s.firstChars.push(n.label.substring(0,1).toLowerCase())),r.firstElementChild&&e(r,s,n),r=r.nextElementSibling}this.domNode.getAttribute("role")||this.domNode.setAttribute("role","tree"),e(this.domNode,this,!1),this.updateVisibleTreeitems(),this.firstTreeitem.domNode.tabIndex=0},e.prototype.setFocusToItem=function(e){for(var t=0;t<this.treeitems.length;t++){var i=this.treeitems[t];i===e?(i.domNode.tabIndex=0,i.domNode.focus()):i.domNode.tabIndex=-1}},e.prototype.setFocusToNextItem=function(e){for(var t=!1,i=this.treeitems.length-1;i>=0;i--){var s=this.treeitems[i];if(s===e)break;s.isVisible&&(t=s)}t&&this.setFocusToItem(t)},e.prototype.setFocusToPreviousItem=function(e){for(var t=!1,i=0;i<this.treeitems.length;i++){var s=this.treeitems[i];if(s===e)break;s.isVisible&&(t=s)}t&&this.setFocusToItem(t)},e.prototype.setFocusToParentItem=function(e){e.groupTreeitem&&this.setFocusToItem(e.groupTreeitem)},e.prototype.setFocusToFirstItem=function(){this.setFocusToItem(this.firstTreeitem)},e.prototype.setFocusToLastItem=function(){this.setFocusToItem(this.lastTreeitem)},e.prototype.expandTreeitem=function(e){e.isExpandable&&(e.domNode.setAttribute("aria-expanded",!0),this.updateVisibleTreeitems())},e.prototype.expandAllSiblingItems=function(e){for(var t=0;t<this.treeitems.length;t++){var i=this.treeitems[t];i.groupTreeitem===e.groupTreeitem&&i.isExpandable&&this.expandTreeitem(i)}},e.prototype.collapseTreeitem=function(e){var t=!1;(t=e.isExpanded()?e:e.groupTreeitem)&&(t.domNode.setAttribute("aria-expanded",!1),this.updateVisibleTreeitems(),this.setFocusToItem(t))},e.prototype.updateVisibleTreeitems=function(){this.firstTreeitem=this.treeitems[0];for(var e=0;e<this.treeitems.length;e++){var t=this.treeitems[e],i=t.domNode.parentNode;for(t.isVisible=!0;i&&i!==this.domNode;)"false"==i.getAttribute("aria-expanded")&&(t.isVisible=!1),i=i.parentNode;t.isVisible&&(this.lastTreeitem=t)}},e.prototype.setFocusByFirstCharacter=function(e,t){var i,s;t=t.toLowerCase(),i=this.treeitems.indexOf(e)+1,i===this.treeitems.length&&(i=0),s=this.getIndexFirstChars(i,t),-1===s&&(s=this.getIndexFirstChars(0,t)),s>-1&&this.setFocusToItem(this.treeitems[s])},e.prototype.getIndexFirstChars=function(e,t){for(var i=e;i<this.firstChars.length;i++)if(this.treeitems[i].isVisible&&t===this.firstChars[i])return i;return-1},e}(),e}(jQuery);