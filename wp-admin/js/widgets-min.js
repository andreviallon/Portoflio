var wpWidgets;!function($){var e=$(document);wpWidgets={hoveredSidebar:null,l10n:{save:"{save}",saved:"{saved}",saveAlert:"{saveAlert}"},dirtyWidgets:{},init:function(){var i,t,d=this,s=$(".widgets-chooser"),a=s.find(".widgets-chooser-sidebars"),n=$("div.widgets-sortables"),r=!("undefined"==typeof isRtl||!isRtl);$("#widgets-right .sidebar-name").click(function(){var i=$(this),t=i.closest(".widgets-holder-wrap "),d=i.find(".handlediv");t.hasClass("closed")?(t.removeClass("closed"),d.attr("aria-expanded","true"),i.parent().sortable("refresh")):(t.addClass("closed"),d.attr("aria-expanded","false")),e.triggerHandler("wp-pin-menu")}).find(".handlediv").each(function(e){0!==e&&$(this).attr("aria-expanded","false")}),$(window).on("beforeunload.widgets",function(e){var i=[],t;if($.each(d.dirtyWidgets,function(e,t){t&&i.push(e)}),0!==i.length)return t=$("#widgets-right").find(".widget").filter(function(){return-1!==i.indexOf($(this).prop("id").replace(/^widget-\d+_/,""))}),t.each(function(){$(this).hasClass("open")||$(this).find(".widget-title-action:first").click()}),t.first().each(function(){this.scrollIntoViewIfNeeded?this.scrollIntoViewIfNeeded():this.scrollIntoView(),$(this).find(".widget-inside :tabbable:first").focus()}),e.returnValue=wpWidgets.l10n.saveAlert,e.returnValue}),$("#widgets-left .sidebar-name").click(function(){var i=$(this).closest(".widgets-holder-wrap");i.toggleClass("closed").find(".handlediv").attr("aria-expanded",!i.hasClass("closed")),e.triggerHandler("wp-pin-menu")}),$(document.body).bind("click.widgets-toggle",function(e){var i=$(e.target),t={"z-index":100},s,a,n,o,l,c,g,w=i.closest(".widget").find(".widget-top button.widget-action");i.parents(".widget-top").length&&!i.parents("#available-widgets").length?(s=i.closest("div.widget"),a=s.children(".widget-inside"),n=parseInt(s.find("input.widget-width").val(),10),o=s.parent().width(),g=a.find(".widget-id").val(),s.data("dirty-state-initialized")||(c=a.find(".widget-control-save"),c.prop("disabled",!0).val(wpWidgets.l10n.saved),a.on("input change",function(){d.dirtyWidgets[g]=!0,s.addClass("widget-dirty"),c.prop("disabled",!1).val(wpWidgets.l10n.save)}),s.data("dirty-state-initialized",!0)),a.is(":hidden")?(n>250&&n+30>o&&s.closest("div.widgets-sortables").length&&(l=s.closest("div.widget-liquid-right").length?r?"margin-right":"margin-left":r?"margin-left":"margin-right",t[l]=o-(n+30)+"px",s.css(t)),w.attr("aria-expanded","true"),a.slideDown("fast",function(){s.addClass("open")})):(w.attr("aria-expanded","false"),a.slideUp("fast",function(){s.attr("style",""),s.removeClass("open")})),e.preventDefault()):i.hasClass("widget-control-save")?(wpWidgets.save(i.closest("div.widget"),0,1,0),e.preventDefault()):i.hasClass("widget-control-remove")?(wpWidgets.save(i.closest("div.widget"),1,1,0),e.preventDefault()):i.hasClass("widget-control-close")?(s=i.closest("div.widget"),s.removeClass("open"),w.attr("aria-expanded","false"),wpWidgets.close(s),e.preventDefault()):"inactive-widgets-control-remove"===i.attr("id")&&(wpWidgets.removeInactiveWidgets(),e.preventDefault())}),n.children(".widget").each(function(){var e=$(this);wpWidgets.appendTitle(this),e.find("p.widget-error").length&&e.find(".widget-action").trigger("click").attr("aria-expanded","true")}),$("#widget-list").children(".widget").draggable({connectToSortable:"div.widgets-sortables",handle:"> .widget-top > .widget-title",distance:2,helper:"clone",zIndex:100,containment:"#wpwrap",refreshPositions:!0,start:function(e,i){var s=$(this).find(".widgets-chooser");i.helper.find("div.widget-description").hide(),t=this.id,s.length&&($("#wpbody-content").append(s.hide()),i.helper.find(".widgets-chooser").remove(),d.clearWidgetSelection())},stop:function(){i&&$(i).hide(),i=""}}),n.droppable({tolerance:"intersect",over:function(e){var i=$(e.target).parent();wpWidgets.hoveredSidebar&&!i.is(wpWidgets.hoveredSidebar)&&wpWidgets.closeSidebar(e),i.hasClass("closed")&&(wpWidgets.hoveredSidebar=i,i.removeClass("closed").find(".handlediv").attr("aria-expanded","true")),$(this).sortable("refresh")},out:function(e){wpWidgets.hoveredSidebar&&wpWidgets.closeSidebar(e)}}),n.sortable({placeholder:"widget-placeholder",items:"> .widget",handle:"> .widget-top > .widget-title",cursor:"move",distance:2,containment:"#wpwrap",tolerance:"pointer",refreshPositions:!0,start:function(e,i){var t,d=$(this),s=d.parent(),a=i.item.children(".widget-inside");"block"===a.css("display")&&(i.item.removeClass("open"),i.item.find(".widget-top button.widget-action").attr("aria-expanded","false"),a.hide(),$(this).sortable("refreshPositions")),s.hasClass("closed")||(t=i.item.hasClass("ui-draggable")?d.height():1+d.height(),d.css("min-height",t+"px"))},stop:function(d,s){var a,n,r,o,l,c,g=s.item,w=t;if(wpWidgets.hoveredSidebar=null,g.hasClass("deleting"))return wpWidgets.save(g,1,0,1),void g.remove();a=g.find("input.add_new").val(),n=g.find("input.multi_number").val(),g.attr("style","").removeClass("ui-draggable"),t="",a&&("multi"===a?(g.html(g.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,n)})),g.attr("id",w.replace("__i__",n)),n++,$("div#"+w).find("input.multi_number").val(n)):"single"===a&&(g.attr("id","new-"+w),i="div#"+w),wpWidgets.save(g,0,0,1),g.find("input.add_new").val(""),e.trigger("widget-added",[g])),r=g.parent(),r.parent().hasClass("closed")&&(r.parent().removeClass("closed").find(".handlediv").attr("aria-expanded","true"),o=r.children(".widget"),o.length>1&&(l=o.get(0),c=g.get(0),l.id&&c.id&&l.id!==c.id&&$(l).before(g))),a?g.find(".widget-action").trigger("click"):wpWidgets.saveOrder(r.attr("id"))},activate:function(){$(this).parent().addClass("widget-hover")},deactivate:function(){$(this).css("min-height","").parent().removeClass("widget-hover")},receive:function(e,i){var t=$(i.sender);if(this.id.indexOf("orphaned_widgets")>-1)return void t.sortable("cancel");t.attr("id").indexOf("orphaned_widgets")>-1&&!t.children(".widget").length&&t.parents(".orphan-sidebar").slideUp(400,function(){$(this).remove()})}}).sortable("option","connectWith","div.widgets-sortables"),$("#available-widgets").droppable({tolerance:"pointer",accept:function(e){return"widget-list"!==$(e).parent().attr("id")},drop:function(e,i){i.draggable.addClass("deleting"),$("#removing-widget").hide().children("span").empty()},over:function(e,i){i.draggable.addClass("deleting"),$("div.widget-placeholder").hide(),i.draggable.hasClass("ui-sortable-helper")&&$("#removing-widget").show().children("span").html(i.draggable.find("div.widget-title").children("h3").html())},out:function(e,i){i.draggable.removeClass("deleting"),$("div.widget-placeholder").show(),$("#removing-widget").hide().children("span").empty()}}),$("#widgets-right .widgets-holder-wrap").each(function(e,i){var t=$(i),d=t.find(".sidebar-name h2").text(),s=t.find(".widgets-sortables").attr("id"),n=$('<li tabindex="0">').text($.trim(d));0===e&&n.addClass("widgets-chooser-selected"),a.append(n),n.data("sidebarId",s)}),$("#available-widgets .widget .widget-title").on("click.widgets-chooser",function(){var e=$(this).closest(".widget");e.hasClass("widget-in-question")||$("#widgets-left").hasClass("chooser")?d.closeChooser():(d.clearWidgetSelection(),$("#widgets-left").addClass("chooser"),e.addClass("widget-in-question").children(".widget-description").after(s),s.slideDown(300,function(){a.find(".widgets-chooser-selected").focus()}),a.find("li").on("focusin.widgets-chooser",function(){a.find(".widgets-chooser-selected").removeClass("widgets-chooser-selected"),$(this).addClass("widgets-chooser-selected")}))}),s.on("click.widgets-chooser",function(e){var i=$(e.target);i.hasClass("button-primary")?(d.addWidget(s),d.closeChooser()):i.hasClass("widgets-chooser-cancel")&&d.closeChooser()}).on("keyup.widgets-chooser",function(e){e.which===$.ui.keyCode.ENTER?$(e.target).hasClass("widgets-chooser-cancel")?d.closeChooser():(d.addWidget(s),d.closeChooser()):e.which===$.ui.keyCode.ESCAPE&&d.closeChooser()})},saveOrder:function(e){var i={action:"widgets-order",savewidgets:$("#_wpnonce_widgets").val(),sidebars:[]};e&&$("#"+e).find(".spinner:first").addClass("is-active"),$("div.widgets-sortables").each(function(){$(this).sortable&&(i["sidebars["+$(this).attr("id")+"]"]=$(this).sortable("toArray").join(","))}),$.post(ajaxurl,i,function(){$("#inactive-widgets-control-remove").prop("disabled",!$("#wp_inactive_widgets .widget").length),$(".spinner").removeClass("is-active")})},save:function(i,t,d,s){var a=this,n,r,o=i.closest("div.widgets-sortables").attr("id"),l=i.find("form");(t||!l.prop("checkValidity")||l[0].checkValidity())&&(n=l.serialize(),i=$(i),$(".spinner",i).addClass("is-active"),r={action:"save-widget",savewidgets:$("#_wpnonce_widgets").val(),sidebar:o},t&&(r.delete_widget=1),n+="&"+$.param(r),$.post(ajaxurl,n,function(n){var r=$("input.widget-id",i).val();t?($("input.widget_number",i).val()||$("#available-widgets").find("input.widget-id").each(function(){$(this).val()===r&&$(this).closest("div.widget").show()}),d?(s=0,i.slideUp("fast",function(){$(this).remove(),wpWidgets.saveOrder(),delete a.dirtyWidgets[r]})):(i.remove(),delete a.dirtyWidgets[r],"wp_inactive_widgets"===o&&$("#inactive-widgets-control-remove").prop("disabled",!$("#wp_inactive_widgets .widget").length))):($(".spinner").removeClass("is-active"),n&&n.length>2&&($("div.widget-content",i).html(n),wpWidgets.appendTitle(i),i.find(".widget-control-save").prop("disabled",!0).val(wpWidgets.l10n.saved),i.removeClass("widget-dirty"),delete a.dirtyWidgets[r],e.trigger("widget-updated",[i]),"wp_inactive_widgets"===o&&$("#inactive-widgets-control-remove").prop("disabled",!$("#wp_inactive_widgets .widget").length))),s&&wpWidgets.saveOrder()}))},removeInactiveWidgets:function(){var e=$(".remove-inactive-widgets"),i=this,t,d;$(".spinner",e).addClass("is-active"),t={action:"delete-inactive-widgets",removeinactivewidgets:$("#_wpnonce_remove_inactive_widgets").val()},d=$.param(t),$.post(ajaxurl,d,function(){$("#wp_inactive_widgets .widget").each(function(){var e=$(this);delete i.dirtyWidgets[e.find("input.widget-id").val()],e.remove()}),$("#inactive-widgets-control-remove").prop("disabled",!0),$(".spinner",e).removeClass("is-active")})},appendTitle:function(e){var i=$('input[id*="-title"]',e).val()||"";i&&(i=": "+i.replace(/<[^<>]+>/g,"").replace(/</g,"&lt;").replace(/>/g,"&gt;")),$(e).children(".widget-top").children(".widget-title").children().children(".in-widget-title").html(i)},close:function(e){e.children(".widget-inside").slideUp("fast",function(){e.attr("style","").find(".widget-top button.widget-action").attr("aria-expanded","false").focus()})},addWidget:function(i){var t,d,s,a,n,r,o,l=i.find(".widgets-chooser-selected").data("sidebarId"),c=$("#"+l);t=$("#available-widgets").find(".widget-in-question").clone(),d=t.attr("id"),s=t.find("input.add_new").val(),a=t.find("input.multi_number").val(),t.find(".widgets-chooser").remove(),"multi"===s?(t.html(t.html().replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,a)})),t.attr("id",d.replace("__i__",a)),a++,$("#"+d).find("input.multi_number").val(a)):"single"===s&&(t.attr("id","new-"+d),$("#"+d).hide()),c.closest(".widgets-holder-wrap").removeClass("closed").find(".handlediv").attr("aria-expanded","true"),c.append(t),c.sortable("refresh"),wpWidgets.save(t,0,0,1),t.find("input.add_new").val(""),e.trigger("widget-added",[t]),n=$(window).scrollTop(),r=n+$(window).height(),o=c.offset(),o.bottom=o.top+c.outerHeight(),(n>o.bottom||r<o.top)&&$("html, body").animate({scrollTop:o.top-130},200),window.setTimeout(function(){t.find(".widget-title").trigger("click")},250)},closeChooser:function(){var e=this;$(".widgets-chooser").slideUp(200,function(){$("#wpbody-content").append(this),e.clearWidgetSelection()})},clearWidgetSelection:function(){$("#widgets-left").removeClass("chooser"),$(".widget-in-question").removeClass("widget-in-question")},closeSidebar:function(e){this.hoveredSidebar.addClass("closed").find(".handlediv").attr("aria-expanded","false"),$(e.target).css("min-height",""),this.hoveredSidebar=null}},e.ready(function(){wpWidgets.init()})}(jQuery);