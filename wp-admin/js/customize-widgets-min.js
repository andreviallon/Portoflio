!function(e,t){function i(e,t){function i(n){n||(e.expanded.unbind(i),t.focus())}e.focus(),e.expanded.bind(i)}function n(e){var t,i={number:null,id_base:null};return(t=e.match(/^(.+)-(\d+)$/))?(i.id_base=t[1],i.number=parseInt(t[2],10)):i.id_base=e,i}function s(e){var t=n(e),i;return i="widget_"+t.id_base,t.number&&(i+="["+t.number+"]"),i}if(e&&e.customize){var d=e.customize,a;d.Widgets=d.Widgets||{},d.Widgets.savedWidgetIds={},d.Widgets.data=_wpCustomizeWidgetsSettings||{},a=d.Widgets.data.l10n,d.Widgets.WidgetModel=Backbone.Model.extend({id:null,temp_id:null,classname:null,control_tpl:null,description:null,is_disabled:null,is_multi:null,multi_number:null,name:null,id_base:null,transport:null,params:[],width:null,height:null,search_matched:!0}),d.Widgets.WidgetCollection=Backbone.Collection.extend({model:d.Widgets.WidgetModel,doSearch:function(e){this.terms!==e&&(this.terms=e,this.terms.length>0&&this.search(this.terms),""===this.terms&&this.each(function(e){e.set("search_matched",!0)}))},search:function(e){var t,i;e=(e=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).replace(/ /g,")(?=.*"),t=new RegExp("^(?=.*"+e+").+","i"),this.each(function(e){i=[e.get("name"),e.get("id"),e.get("description")].join(" "),e.set("search_matched",t.test(i))})}}),d.Widgets.availableWidgets=new d.Widgets.WidgetCollection(d.Widgets.data.availableWidgets),d.Widgets.SidebarModel=Backbone.Model.extend({after_title:null,after_widget:null,before_title:null,before_widget:null,class:null,description:null,id:null,name:null,is_rendered:!1}),d.Widgets.SidebarCollection=Backbone.Collection.extend({model:d.Widgets.SidebarModel}),d.Widgets.registeredSidebars=new d.Widgets.SidebarCollection(d.Widgets.data.registeredSidebars),d.Widgets.AvailableWidgetsPanelView=e.Backbone.View.extend({el:"#available-widgets",events:{"input #widgets-search":"search","keyup #widgets-search":"search","focus .widget-tpl":"focus","click .widget-tpl":"_submit","keypress .widget-tpl":"_submit",keydown:"keyboardAccessible"},selected:null,currentSidebarControl:null,$search:null,$clearResults:null,searchMatchesCount:null,initialize:function(){var e=this;this.$search=t("#widgets-search"),this.$clearResults=this.$el.find(".clear-results"),_.bindAll(this,"close"),this.listenTo(this.collection,"change",this.updateList),this.updateList(),this.searchMatchesCount=this.collection.length,t("#customize-controls, #available-widgets .customize-section-title").on("click keydown",function(i){var n=t(i.target).is(".add-new-widget, .add-new-widget *");t("body").hasClass("adding-widget")&&!n&&e.close()}),this.$clearResults.on("click",function(){e.$search.val("").focus().trigger("keyup")}),d.previewer.bind("url",this.close)},search:function(e){var t;this.collection.doSearch(e.target.value),this.updateSearchMatchesCount(),this.announceSearchMatches(),this.selected&&!this.selected.is(":visible")&&(this.selected.removeClass("selected"),this.selected=null),this.selected&&!e.target.value&&(this.selected.removeClass("selected"),this.selected=null),!this.selected&&e.target.value&&(t=this.$el.find("> .widget-tpl:visible:first")).length&&this.select(t),""!==e.target.value?this.$clearResults.addClass("is-visible"):""===e.target.value&&this.$clearResults.removeClass("is-visible"),this.searchMatchesCount?this.$el.removeClass("no-widgets-found"):this.$el.addClass("no-widgets-found")},updateSearchMatchesCount:function(){this.searchMatchesCount=this.collection.where({search_matched:!0}).length},announceSearchMatches:_.debounce(function(){var t=a.widgetsFound.replace("%d",this.searchMatchesCount);this.searchMatchesCount||(t=a.noWidgetsFound),e.a11y.speak(t)},500),updateList:function(){this.collection.each(function(e){var i=t("#widget-tpl-"+e.id);i.toggle(e.get("search_matched")&&!e.get("is_disabled")),e.get("is_disabled")&&i.is(this.selected)&&(this.selected=null)})},select:function(e){this.selected=t(e),this.selected.siblings(".widget-tpl").removeClass("selected"),this.selected.addClass("selected")},focus:function(e){this.select(t(e.currentTarget))},_submit:function(e){"keypress"===e.type&&13!==e.which&&32!==e.which||this.submit(t(e.currentTarget))},submit:function(e){var i,n,s;e||(e=this.selected),e&&this.currentSidebarControl&&(this.select(e),i=t(this.selected).data("widget-id"),(n=this.collection.findWhere({id:i}))&&((s=this.currentSidebarControl.addWidget(n.get("id_base")))&&s.focus(),this.close()))},open:function(e){this.currentSidebarControl=e,_(this.currentSidebarControl.getWidgetFormControls()).each(function(e){e.params.is_wide&&e.collapseForm()}),d.section.has("publish_settings")&&d.section("publish_settings").collapse(),t("body").addClass("adding-widget"),this.$el.find(".selected").removeClass("selected"),this.collection.doSearch(""),d.settings.browser.mobile||this.$search.focus()},close:function(e){(e=e||{}).returnFocus&&this.currentSidebarControl&&this.currentSidebarControl.container.find(".add-new-widget").focus(),this.currentSidebarControl=null,this.selected=null,t("body").removeClass("adding-widget"),this.$search.val("")},keyboardAccessible:function(e){var i=13===e.which,n=27===e.which,s=40===e.which,d=38===e.which,a=9===e.which,o=e.shiftKey,r=null,c=this.$el.find("> .widget-tpl:visible:first"),l=this.$el.find("> .widget-tpl:visible:last"),g=t(e.target).is(this.$search),u=t(e.target).is(".widget-tpl:visible:last");if(s||d)return s?g?r=c:this.selected&&0!==this.selected.nextAll(".widget-tpl:visible").length&&(r=this.selected.nextAll(".widget-tpl:visible:first")):d&&(g?r=l:this.selected&&0!==this.selected.prevAll(".widget-tpl:visible").length&&(r=this.selected.prevAll(".widget-tpl:visible:first"))),this.select(r),void(r?r.focus():this.$search.focus());i&&!this.$search.val()||(i?this.submit():n&&this.close({returnFocus:!0}),this.currentSidebarControl&&a&&(o&&g||!o&&u)&&(this.currentSidebarControl.container.find(".add-new-widget").focus(),e.preventDefault()))}}),d.Widgets.formSyncHandlers={rss:function(e,i,n){var s=i.find(".widget-error:first"),d=t("<div>"+n+"</div>").find(".widget-error:first");s.length&&d.length?s.replaceWith(d):s.length?s.remove():d.length&&i.find(".widget-content:first").prepend(d)}},d.Widgets.WidgetControl=d.Control.extend({defaultExpandedArguments:{duration:"fast",completeCallback:t.noop},initialize:function(e,i){var n=this;n.widgetControlEmbedded=!1,n.widgetContentEmbedded=!1,n.expanded=new d.Value(!1),n.expandedArgumentsQueue=[],n.expanded.bind(function(e){var i=n.expandedArgumentsQueue.shift();i=t.extend({},n.defaultExpandedArguments,i),n.onChangeExpanded(e,i)}),n.altNotice=!0,d.Control.prototype.initialize.call(n,e,i)},ready:function(){var e=this;e.section()?d.section(e.section(),function(t){var i=function(n){n&&(e.embedWidgetControl(),t.expanded.unbind(i))};t.expanded()?i(!0):t.expanded.bind(i)}):e.embedWidgetControl()},embedWidgetControl:function(){var e=this,i;this.widgetControlEmbedded||(this.widgetControlEmbedded=!0,i=t(this.params.widget_control),this.container.append(i),this._setupModel(),this._setupWideWidget(),this._setupControlToggle(),this._setupWidgetTitle(),this._setupReorderUI(),this._setupHighlightEffects(),this._setupUpdateUI(),this._setupRemoveUI())},embedWidgetContent:function(){var e=this,i;this.embedWidgetControl(),this.widgetContentEmbedded||(this.widgetContentEmbedded=!0,this.notifications.container=this.getNotificationsContainerElement(),this.notifications.render(),i=t(this.params.widget_content),this.container.find(".widget-content:first").append(i),t(document).trigger("widget-added",[this.container.find(".widget:first")]))},_setupModel:function(){var e=this,t;t=function(){d.Widgets.savedWidgetIds[e.params.widget_id]=!0},d.bind("ready",t),d.bind("saved",t),this._updateCount=0,this.isWidgetUpdating=!1,this.liveUpdateMode=!0,this.setting.bind(function(t,i){_(i).isEqual(t)||e.isWidgetUpdating||e.updateWidget({instance:t})})},_setupWideWidget:function(){var e=this,i,n,s,a,o;!this.params.is_wide||t(window).width()<=640||(i=this.container.find(".widget-inside"),n=i.find("> .form"),s=t(".wp-full-overlay-sidebar-content:first"),this.container.addClass("wide-widget-control"),this.container.find(".form:first").css({"max-width":this.params.width,"min-height":this.params.height}),o=function(){var s=e.container.offset().top,d=t(window).height(),a=n.outerHeight(),o;i.css("max-height",d),o=Math.max(0,Math.min(Math.max(s,0),d-a)),i.css("top",o)},a=t("#customize-theme-controls"),this.container.on("expand",function(){o(),s.on("scroll",o),t(window).on("resize",o),a.on("expanded collapsed",o)}),this.container.on("collapsed",function(){s.off("scroll",o),t(window).off("resize",o),a.off("expanded collapsed",o)}),d.each(function(t){0===t.id.indexOf("sidebars_widgets[")&&t.bind(function(){e.container.hasClass("expanded")&&o()})}))},_setupControlToggle:function(){var e=this,t;this.container.find(".widget-top").on("click",function(t){var i;t.preventDefault(),e.getSidebarWidgetsControl().isReordering||e.expanded(!e.expanded())}),(t=this.container.find(".widget-control-close")).on("click",function(t){t.preventDefault(),e.collapse(),e.container.find(".widget-top .widget-action:first").focus()})},_setupWidgetTitle:function(){var e=this,t;t=function(){var t=e.setting().title,i=e.container.find(".in-widget-title");t?i.text(": "+t):i.text("")},this.setting.bind(t),t()},_setupReorderUI:function(){var i=this,n,s,o,r,c;n=function(e){e.siblings(".selected").removeClass("selected"),e.addClass("selected");var t=e.data("id")===i.params.sidebar_id;i.container.find(".move-widget-btn").prop("disabled",t)},this.container.find(".widget-title-action").after(t(d.Widgets.data.tpl.widgetReorderNav)),c=_.template(d.Widgets.data.tpl.moveWidgetArea),s=t(c({sidebars:_(d.Widgets.registeredSidebars.toArray()).pluck("attributes")})),this.container.find(".widget-top").after(s),(r=function(){var e=s.find("li"),a,o=0;a=e.filter(function(){return t(this).data("id")===i.params.sidebar_id}),e.each(function(){var e=t(this),i,s,r;i=e.data("id"),r=(s=d.Widgets.registeredSidebars.get(i)).get("is_rendered"),e.toggle(r),r&&(o+=1),e.hasClass("selected")&&!r&&n(a)}),o>1?i.container.find(".move-widget").show():i.container.find(".move-widget").hide()})(),d.Widgets.registeredSidebars.on("change:is_rendered",r),(o=this.container.find(".widget-reorder-nav")).find(".move-widget, .move-widget-down, .move-widget-up").each(function(){t(this).prepend(i.container.find(".widget-title").text()+": ")}).on("click keypress",function(n){if("keypress"!==n.type||13===n.which||32===n.which)if(t(this).focus(),t(this).is(".move-widget"))i.toggleWidgetMoveArea();else{var s=t(this).is(".move-widget-down"),d=t(this).is(".move-widget-up"),o=i.getWidgetSidebarPosition();if(d&&0===o||s&&o===i.getSidebarWidgetsControl().setting().length-1)return;d?(i.moveUp(),e.a11y.speak(a.widgetMovedUp)):(i.moveDown(),e.a11y.speak(a.widgetMovedDown)),t(this).focus()}}),this.container.find(".widget-area-select").on("click keypress","li",function(e){"keypress"===e.type&&13!==e.which&&32!==e.which||(e.preventDefault(),n(t(this)))}),this.container.find(".move-widget-btn").click(function(){i.getSidebarWidgetsControl().toggleReordering(!1);var e=i.params.sidebar_id,t=i.container.find(".widget-area-select li.selected").data("id"),n,s,a,o,r;n=d("sidebars_widgets["+e+"]"),s=d("sidebars_widgets["+t+"]"),a=Array.prototype.slice.call(n()),o=Array.prototype.slice.call(s()),r=i.getWidgetSidebarPosition(),a.splice(r,1),o.push(i.params.widget_id),n(a),s(o),i.focus()})},_setupHighlightEffects:function(){var e=this;this.container.on("mouseenter click",function(){e.setting.previewer.send("highlight-widget",e.params.widget_id)}),this.setting.bind(function(){e.setting.previewer.send("highlight-widget",e.params.widget_id)})},_setupUpdateUI:function(){var e=this,i,n,s,o,r;n=(i=this.container.find(".widget:first")).find(".widget-content:first"),(s=this.container.find(".widget-control-save")).val(a.saveBtnLabel),s.attr("title",a.saveBtnTooltip),s.removeClass("button-primary"),s.on("click",function(t){t.preventDefault(),e.updateWidget({disable_form:!0})}),o=_.debounce(function(){e.updateWidget()},250),n.on("keydown","input",function(t){13===t.which&&(t.preventDefault(),e.updateWidget({ignoreActiveElement:!0}))}),n.on("change input propertychange",":input",function(t){e.liveUpdateMode&&("change"===t.type||this.checkValidity&&this.checkValidity())&&o()}),this.setting.previewer.channel.bind("synced",function(){e.container.removeClass("previewer-loading")}),d.previewer.bind("widget-updated",function(t){t===e.params.widget_id&&e.container.removeClass("previewer-loading")}),(r=d.Widgets.formSyncHandlers[this.params.widget_id_base])&&t(document).on("widget-synced",function(e,t){i.is(t)&&r.apply(document,arguments)})},onChangeActive:function(e,t){this.container.toggleClass("widget-rendered",e),t.completeCallback&&t.completeCallback()},_setupRemoveUI:function(){var e=this,t,i;(t=this.container.find(".widget-control-remove")).on("click",function(t){var i;t.preventDefault(),i=e.container.next().is(".customize-control-widget_form")?e.container.next().find(".widget-action:first"):e.container.prev().is(".customize-control-widget_form")?e.container.prev().find(".widget-action:first"):e.container.next(".customize-control-sidebar_widgets").find(".add-new-widget:first"),e.container.slideUp(function(){var t=d.Widgets.getSidebarWidgetControlContainingWidget(e.params.widget_id),n,s;t&&(n=t.setting().slice(),-1!==(s=_.indexOf(n,e.params.widget_id))&&(n.splice(s,1),t.setting(n),i.focus()))})}),i=function(){t.text(a.removeBtnLabel),t.attr("title",a.removeBtnTooltip)},this.params.is_new?d.bind("saved",i):i()},_getInputs:function(e){return t(e).find(":input[name]")},_getInputsSignature:function(e){var i;return _(e).map(function(e){var i=t(e),n;return(n=i.is(":checkbox, :radio")?[i.attr("id"),i.attr("name"),i.prop("value")]:[i.attr("id"),i.attr("name")]).join(",")}).join(";")},_getInputState:function(e){return(e=t(e)).is(":radio, :checkbox")?e.prop("checked"):e.is("select[multiple]")?e.find("option:selected").map(function(){return t(this).val()}).get():e.val()},_setInputState:function(e,i){(e=t(e)).is(":radio, :checkbox")?e.prop("checked",i):e.is("select[multiple]")?(i=t.isArray(i)?_.map(i,function(e){return String(e)}):[],e.find("option").each(function(){t(this).prop("selected",-1!==_.indexOf(i,String(this.value)))})):e.val(i)},getSidebarWidgetsControl:function(){var e,t;if(e="sidebars_widgets["+this.params.sidebar_id+"]",t=d.control(e))return t},updateWidget:function(i){var n=this,s,o,r,c,l,g,u,h,p,f,m;n.embedWidgetContent(),s=(i=t.extend({instance:null,complete:null,ignoreActiveElement:!1},i)).instance,o=i.complete,this._updateCount+=1,l=this._updateCount,r=this.container.find(".widget:first"),(c=r.find(".widget-content:first")).find(".widget-error").remove(),this.container.addClass("widget-form-loading"),this.container.addClass("previewer-loading"),(p=d.state("processing"))(p()+1),this.liveUpdateMode||this.container.addClass("widget-form-disabled"),(g={}).action="update-widget",g.wp_customize="on",g.nonce=d.settings.nonce["update-widget"],g.customize_theme=d.settings.theme.stylesheet,g.customized=e.customize.previewer.query().customized,u=t.param(g),(h=this._getInputs(c)).each(function(){t(this).data("state"+l,n._getInputState(this))}),u+=s?"&"+t.param({sanitized_widget_setting:JSON.stringify(s)}):"&"+h.serialize(),u+="&"+c.find("~ :input").serialize(),this._previousUpdateRequest&&this._previousUpdateRequest.abort(),f=t.post(e.ajax.settings.url,u),this._previousUpdateRequest=f,f.done(function(e){var s,g,u,p,f=!1;if("0"===e)return d.previewer.preview.iframe.hide(),void d.previewer.login().done(function(){n.updateWidget(i),d.previewer.preview.iframe.show()});"-1"!==e?e.success?(g=t("<div>"+e.data.form+"</div>"),u=n._getInputs(g),(p=n._getInputsSignature(h)===n._getInputsSignature(u))&&!n.liveUpdateMode&&(n.liveUpdateMode=!0,n.container.removeClass("widget-form-disabled"),n.container.find('input[name="savewidget"]').hide()),p&&n.liveUpdateMode?(h.each(function(e){var s=t(this),d=t(u[e]),a,o,r;a=s.data("state"+l),o=n._getInputState(d),s.data("sanitized",o),(r=!_.isEqual(a,o)&&(i.ignoreActiveElement||!s.is(document.activeElement)))&&n._setInputState(s,o)}),t(document).trigger("widget-synced",[r,e.data.form])):n.liveUpdateMode?(n.liveUpdateMode=!1,n.container.find('input[name="savewidget"]').show(),f=!0):(c.html(e.data.form),n.container.removeClass("widget-form-disabled"),t(document).trigger("widget-updated",[r])),(m=!f&&!_(n.setting()).isEqual(e.data.instance))?(n.isWidgetUpdating=!0,n.setting(e.data.instance),n.isWidgetUpdating=!1):n.container.removeClass("previewer-loading"),o&&o.call(n,null,{noChange:!m,ajaxFinished:!0})):(s=a.error,e.data&&e.data.message&&(s=e.data.message),o?o.call(n,s):c.prepend('<p class="widget-error"><strong>'+s+"</strong></p>")):d.previewer.cheatin()}),f.fail(function(e,t){o&&o.call(n,t)}),f.always(function(){n.container.removeClass("widget-form-loading"),h.each(function(){t(this).removeData("state"+l)}),p(p()-1)})},expandControlSection:function(){d.Control.prototype.expand.call(this)},_toggleExpanded:d.Section.prototype._toggleExpanded,expand:d.Section.prototype.expand,expandForm:function(){this.expand()},collapse:d.Section.prototype.collapse,collapseForm:function(){this.collapse()},toggleForm:function(e){void 0===e&&(e=!this.expanded()),this.expanded(e)},onChangeExpanded:function(e,t){var i=this,n,s,a,o,r,c;i.embedWidgetControl(),e&&i.embedWidgetContent(),t.unchanged?e&&d.Control.prototype.expand.call(i,{completeCallback:t.completeCallback}):(n=this.container.find("div.widget:first"),s=n.find(".widget-inside:first"),c=this.container.find(".widget-top button.widget-action"),r=function(){d.control.each(function(e){i.params.type===e.params.type&&i!==e&&e.collapse()}),a=function(){i.container.removeClass("expanding"),i.container.addClass("expanded"),n.addClass("open"),c.attr("aria-expanded","true"),i.container.trigger("expanded")},t.completeCallback&&(o=a,a=function(){o(),t.completeCallback()}),i.params.is_wide?s.fadeIn(t.duration,a):s.slideDown(t.duration,a),i.container.trigger("expand"),i.container.addClass("expanding")},e?d.section.has(i.section())?d.section(i.section()).expand({completeCallback:r}):r():(a=function(){i.container.removeClass("collapsing"),i.container.removeClass("expanded"),n.removeClass("open"),c.attr("aria-expanded","false"),i.container.trigger("collapsed")},t.completeCallback&&(o=a,a=function(){o(),t.completeCallback()}),i.container.trigger("collapse"),i.container.addClass("collapsing"),i.params.is_wide?s.fadeOut(t.duration,a):s.slideUp(t.duration,function(){n.css({width:"",margin:""}),a()})))},getWidgetSidebarPosition:function(){var e,t;if(e=this.getSidebarWidgetsControl().setting(),-1!==(t=_.indexOf(e,this.params.widget_id)))return t},moveUp:function(){this._moveWidgetByOne(-1)},moveDown:function(){this._moveWidgetByOne(1)},_moveWidgetByOne:function(e){var t,i,n,s;t=this.getWidgetSidebarPosition(),i=this.getSidebarWidgetsControl().setting,s=(n=Array.prototype.slice.call(i()))[t+e],n[t+e]=this.params.widget_id,n[t]=s,i(n)},toggleWidgetMoveArea:function(e){var i=this,n;n=this.container.find(".move-widget-area"),void 0===e&&(e=!n.hasClass("active")),e&&(n.find(".selected").removeClass("selected"),n.find("li").filter(function(){return t(this).data("id")===i.params.sidebar_id}).addClass("selected"),this.container.find(".move-widget-btn").prop("disabled",!0)),n.toggleClass("active",e)},highlightSectionAndControl:function(){var e;e=this.container.is(":hidden")?this.container.closest(".control-section"):this.container,t(".highlighted").removeClass("highlighted"),e.addClass("highlighted"),setTimeout(function(){e.removeClass("highlighted")},500)}}),d.Widgets.WidgetsPanel=d.Panel.extend({ready:function(){var e=this;d.Panel.prototype.ready.call(e),e.deferred.embedded.done(function(){var i,n,s,o,r;i=e.container.find(".panel-meta"),n=t("<div></div>",{class:"no-widget-areas-rendered-notice"}),i.append(n),o=function(){return _.filter(e.sections(),function(e){return e.active()}).length},r=function(){var e=o();return 0===e||e!==d.Widgets.data.registeredSidebars.length},(s=function(){var e=o(),i,s,r;n.empty(),e!==(r=d.Widgets.data.registeredSidebars.length)&&(0!==e?(s=r-e,i=a.someAreasShown[s]):i=a.noAreasShown,i&&n.append(t("<p></p>",{text:i})),n.append(t("<p></p>",{text:a.navigatePreview})))})(),n.toggle(r()),d.previewer.deferred.active.done(function(){n.toggle(r())}),d.bind("pane-contents-reflowed",function(){var e="resolved"===d.previewer.deferred.active.state()?"fast":0;s(),r()?n.slideDown(e):n.slideUp(e)})})},isContextuallyActive:function(){var e=this;return this.active()}}),d.Widgets.SidebarSection=d.Section.extend({ready:function(){var e=this,t;d.Section.prototype.ready.call(this),t=d.Widgets.registeredSidebars.get(this.params.sidebarId),this.active.bind(function(e){t.set("is_rendered",e)}),t.set("is_rendered",this.active())}}),d.Widgets.SidebarControl=d.Control.extend({ready:function(){this.$controlSection=this.container.closest(".control-section"),this.$sectionContent=this.container.closest(".accordion-section-content"),this._setupModel(),this._setupSortable(),this._setupAddition(),this._applyCardinalOrderClassNames()},_setupModel:function(){var e=this;this.setting.bind(function(i,s){var a,o,r;o=_(s).difference(i),i=_(i).filter(function(e){var t=n(e);return!!d.Widgets.availableWidgets.findWhere({id_base:t.id_base})}),(a=_(i).map(function(t){var i=d.Widgets.getWidgetFormControlForWidget(t);return i||(i=e.addWidget(t)),i})).sort(function(e,t){var n,s;return _.indexOf(i,e.params.widget_id)-_.indexOf(i,t.params.widget_id)}),r=0,_(a).each(function(t){t.priority(r),t.section(e.section()),r+=1}),e.priority(r),e._applyCardinalOrderClassNames(),_(a).each(function(t){t.params.sidebar_id=e.params.sidebar_id}),_(o).each(function(i){setTimeout(function(){var s,a,o,r,c,l=!1;d.each(function(t){if(t.id!==e.setting.id&&0===t.id.indexOf("sidebars_widgets[")&&"sidebars_widgets[wp_inactive_widgets]"!==t.id){var n=t(),s;-1!==(s=_.indexOf(n,i))&&(l=!0)}}),l||(a=(s=d.Widgets.getWidgetFormControlForWidget(i))&&t.contains(document,s.container[0])&&!t.contains(e.$sectionContent[0],s.container[0]),s&&!a&&(d.control.remove(s.id),s.container.remove()),d.Widgets.savedWidgetIds[i]&&((o=d.value("sidebars_widgets[wp_inactive_widgets]")().slice()).push(i),d.value("sidebars_widgets[wp_inactive_widgets]")(_(o).unique())),r=n(i).id_base,(c=d.Widgets.availableWidgets.findWhere({id_base:r}))&&!c.get("is_multi")&&c.set("is_disabled",!1))})})})},_setupSortable:function(){var e=this;this.isReordering=!1,this.$sectionContent.sortable({items:"> .customize-control-widget_form",handle:".widget-top",axis:"y",tolerance:"pointer",connectWith:".accordion-section-content:has(.customize-control-sidebar_widgets)",update:function(){var i=e.$sectionContent.sortable("toArray"),n;n=t.map(i,function(e){return t("#"+e).find(":input[name=widget-id]").val()}),e.setting(n)}}),this.$controlSection.find(".accordion-section-title").droppable({accept:".customize-control-widget_form",over:function(){var t;d.section(e.section.get()).expand({allowMultiple:!0,completeCallback:function(){d.section.each(function(e){e.container.find(".customize-control-sidebar_widgets").length&&e.container.find(".accordion-section-content:first").sortable("refreshPositions")})}})}}),this.container.find(".reorder-toggle").on("click",function(){e.toggleReordering(!e.isReordering)})},_setupAddition:function(){var e=this;this.container.find(".add-new-widget").on("click",function(){var i=t(this);e.$sectionContent.hasClass("reordering")||(t("body").hasClass("adding-widget")?(i.attr("aria-expanded","false"),d.Widgets.availableWidgetsPanel.close()):(i.attr("aria-expanded","true"),d.Widgets.availableWidgetsPanel.open(e)))})},_applyCardinalOrderClassNames:function(){var e=[];_.each(this.setting(),function(t){var i=d.Widgets.getWidgetFormControlForWidget(t);i&&e.push(i)}),0===e.length||1===d.Widgets.registeredSidebars.length&&e.length<=1?this.container.find(".reorder-toggle").hide():(this.container.find(".reorder-toggle").show(),t(e).each(function(){t(this.container).removeClass("first-widget").removeClass("last-widget").find(".move-widget-down, .move-widget-up").prop("tabIndex",0)}),_.first(e).container.addClass("first-widget").find(".move-widget-up").prop("tabIndex",-1),_.last(e).container.addClass("last-widget").find(".move-widget-down").prop("tabIndex",-1))},toggleReordering:function(t){var i=this.$sectionContent.find(".add-new-widget"),n=this.container.find(".reorder-toggle"),s=this.$sectionContent.find(".widget-title");(t=Boolean(t))!==this.$sectionContent.hasClass("reordering")&&(this.isReordering=t,this.$sectionContent.toggleClass("reordering",t),t?(_(this.getWidgetFormControls()).each(function(e){e.collapse()}),i.attr({tabindex:"-1","aria-hidden":"true"}),n.attr("aria-label",a.reorderLabelOff),e.a11y.speak(a.reorderModeOn),s.attr("aria-hidden","true")):(i.removeAttr("tabindex aria-hidden"),n.attr("aria-label",a.reorderLabelOn),e.a11y.speak(a.reorderModeOff),s.attr("aria-hidden","false")))},getWidgetFormControls:function(){var e=[];return _(this.setting()).each(function(t){var i=s(t),n=d.control(i);n&&e.push(n)}),e},addWidget:function(e){var i=this,s,a,o="widget_form",r,c,l=n(e),g=l.number,u=l.id_base,h=d.Widgets.availableWidgets.findWhere({id_base:u}),p,f,m,v,w,b;return!!h&&(!(g&&!h.get("is_multi"))&&(h.get("is_multi")&&!g&&(h.set("multi_number",h.get("multi_number")+1),g=h.get("multi_number")),s=t.trim(t("#widget-tpl-"+h.get("id")).html()),h.get("is_multi")?s=s.replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,g)}):h.set("is_disabled",!0),a=t(s),(r=t("<li/>").addClass("customize-control").addClass("customize-control-widget_form").append(a)).find("> .widget-icon").remove(),h.get("is_multi")&&(r.find('input[name="widget_number"]').val(g),r.find('input[name="multi_number"]').val(g)),e=r.find('[name="widget-id"]').val(),r.hide(),p="widget_"+h.get("id_base"),h.get("is_multi")&&(p+="["+g+"]"),r.attr("id","customize-control-"+p.replace(/\]/g,"").replace(/\[/g,"-")),(f=d.has(p))||(w={transport:d.Widgets.data.selectiveRefreshableWidgets[h.get("id_base")]?"postMessage":"refresh",previewer:this.setting.previewer},(b=d.create(p,p,"",w)).set({})),c=d.controlConstructor.widget_form,m=new c(p,{settings:{default:p},content:r,sidebar_id:i.params.sidebar_id,widget_id:e,widget_id_base:h.get("id_base"),type:o,is_new:!f,width:h.get("width"),height:h.get("height"),is_wide:h.get("is_wide")}),d.control.add(m),d.each(function(t){if(t.id!==i.setting.id&&0===t.id.indexOf("sidebars_widgets[")){var n=t().slice(),s=_.indexOf(n,e);-1!==s&&(n.splice(s),t(n))}}),v=this.setting().slice(),-1===_.indexOf(v,e)&&(v.push(e),this.setting(v)),r.slideDown(function(){f&&m.updateWidget({instance:m.setting()})}),m))}}),t.extend(d.panelConstructor,{widgets:d.Widgets.WidgetsPanel}),t.extend(d.sectionConstructor,{sidebar:d.Widgets.SidebarSection}),t.extend(d.controlConstructor,{widget_form:d.Widgets.WidgetControl,sidebar_widgets:d.Widgets.SidebarControl}),d.bind("ready",function(){d.Widgets.availableWidgetsPanel=new d.Widgets.AvailableWidgetsPanelView({collection:d.Widgets.availableWidgets}),d.previewer.bind("highlight-widget-control",d.Widgets.highlightWidgetFormControl),d.previewer.bind("focus-widget-control",d.Widgets.focusWidgetFormControl)}),d.Widgets.highlightWidgetFormControl=function(e){var t=d.Widgets.getWidgetFormControlForWidget(e);t&&t.highlightSectionAndControl()},d.Widgets.focusWidgetFormControl=function(e){var t=d.Widgets.getWidgetFormControlForWidget(e);t&&t.focus()},d.Widgets.getSidebarWidgetControlContainingWidget=function(e){var t=null;return d.control.each(function(i){"sidebar_widgets"===i.params.type&&-1!==_.indexOf(i.setting(),e)&&(t=i)}),t},d.Widgets.getWidgetFormControlForWidget=function(e){var t=null;return d.control.each(function(i){"widget_form"===i.params.type&&i.params.widget_id===e&&(t=i)}),t},t(document).on("widget-added",function(e,t){var s,a,o,r;"nav_menu"===(s=n(t.find("> .widget-inside > .form > .widget-id").val())).id_base&&(a=d.control("widget_nav_menu["+String(s.number)+"]"))&&(o=t.find('select[name*="nav_menu"]'),r=t.find(".edit-selected-nav-menu > button"),0!==o.length&&0!==r.length&&(o.on("change",function(){d.section.has("nav_menu["+o.val()+"]")?r.parent().show():r.parent().hide()}),r.on("click",function(){var e=d.section("nav_menu["+o.val()+"]");e&&i(e,a)})))})}}(window.wp,jQuery);