!function(e,$){function t(e,t){function i(n){n||(e.expanded.unbind(i),t.focus())}e.focus(),e.expanded.bind(i)}function i(e){var t,i={number:null,id_base:null};return t=e.match(/^(.+)-(\d+)$/),t?(i.id_base=t[1],i.number=parseInt(t[2],10)):i.id_base=e,i}function n(e){var t=i(e),n;return n="widget_"+t.id_base,t.number&&(n+="["+t.number+"]"),n}if(e&&e.customize){var s=e.customize,d;s.Widgets=s.Widgets||{},s.Widgets.savedWidgetIds={},s.Widgets.data=_wpCustomizeWidgetsSettings||{},d=s.Widgets.data.l10n,s.Widgets.WidgetModel=Backbone.Model.extend({id:null,temp_id:null,classname:null,control_tpl:null,description:null,is_disabled:null,is_multi:null,multi_number:null,name:null,id_base:null,transport:null,params:[],width:null,height:null,search_matched:!0}),s.Widgets.WidgetCollection=Backbone.Collection.extend({model:s.Widgets.WidgetModel,doSearch:function(e){this.terms!==e&&(this.terms=e,this.terms.length>0&&this.search(this.terms),""===this.terms&&this.each(function(e){e.set("search_matched",!0)}))},search:function(e){var t,i;e=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),e=e.replace(/ /g,")(?=.*"),t=new RegExp("^(?=.*"+e+").+","i"),this.each(function(e){i=[e.get("name"),e.get("id"),e.get("description")].join(" "),e.set("search_matched",t.test(i))})}}),s.Widgets.availableWidgets=new s.Widgets.WidgetCollection(s.Widgets.data.availableWidgets),s.Widgets.SidebarModel=Backbone.Model.extend({after_title:null,after_widget:null,before_title:null,before_widget:null,class:null,description:null,id:null,name:null,is_rendered:!1}),s.Widgets.SidebarCollection=Backbone.Collection.extend({model:s.Widgets.SidebarModel}),s.Widgets.registeredSidebars=new s.Widgets.SidebarCollection(s.Widgets.data.registeredSidebars),s.Widgets.AvailableWidgetsPanelView=e.Backbone.View.extend({el:"#available-widgets",events:{"input #widgets-search":"search","keyup #widgets-search":"search","focus .widget-tpl":"focus","click .widget-tpl":"_submit","keypress .widget-tpl":"_submit",keydown:"keyboardAccessible"},selected:null,currentSidebarControl:null,$search:null,$clearResults:null,searchMatchesCount:null,initialize:function(){var e=this;this.$search=$("#widgets-search"),this.$clearResults=this.$el.find(".clear-results"),_.bindAll(this,"close"),this.listenTo(this.collection,"change",this.updateList),this.updateList(),this.searchMatchesCount=this.collection.length,$("#customize-controls, #available-widgets .customize-section-title").on("click keydown",function(t){var i=$(t.target).is(".add-new-widget, .add-new-widget *");$("body").hasClass("adding-widget")&&!i&&e.close()}),this.$clearResults.on("click",function(){e.$search.val("").focus().trigger("keyup")}),s.previewer.bind("url",this.close)},search:function(e){var t;this.collection.doSearch(e.target.value),this.updateSearchMatchesCount(),this.announceSearchMatches(),this.selected&&!this.selected.is(":visible")&&(this.selected.removeClass("selected"),this.selected=null),this.selected&&!e.target.value&&(this.selected.removeClass("selected"),this.selected=null),!this.selected&&e.target.value&&(t=this.$el.find("> .widget-tpl:visible:first"),t.length&&this.select(t)),""!==e.target.value?this.$clearResults.addClass("is-visible"):""===e.target.value&&this.$clearResults.removeClass("is-visible"),this.searchMatchesCount?this.$el.removeClass("no-widgets-found"):this.$el.addClass("no-widgets-found")},updateSearchMatchesCount:function(){this.searchMatchesCount=this.collection.where({search_matched:!0}).length},announceSearchMatches:_.debounce(function(){var t=d.widgetsFound.replace("%d",this.searchMatchesCount);this.searchMatchesCount||(t=d.noWidgetsFound),e.a11y.speak(t)},500),updateList:function(){this.collection.each(function(e){var t=$("#widget-tpl-"+e.id);t.toggle(e.get("search_matched")&&!e.get("is_disabled")),e.get("is_disabled")&&t.is(this.selected)&&(this.selected=null)})},select:function(e){this.selected=$(e),this.selected.siblings(".widget-tpl").removeClass("selected"),this.selected.addClass("selected")},focus:function(e){this.select($(e.currentTarget))},_submit:function(e){"keypress"===e.type&&13!==e.which&&32!==e.which||this.submit($(e.currentTarget))},submit:function(e){var t,i,n;e||(e=this.selected),e&&this.currentSidebarControl&&(this.select(e),t=$(this.selected).data("widget-id"),(i=this.collection.findWhere({id:t}))&&(n=this.currentSidebarControl.addWidget(i.get("id_base")),n&&n.focus(),this.close()))},open:function(e){this.currentSidebarControl=e,_(this.currentSidebarControl.getWidgetFormControls()).each(function(e){e.params.is_wide&&e.collapseForm()}),s.section.has("publish_settings")&&s.section("publish_settings").collapse(),$("body").addClass("adding-widget"),this.$el.find(".selected").removeClass("selected"),this.collection.doSearch(""),s.settings.browser.mobile||this.$search.focus()},close:function(e){e=e||{},e.returnFocus&&this.currentSidebarControl&&this.currentSidebarControl.container.find(".add-new-widget").focus(),this.currentSidebarControl=null,this.selected=null,$("body").removeClass("adding-widget"),this.$search.val("")},keyboardAccessible:function(e){var t=13===e.which,i=27===e.which,n=40===e.which,s=38===e.which,d=9===e.which,a=e.shiftKey,o=null,r=this.$el.find("> .widget-tpl:visible:first"),c=this.$el.find("> .widget-tpl:visible:last"),l=$(e.target).is(this.$search),g=$(e.target).is(".widget-tpl:visible:last");if(n||s)return n?l?o=r:this.selected&&0!==this.selected.nextAll(".widget-tpl:visible").length&&(o=this.selected.nextAll(".widget-tpl:visible:first")):s&&(l?o=c:this.selected&&0!==this.selected.prevAll(".widget-tpl:visible").length&&(o=this.selected.prevAll(".widget-tpl:visible:first"))),this.select(o),void(o?o.focus():this.$search.focus());t&&!this.$search.val()||(t?this.submit():i&&this.close({returnFocus:!0}),this.currentSidebarControl&&d&&(a&&l||!a&&g)&&(this.currentSidebarControl.container.find(".add-new-widget").focus(),e.preventDefault()))}}),s.Widgets.formSyncHandlers={rss:function(e,t,i){var n=t.find(".widget-error:first"),s=$("<div>"+i+"</div>").find(".widget-error:first");n.length&&s.length?n.replaceWith(s):n.length?n.remove():s.length&&t.find(".widget-content:first").prepend(s)}},s.Widgets.WidgetControl=s.Control.extend({defaultExpandedArguments:{duration:"fast",completeCallback:$.noop},initialize:function(e,t){var i=this;i.widgetControlEmbedded=!1,i.widgetContentEmbedded=!1,i.expanded=new s.Value(!1),i.expandedArgumentsQueue=[],i.expanded.bind(function(e){var t=i.expandedArgumentsQueue.shift();t=$.extend({},i.defaultExpandedArguments,t),i.onChangeExpanded(e,t)}),i.altNotice=!0,s.Control.prototype.initialize.call(i,e,t)},ready:function(){var e=this;e.section()?s.section(e.section(),function(t){var i=function(n){n&&(e.embedWidgetControl(),t.expanded.unbind(i))};t.expanded()?i(!0):t.expanded.bind(i)}):e.embedWidgetControl()},embedWidgetControl:function(){var e=this,t;e.widgetControlEmbedded||(e.widgetControlEmbedded=!0,t=$(e.params.widget_control),e.container.append(t),e._setupModel(),e._setupWideWidget(),e._setupControlToggle(),e._setupWidgetTitle(),e._setupReorderUI(),e._setupHighlightEffects(),e._setupUpdateUI(),e._setupRemoveUI())},embedWidgetContent:function(){var e=this,t;e.embedWidgetControl(),e.widgetContentEmbedded||(e.widgetContentEmbedded=!0,e.notifications.container=e.getNotificationsContainerElement(),e.notifications.render(),t=$(e.params.widget_content),e.container.find(".widget-content:first").append(t),$(document).trigger("widget-added",[e.container.find(".widget:first")]))},_setupModel:function(){var e=this,t;t=function(){s.Widgets.savedWidgetIds[e.params.widget_id]=!0},s.bind("ready",t),s.bind("saved",t),this._updateCount=0,this.isWidgetUpdating=!1,this.liveUpdateMode=!0,this.setting.bind(function(t,i){_(i).isEqual(t)||e.isWidgetUpdating||e.updateWidget({instance:t})})},_setupWideWidget:function(){var e=this,t,i,n,d,a;!this.params.is_wide||$(window).width()<=640||(t=this.container.find(".widget-inside"),i=t.find("> .form"),n=$(".wp-full-overlay-sidebar-content:first"),this.container.addClass("wide-widget-control"),this.container.find(".form:first").css({"max-width":this.params.width,"min-height":this.params.height}),a=function(){var n=e.container.offset().top,s=$(window).height(),d=i.outerHeight(),a;t.css("max-height",s),a=Math.max(0,Math.min(Math.max(n,0),s-d)),t.css("top",a)},d=$("#customize-theme-controls"),this.container.on("expand",function(){a(),n.on("scroll",a),$(window).on("resize",a),d.on("expanded collapsed",a)}),this.container.on("collapsed",function(){n.off("scroll",a),$(window).off("resize",a),d.off("expanded collapsed",a)}),s.each(function(t){0===t.id.indexOf("sidebars_widgets[")&&t.bind(function(){e.container.hasClass("expanded")&&a()})}))},_setupControlToggle:function(){var e=this,t;this.container.find(".widget-top").on("click",function(t){t.preventDefault(),e.getSidebarWidgetsControl().isReordering||e.expanded(!e.expanded())}),t=this.container.find(".widget-control-close"),t.on("click",function(t){t.preventDefault(),e.collapse(),e.container.find(".widget-top .widget-action:first").focus()})},_setupWidgetTitle:function(){var e=this,t;t=function(){var t=e.setting().title,i=e.container.find(".in-widget-title");t?i.text(": "+t):i.text("")},this.setting.bind(t),t()},_setupReorderUI:function(){var t=this,i,n,a,o,r;i=function(e){e.siblings(".selected").removeClass("selected"),e.addClass("selected");var i=e.data("id")===t.params.sidebar_id;t.container.find(".move-widget-btn").prop("disabled",i)},this.container.find(".widget-title-action").after($(s.Widgets.data.tpl.widgetReorderNav)),r=_.template(s.Widgets.data.tpl.moveWidgetArea),n=$(r({sidebars:_(s.Widgets.registeredSidebars.toArray()).pluck("attributes")})),this.container.find(".widget-top").after(n),o=function(){var e=n.find("li"),d,a=0;d=e.filter(function(){return $(this).data("id")===t.params.sidebar_id}),e.each(function(){var e=$(this),t,n,o;t=e.data("id"),n=s.Widgets.registeredSidebars.get(t),o=n.get("is_rendered"),e.toggle(o),o&&(a+=1),e.hasClass("selected")&&!o&&i(d)}),a>1?t.container.find(".move-widget").show():t.container.find(".move-widget").hide()},o(),s.Widgets.registeredSidebars.on("change:is_rendered",o),a=this.container.find(".widget-reorder-nav"),a.find(".move-widget, .move-widget-down, .move-widget-up").each(function(){$(this).prepend(t.container.find(".widget-title").text()+": ")}).on("click keypress",function(i){if("keypress"!==i.type||13===i.which||32===i.which)if($(this).focus(),$(this).is(".move-widget"))t.toggleWidgetMoveArea();else{var n=$(this).is(".move-widget-down"),s=$(this).is(".move-widget-up"),a=t.getWidgetSidebarPosition();if(s&&0===a||n&&a===t.getSidebarWidgetsControl().setting().length-1)return;s?(t.moveUp(),e.a11y.speak(d.widgetMovedUp)):(t.moveDown(),e.a11y.speak(d.widgetMovedDown)),$(this).focus()}}),this.container.find(".widget-area-select").on("click keypress","li",function(e){"keypress"===e.type&&13!==e.which&&32!==e.which||(e.preventDefault(),i($(this)))}),this.container.find(".move-widget-btn").click(function(){t.getSidebarWidgetsControl().toggleReordering(!1);var e=t.params.sidebar_id,i=t.container.find(".widget-area-select li.selected").data("id"),n,d,a,o,r;n=s("sidebars_widgets["+e+"]"),d=s("sidebars_widgets["+i+"]"),a=Array.prototype.slice.call(n()),o=Array.prototype.slice.call(d()),r=t.getWidgetSidebarPosition(),a.splice(r,1),o.push(t.params.widget_id),n(a),d(o),t.focus()})},_setupHighlightEffects:function(){var e=this;this.container.on("mouseenter click",function(){e.setting.previewer.send("highlight-widget",e.params.widget_id)}),this.setting.bind(function(){e.setting.previewer.send("highlight-widget",e.params.widget_id)})},_setupUpdateUI:function(){var e=this,t,i,n,a,o;t=this.container.find(".widget:first"),i=t.find(".widget-content:first"),n=this.container.find(".widget-control-save"),n.val(d.saveBtnLabel),n.attr("title",d.saveBtnTooltip),n.removeClass("button-primary"),n.on("click",function(t){t.preventDefault(),e.updateWidget({disable_form:!0})}),a=_.debounce(function(){e.updateWidget()},250),i.on("keydown","input",function(t){13===t.which&&(t.preventDefault(),e.updateWidget({ignoreActiveElement:!0}))}),i.on("change input propertychange",":input",function(t){e.liveUpdateMode&&("change"===t.type||this.checkValidity&&this.checkValidity())&&a()}),this.setting.previewer.channel.bind("synced",function(){e.container.removeClass("previewer-loading")}),s.previewer.bind("widget-updated",function(t){t===e.params.widget_id&&e.container.removeClass("previewer-loading")}),(o=s.Widgets.formSyncHandlers[this.params.widget_id_base])&&$(document).on("widget-synced",function(e,i){t.is(i)&&o.apply(document,arguments)})},onChangeActive:function(e,t){this.container.toggleClass("widget-rendered",e),t.completeCallback&&t.completeCallback()},_setupRemoveUI:function(){var e=this,t,i;t=this.container.find(".widget-control-remove"),t.on("click",function(t){t.preventDefault();var i;i=e.container.next().is(".customize-control-widget_form")?e.container.next().find(".widget-action:first"):e.container.prev().is(".customize-control-widget_form")?e.container.prev().find(".widget-action:first"):e.container.next(".customize-control-sidebar_widgets").find(".add-new-widget:first"),e.container.slideUp(function(){var t=s.Widgets.getSidebarWidgetControlContainingWidget(e.params.widget_id),n,d;t&&(n=t.setting().slice(),-1!==(d=_.indexOf(n,e.params.widget_id))&&(n.splice(d,1),t.setting(n),i.focus()))})}),i=function(){t.text(d.removeBtnLabel),t.attr("title",d.removeBtnTooltip)},this.params.is_new?s.bind("saved",i):i()},_getInputs:function(e){return $(e).find(":input[name]")},_getInputsSignature:function(e){return _(e).map(function(e){var t=$(e),i;return i=t.is(":checkbox, :radio")?[t.attr("id"),t.attr("name"),t.prop("value")]:[t.attr("id"),t.attr("name")],i.join(",")}).join(";")},_getInputState:function(e){return e=$(e),e.is(":radio, :checkbox")?e.prop("checked"):e.is("select[multiple]")?e.find("option:selected").map(function(){return $(this).val()}).get():e.val()},_setInputState:function(e,t){e=$(e),e.is(":radio, :checkbox")?e.prop("checked",t):e.is("select[multiple]")?(t=$.isArray(t)?_.map(t,function(e){return String(e)}):[],e.find("option").each(function(){$(this).prop("selected",-1!==_.indexOf(t,String(this.value)))})):e.val(t)},getSidebarWidgetsControl:function(){var e,t;if(e="sidebars_widgets["+this.params.sidebar_id+"]",t=s.control(e))return t},updateWidget:function(t){var i=this,n,a,o,r,c,l,g,u,h,p,f;i.embedWidgetContent(),t=$.extend({instance:null,complete:null,ignoreActiveElement:!1},t),n=t.instance,a=t.complete,this._updateCount+=1,c=this._updateCount,o=this.container.find(".widget:first"),r=o.find(".widget-content:first"),r.find(".widget-error").remove(),this.container.addClass("widget-form-loading"),this.container.addClass("previewer-loading"),h=s.state("processing"),h(h()+1),this.liveUpdateMode||this.container.addClass("widget-form-disabled"),l={},l.action="update-widget",l.wp_customize="on",l.nonce=s.settings.nonce["update-widget"],l.customize_theme=s.settings.theme.stylesheet,l.customized=e.customize.previewer.query().customized,g=$.param(l),u=this._getInputs(r),u.each(function(){$(this).data("state"+c,i._getInputState(this))}),g+=n?"&"+$.param({sanitized_widget_setting:JSON.stringify(n)}):"&"+u.serialize(),g+="&"+r.find("~ :input").serialize(),this._previousUpdateRequest&&this._previousUpdateRequest.abort(),p=$.post(e.ajax.settings.url,g),this._previousUpdateRequest=p,p.done(function(e){var n,l,g,h,p=!1;return"0"===e?(s.previewer.preview.iframe.hide(),void s.previewer.login().done(function(){i.updateWidget(t),s.previewer.preview.iframe.show()})):"-1"===e?void s.previewer.cheatin():void(e.success?(l=$("<div>"+e.data.form+"</div>"),g=i._getInputs(l),h=i._getInputsSignature(u)===i._getInputsSignature(g),h&&!i.liveUpdateMode&&(i.liveUpdateMode=!0,i.container.removeClass("widget-form-disabled"),i.container.find('input[name="savewidget"]').hide()),h&&i.liveUpdateMode?(u.each(function(e){var n=$(this),s=$(g[e]),d,a,o;d=n.data("state"+c),a=i._getInputState(s),n.data("sanitized",a),(o=!_.isEqual(d,a)&&(t.ignoreActiveElement||!n.is(document.activeElement)))&&i._setInputState(n,a)}),$(document).trigger("widget-synced",[o,e.data.form])):i.liveUpdateMode?(i.liveUpdateMode=!1,i.container.find('input[name="savewidget"]').show(),p=!0):(r.html(e.data.form),i.container.removeClass("widget-form-disabled"),$(document).trigger("widget-updated",[o])),f=!p&&!_(i.setting()).isEqual(e.data.instance),f?(i.isWidgetUpdating=!0,i.setting(e.data.instance),i.isWidgetUpdating=!1):i.container.removeClass("previewer-loading"),a&&a.call(i,null,{noChange:!f,ajaxFinished:!0})):(n=d.error,e.data&&e.data.message&&(n=e.data.message),a?a.call(i,n):r.prepend('<p class="widget-error"><strong>'+n+"</strong></p>")))}),p.fail(function(e,t){a&&a.call(i,t)}),p.always(function(){i.container.removeClass("widget-form-loading"),u.each(function(){$(this).removeData("state"+c)}),h(h()-1)})},expandControlSection:function(){s.Control.prototype.expand.call(this)},_toggleExpanded:s.Section.prototype._toggleExpanded,expand:s.Section.prototype.expand,expandForm:function(){this.expand()},collapse:s.Section.prototype.collapse,collapseForm:function(){this.collapse()},toggleForm:function(e){void 0===e&&(e=!this.expanded()),this.expanded(e)},onChangeExpanded:function(e,t){var i=this,n,d,a,o,r,c;if(i.embedWidgetControl(),e&&i.embedWidgetContent(),t.unchanged)return void(e&&s.Control.prototype.expand.call(i,{completeCallback:t.completeCallback}));n=this.container.find("div.widget:first"),d=n.find(".widget-inside:first"),c=this.container.find(".widget-top button.widget-action"),r=function(){s.control.each(function(e){i.params.type===e.params.type&&i!==e&&e.collapse()}),a=function(){i.container.removeClass("expanding"),i.container.addClass("expanded"),n.addClass("open"),c.attr("aria-expanded","true"),i.container.trigger("expanded")},t.completeCallback&&(o=a,a=function(){o(),t.completeCallback()}),i.params.is_wide?d.fadeIn(t.duration,a):d.slideDown(t.duration,a),i.container.trigger("expand"),i.container.addClass("expanding")},e?s.section.has(i.section())?s.section(i.section()).expand({completeCallback:r}):r():(a=function(){i.container.removeClass("collapsing"),i.container.removeClass("expanded"),n.removeClass("open"),c.attr("aria-expanded","false"),i.container.trigger("collapsed")},t.completeCallback&&(o=a,a=function(){o(),t.completeCallback()}),i.container.trigger("collapse"),i.container.addClass("collapsing"),i.params.is_wide?d.fadeOut(t.duration,a):d.slideUp(t.duration,function(){n.css({width:"",margin:""}),a()}))},getWidgetSidebarPosition:function(){var e,t;if(e=this.getSidebarWidgetsControl().setting(),-1!==(t=_.indexOf(e,this.params.widget_id)))return t},moveUp:function(){this._moveWidgetByOne(-1)},moveDown:function(){this._moveWidgetByOne(1)},_moveWidgetByOne:function(e){var t,i,n,s;t=this.getWidgetSidebarPosition(),i=this.getSidebarWidgetsControl().setting,n=Array.prototype.slice.call(i()),s=n[t+e],n[t+e]=this.params.widget_id,n[t]=s,i(n)},toggleWidgetMoveArea:function(e){var t=this,i;i=this.container.find(".move-widget-area"),void 0===e&&(e=!i.hasClass("active")),e&&(i.find(".selected").removeClass("selected"),i.find("li").filter(function(){return $(this).data("id")===t.params.sidebar_id}).addClass("selected"),this.container.find(".move-widget-btn").prop("disabled",!0)),i.toggleClass("active",e)},highlightSectionAndControl:function(){var e;e=this.container.is(":hidden")?this.container.closest(".control-section"):this.container,$(".highlighted").removeClass("highlighted"),e.addClass("highlighted"),setTimeout(function(){e.removeClass("highlighted")},500)}}),s.Widgets.WidgetsPanel=s.Panel.extend({ready:function(){var e=this;s.Panel.prototype.ready.call(e),e.deferred.embedded.done(function(){var t,i,n,a,o;t=e.container.find(".panel-meta"),i=$("<div></div>",{class:"no-widget-areas-rendered-notice"}),t.append(i),a=function(){return _.filter(e.sections(),function(e){return e.active()}).length},o=function(){var e=a();return 0===e||e!==s.Widgets.data.registeredSidebars.length},n=function(){var e=a(),t,n,o;i.empty(),o=s.Widgets.data.registeredSidebars.length,e!==o&&(0!==e?(n=o-e,t=d.someAreasShown[n]):t=d.noAreasShown,t&&i.append($("<p></p>",{text:t})),i.append($("<p></p>",{text:d.navigatePreview})))},n(),i.toggle(o()),s.previewer.deferred.active.done(function(){i.toggle(o())}),s.bind("pane-contents-reflowed",function(){var e="resolved"===s.previewer.deferred.active.state()?"fast":0;n(),o()?i.slideDown(e):i.slideUp(e)})})},isContextuallyActive:function(){return this.active()}}),s.Widgets.SidebarSection=s.Section.extend({ready:function(){var e=this,t;s.Section.prototype.ready.call(this),t=s.Widgets.registeredSidebars.get(e.params.sidebarId),e.active.bind(function(e){t.set("is_rendered",e)}),t.set("is_rendered",e.active())}}),s.Widgets.SidebarControl=s.Control.extend({ready:function(){this.$controlSection=this.container.closest(".control-section"),this.$sectionContent=this.container.closest(".accordion-section-content"),this._setupModel(),this._setupSortable(),this._setupAddition(),this._applyCardinalOrderClassNames()},_setupModel:function(){var e=this;this.setting.bind(function(t,n){var d,a,o;a=_(n).difference(t),t=_(t).filter(function(e){var t=i(e);return!!s.Widgets.availableWidgets.findWhere({id_base:t.id_base})}),d=_(t).map(function(t){var i=s.Widgets.getWidgetFormControlForWidget(t);return i||(i=e.addWidget(t)),i}),d.sort(function(e,i){return _.indexOf(t,e.params.widget_id)-_.indexOf(t,i.params.widget_id)}),o=0,_(d).each(function(t){t.priority(o),t.section(e.section()),o+=1}),e.priority(o),e._applyCardinalOrderClassNames(),_(d).each(function(t){t.params.sidebar_id=e.params.sidebar_id}),_(a).each(function(t){setTimeout(function(){var n,d,a,o,r,c=!1;s.each(function(i){if(i.id!==e.setting.id&&0===i.id.indexOf("sidebars_widgets[")&&"sidebars_widgets[wp_inactive_widgets]"!==i.id){var n=i(),s;s=_.indexOf(n,t),-1!==s&&(c=!0)}}),c||(n=s.Widgets.getWidgetFormControlForWidget(t),d=n&&$.contains(document,n.container[0])&&!$.contains(e.$sectionContent[0],n.container[0]),n&&!d&&(s.control.remove(n.id),n.container.remove()),s.Widgets.savedWidgetIds[t]&&(a=s.value("sidebars_widgets[wp_inactive_widgets]")().slice(),a.push(t),s.value("sidebars_widgets[wp_inactive_widgets]")(_(a).unique())),o=i(t).id_base,(r=s.Widgets.availableWidgets.findWhere({id_base:o}))&&!r.get("is_multi")&&r.set("is_disabled",!1))})})})},_setupSortable:function(){var e=this;this.isReordering=!1,this.$sectionContent.sortable({items:"> .customize-control-widget_form",handle:".widget-top",axis:"y",tolerance:"pointer",connectWith:".accordion-section-content:has(.customize-control-sidebar_widgets)",update:function(){var t=e.$sectionContent.sortable("toArray"),i;i=$.map(t,function(e){return $("#"+e).find(":input[name=widget-id]").val()}),e.setting(i)}}),this.$controlSection.find(".accordion-section-title").droppable({accept:".customize-control-widget_form",over:function(){s.section(e.section.get()).expand({allowMultiple:!0,completeCallback:function(){s.section.each(function(e){e.container.find(".customize-control-sidebar_widgets").length&&e.container.find(".accordion-section-content:first").sortable("refreshPositions")})}})}}),this.container.find(".reorder-toggle").on("click",function(){e.toggleReordering(!e.isReordering)})},_setupAddition:function(){var e=this;this.container.find(".add-new-widget").on("click",function(){var t=$(this);e.$sectionContent.hasClass("reordering")||($("body").hasClass("adding-widget")?(t.attr("aria-expanded","false"),s.Widgets.availableWidgetsPanel.close()):(t.attr("aria-expanded","true"),s.Widgets.availableWidgetsPanel.open(e)))})},_applyCardinalOrderClassNames:function(){var e=[];if(_.each(this.setting(),function(t){var i=s.Widgets.getWidgetFormControlForWidget(t);i&&e.push(i)}),0===e.length||1===s.Widgets.registeredSidebars.length&&e.length<=1)return void this.container.find(".reorder-toggle").hide();this.container.find(".reorder-toggle").show(),$(e).each(function(){$(this.container).removeClass("first-widget").removeClass("last-widget").find(".move-widget-down, .move-widget-up").prop("tabIndex",0)}),_.first(e).container.addClass("first-widget").find(".move-widget-up").prop("tabIndex",-1),_.last(e).container.addClass("last-widget").find(".move-widget-down").prop("tabIndex",-1)},toggleReordering:function(t){var i=this.$sectionContent.find(".add-new-widget"),n=this.container.find(".reorder-toggle"),s=this.$sectionContent.find(".widget-title");(t=Boolean(t))!==this.$sectionContent.hasClass("reordering")&&(this.isReordering=t,this.$sectionContent.toggleClass("reordering",t),t?(_(this.getWidgetFormControls()).each(function(e){e.collapse()}),i.attr({tabindex:"-1","aria-hidden":"true"}),n.attr("aria-label",d.reorderLabelOff),e.a11y.speak(d.reorderModeOn),s.attr("aria-hidden","true")):(i.removeAttr("tabindex aria-hidden"),n.attr("aria-label",d.reorderLabelOn),e.a11y.speak(d.reorderModeOff),s.attr("aria-hidden","false")))},getWidgetFormControls:function(){var e=[];return _(this.setting()).each(function(t){var i=n(t),d=s.control(i);d&&e.push(d)}),e},addWidget:function(e){var t=this,n,d,a="widget_form",o,r,c=i(e),l=c.number,g=c.id_base,u=s.Widgets.availableWidgets.findWhere({id_base:g}),h,p,f,m,v,w;return!!u&&(!(l&&!u.get("is_multi"))&&(u.get("is_multi")&&!l&&(u.set("multi_number",u.get("multi_number")+1),l=u.get("multi_number")),n=$.trim($("#widget-tpl-"+u.get("id")).html()),u.get("is_multi")?n=n.replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,l)}):u.set("is_disabled",!0),d=$(n),o=$("<li/>").addClass("customize-control").addClass("customize-control-widget_form").append(d),o.find("> .widget-icon").remove(),u.get("is_multi")&&(o.find('input[name="widget_number"]').val(l),o.find('input[name="multi_number"]').val(l)),e=o.find('[name="widget-id"]').val(),o.hide(),h="widget_"+u.get("id_base"),u.get("is_multi")&&(h+="["+l+"]"),o.attr("id","customize-control-"+h.replace(/\]/g,"").replace(/\[/g,"-")),p=s.has(h),p||(v={transport:s.Widgets.data.selectiveRefreshableWidgets[u.get("id_base")]?"postMessage":"refresh",previewer:this.setting.previewer},w=s.create(h,h,"",v),w.set({})),r=s.controlConstructor[a],f=new r(h,{settings:{default:h},content:o,sidebar_id:t.params.sidebar_id,widget_id:e,widget_id_base:u.get("id_base"),type:a,is_new:!p,width:u.get("width"),height:u.get("height"),is_wide:u.get("is_wide")}),s.control.add(f),s.each(function(i){if(i.id!==t.setting.id&&0===i.id.indexOf("sidebars_widgets[")){var n=i().slice(),s=_.indexOf(n,e);-1!==s&&(n.splice(s),i(n))}}),m=this.setting().slice(),-1===_.indexOf(m,e)&&(m.push(e),this.setting(m)),o.slideDown(function(){p&&f.updateWidget({instance:f.setting()})}),f))}}),$.extend(s.panelConstructor,{widgets:s.Widgets.WidgetsPanel}),$.extend(s.sectionConstructor,{sidebar:s.Widgets.SidebarSection}),$.extend(s.controlConstructor,{widget_form:s.Widgets.WidgetControl,sidebar_widgets:s.Widgets.SidebarControl}),s.bind("ready",function(){s.Widgets.availableWidgetsPanel=new s.Widgets.AvailableWidgetsPanelView({collection:s.Widgets.availableWidgets}),s.previewer.bind("highlight-widget-control",s.Widgets.highlightWidgetFormControl),s.previewer.bind("focus-widget-control",s.Widgets.focusWidgetFormControl)}),s.Widgets.highlightWidgetFormControl=function(e){var t=s.Widgets.getWidgetFormControlForWidget(e);t&&t.highlightSectionAndControl()},s.Widgets.focusWidgetFormControl=function(e){var t=s.Widgets.getWidgetFormControlForWidget(e);t&&t.focus()},s.Widgets.getSidebarWidgetControlContainingWidget=function(e){var t=null;return s.control.each(function(i){"sidebar_widgets"===i.params.type&&-1!==_.indexOf(i.setting(),e)&&(t=i)}),t},s.Widgets.getWidgetFormControlForWidget=function(e){var t=null;return s.control.each(function(i){"widget_form"===i.params.type&&i.params.widget_id===e&&(t=i)}),t},$(document).on("widget-added",function(e,n){var d,a,o,r;d=i(n.find("> .widget-inside > .form > .widget-id").val()),"nav_menu"===d.id_base&&(a=s.control("widget_nav_menu["+String(d.number)+"]"))&&(o=n.find('select[name*="nav_menu"]'),r=n.find(".edit-selected-nav-menu > button"),0!==o.length&&0!==r.length&&(o.on("change",function(){s.section.has("nav_menu["+o.val()+"]")?r.parent().show():r.parent().hide()}),r.on("click",function(){var e=s.section("nav_menu["+o.val()+"]");e&&t(e,a)})))})}}(window.wp,jQuery);