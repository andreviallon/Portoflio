!function(e,$){"use strict";var t,i;t=e.MediaWidgetModel.extend({}),i=e.MediaWidgetControl.extend({events:_.extend({},e.MediaWidgetControl.prototype.events,{"click .media-widget-preview.populated":"editMedia"}),renderPreview:function e(){var t=this,i,a,o,d,r;(t.model.get("attachment_id")||t.model.get("url"))&&(i=t.$el.find(".media-widget-preview"),a=wp.template("wp-media-widget-image-preview"),i.html(a(t.previewTemplateProps.toJSON())),i.addClass("populated"),r=t.$el.find(".link"),r.is(document.activeElement)||(o=t.$el.find(".media-widget-fields"),d=wp.template("wp-media-widget-image-fields"),o.html(d(t.previewTemplateProps.toJSON()))))},editMedia:function e(){var t=this,i,a,o,d;d=t.mapModelToMediaFrameProps(t.model.toJSON()),"none"===d.link&&(d.linkUrl=""),i=wp.media({frame:"image",state:"image-details",metadata:d}),i.$el.addClass("media-widget"),a=function(){var e,a;e=i.state().attributes.image.toJSON(),a=e.link,e.link=e.linkUrl,t.selectedAttachment.set(e),t.displaySettings.set("link",a),t.model.set(_.extend(t.mapMediaToModelProps(e),{error:!1}))},i.state("image-details").on("update",a),i.state("replace-image").on("replace",a),o=wp.media.model.Attachment.prototype.sync,wp.media.model.Attachment.prototype.sync=function e(){return $.Deferred().rejectWith(this).promise()},i.on("close",function e(){i.detach(),wp.media.model.Attachment.prototype.sync=o}),i.open()},getEmbedResetProps:function t(){return _.extend(e.MediaWidgetControl.prototype.getEmbedResetProps.call(this),{size:"full",width:0,height:0})},getModelPropsFromMediaFrame:function t(i){var a=this;return _.omit(e.MediaWidgetControl.prototype.getModelPropsFromMediaFrame.call(a,i),"image_title")},mapModelToPreviewTemplateProps:function t(){var i=this,a,o;return o=i.model.get("url"),a=e.MediaWidgetControl.prototype.mapModelToPreviewTemplateProps.call(i),a.currentFilename=o?o.replace(/\?.*$/,"").replace(/^.+\//,""):"",a.link_url=i.model.get("link_url"),a}}),e.controlConstructors.media_image=i,e.modelConstructors.media_image=t}(wp.mediaWidgets,jQuery);