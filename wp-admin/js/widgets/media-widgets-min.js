wp.mediaWidgets=function(e){"use strict";var t={controlConstructors:{},modelConstructors:{}};return t.PersistentDisplaySettingsLibrary=wp.media.controller.Library.extend({initialize:function e(t){_.bindAll(this,"handleDisplaySettingChange"),wp.media.controller.Library.prototype.initialize.call(this,t)},handleDisplaySettingChange:function e(t){this.get("selectedDisplaySettings").set(t.attributes)},display:function e(t){var i,n=this.get("selectedDisplaySettings");return(i=wp.media.controller.Library.prototype.display.call(this,t)).off("change",this.handleDisplaySettingChange),i.set(n.attributes),"custom"===n.get("link_type")&&(i.linkUrl=n.get("link_url")),i.on("change",this.handleDisplaySettingChange),i}}),t.MediaEmbedView=wp.media.view.Embed.extend({initialize:function(e){var t=this,i;wp.media.view.Embed.prototype.initialize.call(this,e),"image"!==this.controller.options.mimeType&&(i=this.controller.states.get("embed")).off("scan",i.scanImage,i)},refresh:function t(){var i;i="image"===this.controller.options.mimeType?wp.media.view.EmbedImage:wp.media.view.EmbedLink.extend({setAddToWidgetButtonDisabled:function e(t){this.views.parent.views.parent.views.get(".media-frame-toolbar")[0].$el.find(".media-button-select").prop("disabled",t)},setErrorNotice:function t(i){var n=this,d;d=this.views.parent.$el.find("> .notice:first-child"),i?(d.length||((d=e('<div class="media-widget-embed-notice notice notice-error notice-alt"></div>')).hide(),this.views.parent.$el.prepend(d)),d.empty(),d.append(e("<p>",{html:i})),d.slideDown("fast")):d.length&&d.slideUp("fast")},updateoEmbed:function(){var e=this,t;if(!(t=this.model.get("url")))return this.setErrorNotice(""),void this.setAddToWidgetButtonDisabled(!0);t.match(/^(http|https):\/\/.+\//)||(this.controller.$el.find("#embed-url-field").addClass("invalid"),this.setAddToWidgetButtonDisabled(!0)),wp.media.view.EmbedLink.prototype.updateoEmbed.call(this)},fetch:function(){var e=this,t,i,n,d,o,s,a;if(o=e.model.get("url"),e.dfd&&"pending"===e.dfd.state()&&e.dfd.abort(),t=function(t){e.renderoEmbed({data:{body:t}}),e.controller.$el.find("#embed-url-field").removeClass("invalid"),e.setErrorNotice(""),e.setAddToWidgetButtonDisabled(!1)},(d=document.createElement("a")).href=o,i=d.pathname.toLowerCase().match(/\.(\w+)$/))return n=i[1],void(wp.media.view.settings.embedMimes[n]?0!==wp.media.view.settings.embedMimes[n].indexOf(e.controller.options.mimeType)?e.renderFail():t("\x3c!--success--\x3e"):e.renderFail());(a=(s=/https?:\/\/www\.youtube\.com\/embed\/([^\/]+)/).exec(o))&&(o="https://www.youtube.com/watch?v="+a[1],e.model.attributes.url=o),e.dfd=wp.apiRequest({url:wp.media.view.settings.oEmbedProxyUrl,data:{url:o,maxwidth:e.model.get("width"),maxheight:e.model.get("height"),discover:!1},type:"GET",dataType:"json",context:e}),e.dfd.done(function(i){e.controller.options.mimeType===i.type?t(i.html):e.renderFail()}),e.dfd.fail(_.bind(e.renderFail,e))},renderFail:function e(){var t=this;this.controller.$el.find("#embed-url-field").addClass("invalid"),this.setErrorNotice(this.controller.options.invalidEmbedTypeError||"ERROR"),this.setAddToWidgetButtonDisabled(!0)}}),this.settings(new i({controller:this.controller,model:this.model.props,priority:40}))}}),t.MediaFrameSelect=wp.media.view.MediaFrame.Post.extend({createStates:function e(){var i=this.options.mimeType,n=[];_.each(wp.media.view.settings.embedMimes,function(e){0===e.indexOf(i)&&n.push(e)}),n.length>0&&(i=n),this.states.add([new t.PersistentDisplaySettingsLibrary({id:"insert",title:this.options.title,selection:this.options.selection,priority:20,toolbar:"main-insert",filterable:"dates",library:wp.media.query({type:i}),multiple:!1,editable:!0,selectedDisplaySettings:this.options.selectedDisplaySettings,displaySettings:!!_.isUndefined(this.options.showDisplaySettings)||this.options.showDisplaySettings,displayUserSettings:!1}),new wp.media.controller.EditImage({model:this.options.editImage}),new wp.media.controller.Embed({metadata:this.options.metadata,type:"image"===this.options.mimeType?"image":"link",invalidEmbedTypeError:this.options.invalidEmbedTypeError})])},mainInsertToolbar:function e(t){var i=this;t.set("insert",{style:"primary",priority:80,text:i.options.text,requires:{selection:!0},click:function e(){var t=i.state(),n=t.get("selection");i.close(),t.trigger("insert",n).reset()}})},mainEmbedToolbar:function e(t){t.view=new wp.media.view.Toolbar.Embed({controller:this,text:this.options.text,event:"insert"})},embedContent:function e(){var i=new t.MediaEmbedView({controller:this,model:this.state()}).render();this.content.set(i),wp.media.isTouchDevice||i.url.focus()}}),t.MediaWidgetControl=Backbone.View.extend({l10n:{add_to_widget:"{{add_to_widget}}",add_media:"{{add_media}}"},id_base:"",mime_type:"",events:{"click .notice-missing-attachment a":"handleMediaLibraryLinkClick","click .select-media":"selectMedia","click .placeholder":"selectMedia","click .edit-media":"editMedia"},showDisplaySettings:!0,initialize:function i(n){var d=this;if(Backbone.View.prototype.initialize.call(d,n),!(d.model instanceof t.MediaWidgetModel))throw new Error("Missing options.model");if(!n.el)throw new Error("Missing options.el");if(!n.syncContainer)throw new Error("Missing options.syncContainer");if(d.syncContainer=n.syncContainer,d.$el.addClass("media-widget-control"),_.bindAll(d,"syncModelToInputs","render","updateSelectedAttachment","renderPreview"),!d.id_base&&(_.find(t.controlConstructors,function(e,t){return d instanceof e&&(d.id_base=t,!0)}),!d.id_base))throw new Error("Missing id_base.");d.previewTemplateProps=new Backbone.Model(d.mapModelToPreviewTemplateProps()),d.selectedAttachment=new wp.media.model.Attachment,d.renderPreview=_.debounce(d.renderPreview),d.listenTo(d.previewTemplateProps,"change",d.renderPreview),d.model.on("change:attachment_id",d.updateSelectedAttachment),d.model.on("change:url",d.updateSelectedAttachment),d.updateSelectedAttachment(),d.listenTo(d.model,"change",d.syncModelToInputs),d.listenTo(d.model,"change",d.syncModelToPreviewProps),d.listenTo(d.model,"change",d.render),d.$el.on("input change",".title",function t(){d.model.set({title:e.trim(e(this).val())})}),d.$el.on("input change",".link",function t(){var i=e.trim(e(this).val()),n="custom";d.selectedAttachment.get("linkUrl")===i||d.selectedAttachment.get("link")===i?n="post":d.selectedAttachment.get("url")===i&&(n="file"),d.model.set({link_url:i,link_type:n}),d.displaySettings.set({link:n,linkUrl:i})}),d.displaySettings=new Backbone.Model(_.pick(d.mapModelToMediaFrameProps(_.extend(d.model.defaults(),d.model.toJSON())),_.keys(wp.media.view.settings.defaultProps)))},updateSelectedAttachment:function e(){var t=this,i;0===t.model.get("attachment_id")?(t.selectedAttachment.clear(),t.model.set("error",!1)):t.model.get("attachment_id")!==t.selectedAttachment.get("id")&&(i=new wp.media.model.Attachment({id:t.model.get("attachment_id")})).fetch().done(function e(){t.model.set("error",!1),t.selectedAttachment.set(i.toJSON())}).fail(function e(){t.model.set("error","missing_attachment")})},syncModelToPreviewProps:function e(){var t=this;this.previewTemplateProps.set(this.mapModelToPreviewTemplateProps())},syncModelToInputs:function t(){var i=this;i.syncContainer.find(".media-widget-instance-property").each(function(){var t=e(this),n,d;d=t.data("property"),n=i.model.get(d),_.isUndefined(n)||(n="array"===i.model.schema[d].type&&_.isArray(n)?n.join(","):"boolean"===i.model.schema[d].type?n?"1":"":String(n),t.val()!==n&&(t.val(n),t.trigger("change")))})},template:function t(){var i=this;if(!e("#tmpl-widget-media-"+this.id_base+"-control").length)throw new Error("Missing widget control template for "+this.id_base);return wp.template("widget-media-"+this.id_base+"-control")},render:function e(){var t=this,i;this.templateRendered||(this.$el.html(this.template()(this.model.toJSON())),this.renderPreview(),this.templateRendered=!0),(i=this.$el.find(".title")).is(document.activeElement)||i.val(this.model.get("title")),this.$el.toggleClass("selected",this.isSelected())},renderPreview:function e(){throw new Error("renderPreview must be implemented")},isSelected:function e(){var t=this;return!this.model.get("error")&&Boolean(this.model.get("attachment_id")||this.model.get("url"))},handleMediaLibraryLinkClick:function e(t){var i=this;t.preventDefault(),this.selectMedia()},selectMedia:function i(){var n=this,d,o,s,a,r=[];n.isSelected()&&0!==n.model.get("attachment_id")&&r.push(n.selectedAttachment),d=new wp.media.model.Selection(r,{multiple:!1}),(a=n.mapModelToMediaFrameProps(n.model.toJSON())).size&&n.displaySettings.set("size",a.size),o=new t.MediaFrameSelect({title:n.l10n.add_media,frame:"post",text:n.l10n.add_to_widget,selection:d,mimeType:n.mime_type,selectedDisplaySettings:n.displaySettings,showDisplaySettings:n.showDisplaySettings,metadata:a,state:n.isSelected()&&0===n.model.get("attachment_id")?"embed":"insert",invalidEmbedTypeError:n.l10n.unsupported_file_type}),wp.media.frame=o,o.on("insert",function e(){var t={},i=o.state();"embed"===i.get("id")?_.extend(t,{id:0},i.props.toJSON()):_.extend(t,i.get("selection").first().toJSON()),n.selectedAttachment.set(t),n.model.set("error",!1),n.model.set(n.getModelPropsFromMediaFrame(o))}),s=wp.media.model.Attachment.prototype.sync,wp.media.model.Attachment.prototype.sync=function(t){return"delete"===t?s.apply(this,arguments):e.Deferred().rejectWith(this).promise()},o.on("close",function e(){wp.media.model.Attachment.prototype.sync=s}),o.$el.addClass("media-widget"),o.open(),d&&d.on("destroy",function e(t){n.model.get("attachment_id")===t.get("id")&&n.model.set({attachment_id:0,url:""})}),o.$el.find(".media-frame-menu .media-menu-item.active").focus()},getModelPropsFromMediaFrame:function e(t){var i=this,n,d,o;if("insert"===(n=t.state()).get("id"))(d=n.get("selection").first().toJSON()).postUrl=d.link,i.showDisplaySettings&&_.extend(d,t.content.get(".attachments-browser").sidebar.get("display").model.toJSON()),d.sizes&&d.size&&d.sizes[d.size]&&(d.url=d.sizes[d.size].url);else{if("embed"!==n.get("id"))throw new Error("Unexpected state: "+n.get("id"));d=_.extend(n.props.toJSON(),{attachment_id:0},i.model.getEmbedResetProps())}return d.id&&(d.attachment_id=d.id),o=i.mapMediaToModelProps(d),_.each(wp.media.view.settings.embedExts,function(e){e in i.model.schema&&o.url!==o[e]&&(o[e]="")}),o},mapMediaToModelProps:function e(t){var i=this,n={},d={},o;return _.each(i.model.schema,function(e,t){"title"!==t&&(n[e.media_prop||t]=t)}),_.each(t,function(e,t){var o=n[t]||t;i.model.schema[o]&&(d[o]=e)}),"custom"===t.size&&(d.width=t.customWidth,d.height=t.customHeight),"post"===t.link?d.link_url=t.postUrl||t.linkUrl:"file"===t.link&&(d.link_url=t.url),!t.attachment_id&&t.id&&(d.attachment_id=t.id),t.url&&(o=t.url.replace(/#.*$/,"").replace(/\?.*$/,"").split(".").pop().toLowerCase())in i.model.schema&&(d[o]=t.url),_.omit(d,"title")},mapModelToMediaFrameProps:function e(t){var i=this,n={};return _.each(t,function(e,t){var d=i.model.schema[t]||{};n[d.media_prop||t]=e}),n.attachment_id=n.id,"custom"===n.size&&(n.customWidth=i.model.get("width"),n.customHeight=i.model.get("height")),n},mapModelToPreviewTemplateProps:function e(){var t=this,i={};return _.each(t.model.schema,function(e,n){e.hasOwnProperty("should_preview_update")&&!e.should_preview_update||(i[n]=t.model.get(n))}),i.error=t.model.get("error"),i},editMedia:function e(){throw new Error("editMedia not implemented")}}),t.MediaWidgetModel=Backbone.Model.extend({idAttribute:"widget_id",schema:{title:{type:"string",default:""},attachment_id:{type:"integer",default:0},url:{type:"string",default:""}},defaults:function(){var e={};return _.each(this.schema,function(t,i){e[i]=t.default}),e},set:function e(t,i,n){var d=this,o,s,a;return null===t?d:("object"==typeof t?(o=t,s=i):((o={})[t]=i,s=n),a={},_.each(o,function(e,t){var i;d.schema[t]?"array"===(i=d.schema[t].type)?(a[t]=e,_.isArray(a[t])||(a[t]=a[t].split(/,/)),d.schema[t].items&&"integer"===d.schema[t].items.type&&(a[t]=_.filter(_.map(a[t],function(e){return parseInt(e,10)},function(e){return"number"==typeof e})))):a[t]="integer"===i?parseInt(e,10):"boolean"===i?!(!e||"0"===e||"false"===e):e:a[t]=e}),Backbone.Model.prototype.set.call(this,a,s))},getEmbedResetProps:function e(){return{id:0}}}),t.modelCollection=new(Backbone.Collection.extend({model:t.MediaWidgetModel})),t.widgetControls={},t.handleWidgetAdded=function i(n,d){var o,s,a,r,l,c,m,p,h,g,u=50,w;r=(a=d.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),g=a.find("> .widget-id").val(),t.widgetControls[g]||(l=t.controlConstructors[r])&&(c=t.modelConstructors[r]||t.MediaWidgetModel,o=e("<div></div>"),(s=d.find(".widget-content:first")).before(o),m={},s.find(".media-widget-instance-property").each(function(){var t=e(this);m[t.data("property")]=t.val()}),m.widget_id=g,h=new c(m),p=new l({el:o,syncContainer:s,model:h}),(w=function(){d.hasClass("open")?p.render():setTimeout(w,50)})(),t.modelCollection.add([h]),t.widgetControls[h.get("widget_id")]=p)},t.setupAccessibleMode=function i(){var n,d,o,s,a,r,l,c,m;0!==(n=e(".editwidget > form")).length&&(o=n.find("> .widget-control-actions > .id_base").val(),(a=t.controlConstructors[o])&&(d=n.find("> .widget-control-actions > .widget-id").val(),r=t.modelConstructors[o]||t.MediaWidgetModel,c=e("<div></div>"),(m=n.find("> .widget-inside")).before(c),l={},m.find(".media-widget-instance-property").each(function(){var t=e(this);l[t.data("property")]=t.val()}),l.widget_id=d,s=new a({el:c,syncContainer:m,model:new r(l)}),t.modelCollection.add([s.model]),t.widgetControls[s.model.get("widget_id")]=s,s.render()))},t.handleWidgetUpdated=function i(n,d){var o,s,a,r,l={};a=(o=d.find("> .widget-inside > .form, > .widget-inside > form")).find("> .widget-id").val(),(r=t.widgetControls[a])&&((s=o.find("> .widget-content")).find(".media-widget-instance-property").each(function(){var t=e(this).data("property");l[t]=e(this).val()}),r.stopListening(r.model,"change",r.syncModelToInputs),r.model.set(l),r.listenTo(r.model,"change",r.syncModelToInputs))},t.init=function i(){var n=e(document);n.on("widget-added",t.handleWidgetAdded),n.on("widget-synced widget-updated",t.handleWidgetUpdated),e(function i(){var n;"widgets"===window.pagenow&&((n=e(".widgets-holder-wrap:not(#available-widgets)").find("div.widget")).one("click.toggle-widget-expanded",function i(){var n=e(this);t.handleWidgetAdded(new jQuery.Event("widget-added"),n)}),e(window).on("load",function(){t.setupAccessibleMode()}))})},t}(jQuery);