wp.mediaWidgets=function($){"use strict";var e={};return e.controlConstructors={},e.modelConstructors={},e.PersistentDisplaySettingsLibrary=wp.media.controller.Library.extend({initialize:function e(t){_.bindAll(this,"handleDisplaySettingChange"),wp.media.controller.Library.prototype.initialize.call(this,t)},handleDisplaySettingChange:function e(t){this.get("selectedDisplaySettings").set(t.attributes)},display:function e(t){var i,n=this.get("selectedDisplaySettings");return i=wp.media.controller.Library.prototype.display.call(this,t),i.off("change",this.handleDisplaySettingChange),i.set(n.attributes),"custom"===n.get("link_type")&&(i.linkUrl=n.get("link_url")),i.on("change",this.handleDisplaySettingChange),i}}),e.MediaEmbedView=wp.media.view.Embed.extend({initialize:function(e){var t=this,i;wp.media.view.Embed.prototype.initialize.call(t,e),"image"!==t.controller.options.mimeType&&(i=t.controller.states.get("embed"),i.off("scan",i.scanImage,i))},refresh:function e(){var t;t="image"===this.controller.options.mimeType?wp.media.view.EmbedImage:wp.media.view.EmbedLink.extend({setAddToWidgetButtonDisabled:function e(t){this.views.parent.views.parent.views.get(".media-frame-toolbar")[0].$el.find(".media-button-select").prop("disabled",t)},setErrorNotice:function e(t){var i=this,n;n=i.views.parent.$el.find("> .notice:first-child"),t?(n.length||(n=$('<div class="media-widget-embed-notice notice notice-error notice-alt"></div>'),n.hide(),i.views.parent.$el.prepend(n)),n.empty(),n.append($("<p>",{html:t})),n.slideDown("fast")):n.length&&n.slideUp("fast")},updateoEmbed:function(){var e=this,t;if(!(t=e.model.get("url")))return e.setErrorNotice(""),void e.setAddToWidgetButtonDisabled(!0);t.match(/^(http|https):\/\/.+\//)||(e.controller.$el.find("#embed-url-field").addClass("invalid"),e.setAddToWidgetButtonDisabled(!0)),wp.media.view.EmbedLink.prototype.updateoEmbed.call(e)},fetch:function(){var e=this,t,i,n,d,o,a,r;if(o=e.model.get("url"),e.dfd&&"pending"===e.dfd.state()&&e.dfd.abort(),t=function(t){e.renderoEmbed({data:{body:t}}),e.controller.$el.find("#embed-url-field").removeClass("invalid"),e.setErrorNotice(""),e.setAddToWidgetButtonDisabled(!1)},d=document.createElement("a"),d.href=o,i=d.pathname.toLowerCase().match(/\.(\w+)$/))return n=i[1],void(wp.media.view.settings.embedMimes[n]?0!==wp.media.view.settings.embedMimes[n].indexOf(e.controller.options.mimeType)?e.renderFail():t("<!--success-->"):e.renderFail());a=/https?:\/\/www\.youtube\.com\/embed\/([^\/]+)/,r=a.exec(o),r&&(o="https://www.youtube.com/watch?v="+r[1],e.model.attributes.url=o),e.dfd=wp.apiRequest({url:wp.media.view.settings.oEmbedProxyUrl,data:{url:o,maxwidth:e.model.get("width"),maxheight:e.model.get("height"),discover:!1},type:"GET",dataType:"json",context:e}),e.dfd.done(function(i){if(e.controller.options.mimeType!==i.type)return void e.renderFail();t(i.html)}),e.dfd.fail(_.bind(e.renderFail,e))},renderFail:function e(){var t=this;t.controller.$el.find("#embed-url-field").addClass("invalid"),t.setErrorNotice(t.controller.options.invalidEmbedTypeError||"ERROR"),t.setAddToWidgetButtonDisabled(!0)}}),this.settings(new t({controller:this.controller,model:this.model.props,priority:40}))}}),e.MediaFrameSelect=wp.media.view.MediaFrame.Post.extend({createStates:function t(){var i=this.options.mimeType,n=[];_.each(wp.media.view.settings.embedMimes,function(e){0===e.indexOf(i)&&n.push(e)}),n.length>0&&(i=n),this.states.add([new e.PersistentDisplaySettingsLibrary({id:"insert",title:this.options.title,selection:this.options.selection,priority:20,toolbar:"main-insert",filterable:"dates",library:wp.media.query({type:i}),multiple:!1,editable:!0,selectedDisplaySettings:this.options.selectedDisplaySettings,displaySettings:!!_.isUndefined(this.options.showDisplaySettings)||this.options.showDisplaySettings,displayUserSettings:!1}),new wp.media.controller.EditImage({model:this.options.editImage}),new wp.media.controller.Embed({metadata:this.options.metadata,type:"image"===this.options.mimeType?"image":"link",invalidEmbedTypeError:this.options.invalidEmbedTypeError})])},mainInsertToolbar:function e(t){var i=this;t.set("insert",{style:"primary",priority:80,text:i.options.text,requires:{selection:!0},click:function e(){var t=i.state(),n=t.get("selection");i.close(),t.trigger("insert",n).reset()}})},mainEmbedToolbar:function e(t){t.view=new wp.media.view.Toolbar.Embed({controller:this,text:this.options.text,event:"insert"})},embedContent:function t(){var i=new e.MediaEmbedView({controller:this,model:this.state()}).render();this.content.set(i),wp.media.isTouchDevice||i.url.focus()}}),e.MediaWidgetControl=Backbone.View.extend({l10n:{add_to_widget:"{{add_to_widget}}",add_media:"{{add_media}}"},id_base:"",mime_type:"",events:{"click .notice-missing-attachment a":"handleMediaLibraryLinkClick","click .select-media":"selectMedia","click .placeholder":"selectMedia","click .edit-media":"editMedia"},showDisplaySettings:!0,initialize:function t(i){var n=this;if(Backbone.View.prototype.initialize.call(n,i),!(n.model instanceof e.MediaWidgetModel))throw new Error("Missing options.model");if(!i.el)throw new Error("Missing options.el");if(!i.syncContainer)throw new Error("Missing options.syncContainer");if(n.syncContainer=i.syncContainer,n.$el.addClass("media-widget-control"),_.bindAll(n,"syncModelToInputs","render","updateSelectedAttachment","renderPreview"),!n.id_base&&(_.find(e.controlConstructors,function(e,t){return n instanceof e&&(n.id_base=t,!0)}),!n.id_base))throw new Error("Missing id_base.");n.previewTemplateProps=new Backbone.Model(n.mapModelToPreviewTemplateProps()),n.selectedAttachment=new wp.media.model.Attachment,n.renderPreview=_.debounce(n.renderPreview),n.listenTo(n.previewTemplateProps,"change",n.renderPreview),n.model.on("change:attachment_id",n.updateSelectedAttachment),n.model.on("change:url",n.updateSelectedAttachment),n.updateSelectedAttachment(),n.listenTo(n.model,"change",n.syncModelToInputs),n.listenTo(n.model,"change",n.syncModelToPreviewProps),n.listenTo(n.model,"change",n.render),n.$el.on("input change",".title",function e(){n.model.set({title:$.trim($(this).val())})}),n.$el.on("input change",".link",function e(){var t=$.trim($(this).val()),i="custom";n.selectedAttachment.get("linkUrl")===t||n.selectedAttachment.get("link")===t?i="post":n.selectedAttachment.get("url")===t&&(i="file"),n.model.set({link_url:t,link_type:i}),n.displaySettings.set({link:i,linkUrl:t})}),n.displaySettings=new Backbone.Model(_.pick(n.mapModelToMediaFrameProps(_.extend(n.model.defaults(),n.model.toJSON())),_.keys(wp.media.view.settings.defaultProps)))},updateSelectedAttachment:function e(){var t=this,i;0===t.model.get("attachment_id")?(t.selectedAttachment.clear(),t.model.set("error",!1)):t.model.get("attachment_id")!==t.selectedAttachment.get("id")&&(i=new wp.media.model.Attachment({id:t.model.get("attachment_id")}),i.fetch().done(function e(){t.model.set("error",!1),t.selectedAttachment.set(i.toJSON())}).fail(function e(){t.model.set("error","missing_attachment")}))},syncModelToPreviewProps:function e(){var t=this;t.previewTemplateProps.set(t.mapModelToPreviewTemplateProps())},syncModelToInputs:function e(){var t=this;t.syncContainer.find(".media-widget-instance-property").each(function(){var e=$(this),i,n;n=e.data("property"),i=t.model.get(n),_.isUndefined(i)||(i="array"===t.model.schema[n].type&&_.isArray(i)?i.join(","):"boolean"===t.model.schema[n].type?i?"1":"":String(i),e.val()!==i&&(e.val(i),e.trigger("change")))})},template:function e(){var t=this;if(!$("#tmpl-widget-media-"+t.id_base+"-control").length)throw new Error("Missing widget control template for "+t.id_base);return wp.template("widget-media-"+t.id_base+"-control")},render:function e(){var t=this,i;t.templateRendered||(t.$el.html(t.template()(t.model.toJSON())),t.renderPreview(),t.templateRendered=!0),i=t.$el.find(".title"),i.is(document.activeElement)||i.val(t.model.get("title")),t.$el.toggleClass("selected",t.isSelected())},renderPreview:function e(){throw new Error("renderPreview must be implemented")},isSelected:function e(){var t=this;return!t.model.get("error")&&Boolean(t.model.get("attachment_id")||t.model.get("url"))},handleMediaLibraryLinkClick:function e(t){var i=this;t.preventDefault(),i.selectMedia()},selectMedia:function t(){var i=this,n,d,o,a,r=[];i.isSelected()&&0!==i.model.get("attachment_id")&&r.push(i.selectedAttachment),n=new wp.media.model.Selection(r,{multiple:!1}),a=i.mapModelToMediaFrameProps(i.model.toJSON()),a.size&&i.displaySettings.set("size",a.size),d=new e.MediaFrameSelect({title:i.l10n.add_media,frame:"post",text:i.l10n.add_to_widget,selection:n,mimeType:i.mime_type,selectedDisplaySettings:i.displaySettings,showDisplaySettings:i.showDisplaySettings,metadata:a,state:i.isSelected()&&0===i.model.get("attachment_id")?"embed":"insert",invalidEmbedTypeError:i.l10n.unsupported_file_type}),wp.media.frame=d,d.on("insert",function e(){var t={},n=d.state();"embed"===n.get("id")?_.extend(t,{id:0},n.props.toJSON()):_.extend(t,n.get("selection").first().toJSON()),i.selectedAttachment.set(t),i.model.set("error",!1),i.model.set(i.getModelPropsFromMediaFrame(d))}),o=wp.media.model.Attachment.prototype.sync,wp.media.model.Attachment.prototype.sync=function(e){return"delete"===e?o.apply(this,arguments):$.Deferred().rejectWith(this).promise()},d.on("close",function e(){wp.media.model.Attachment.prototype.sync=o}),d.$el.addClass("media-widget"),d.open(),n&&n.on("destroy",function e(t){i.model.get("attachment_id")===t.get("id")&&i.model.set({attachment_id:0,url:""})}),d.$el.find(".media-frame-menu .media-menu-item.active").focus()},getModelPropsFromMediaFrame:function e(t){var i=this,n,d,o;if(n=t.state(),"insert"===n.get("id"))d=n.get("selection").first().toJSON(),d.postUrl=d.link,i.showDisplaySettings&&_.extend(d,t.content.get(".attachments-browser").sidebar.get("display").model.toJSON()),d.sizes&&d.size&&d.sizes[d.size]&&(d.url=d.sizes[d.size].url);else{if("embed"!==n.get("id"))throw new Error("Unexpected state: "+n.get("id"));d=_.extend(n.props.toJSON(),{attachment_id:0},i.model.getEmbedResetProps())}return d.id&&(d.attachment_id=d.id),o=i.mapMediaToModelProps(d),_.each(wp.media.view.settings.embedExts,function(e){e in i.model.schema&&o.url!==o[e]&&(o[e]="")}),o},mapMediaToModelProps:function e(t){var i=this,n={},d={},o;return _.each(i.model.schema,function(e,t){"title"!==t&&(n[e.media_prop||t]=t)}),_.each(t,function(e,t){var o=n[t]||t;i.model.schema[o]&&(d[o]=e)}),"custom"===t.size&&(d.width=t.customWidth,d.height=t.customHeight),"post"===t.link?d.link_url=t.postUrl||t.linkUrl:"file"===t.link&&(d.link_url=t.url),!t.attachment_id&&t.id&&(d.attachment_id=t.id),t.url&&(o=t.url.replace(/#.*$/,"").replace(/\?.*$/,"").split(".").pop().toLowerCase())in i.model.schema&&(d[o]=t.url),_.omit(d,"title")},mapModelToMediaFrameProps:function e(t){var i=this,n={};return _.each(t,function(e,t){var d=i.model.schema[t]||{};n[d.media_prop||t]=e}),n.attachment_id=n.id,"custom"===n.size&&(n.customWidth=i.model.get("width"),n.customHeight=i.model.get("height")),n},mapModelToPreviewTemplateProps:function e(){var t=this,i={};return _.each(t.model.schema,function(e,n){e.hasOwnProperty("should_preview_update")&&!e.should_preview_update||(i[n]=t.model.get(n))}),i.error=t.model.get("error"),i},editMedia:function e(){throw new Error("editMedia not implemented")}}),e.MediaWidgetModel=Backbone.Model.extend({idAttribute:"widget_id",schema:{title:{type:"string",default:""},attachment_id:{type:"integer",default:0},url:{type:"string",default:""}},defaults:function(){var e={};return _.each(this.schema,function(t,i){e[i]=t.default}),e},set:function e(t,i,n){var d=this,o,a,r;return null===t?d:("object"==typeof t?(o=t,a=i):(o={},o[t]=i,a=n),r={},_.each(o,function(e,t){var i;if(!d.schema[t])return void(r[t]=e);i=d.schema[t].type,"array"===i?(r[t]=e,_.isArray(r[t])||(r[t]=r[t].split(/,/)),d.schema[t].items&&"integer"===d.schema[t].items.type&&(r[t]=_.filter(_.map(r[t],function(e){return parseInt(e,10)},function(e){return"number"==typeof e})))):r[t]="integer"===i?parseInt(e,10):"boolean"===i?!(!e||"0"===e||"false"===e):e}),Backbone.Model.prototype.set.call(this,r,a))},getEmbedResetProps:function e(){return{id:0}}}),e.modelCollection=new(Backbone.Collection.extend({model:e.MediaWidgetModel})),e.widgetControls={},e.handleWidgetAdded=function t(i,n){var d,o,a,r,s,l,c,m,p,h,g=50,u;a=n.find("> .widget-inside > .form, > .widget-inside > form"),r=a.find("> .id_base").val(),h=a.find("> .widget-id").val(),e.widgetControls[h]||(s=e.controlConstructors[r])&&(l=e.modelConstructors[r]||e.MediaWidgetModel,d=$("<div></div>"),o=n.find(".widget-content:first"),o.before(d),c={},o.find(".media-widget-instance-property").each(function(){var e=$(this);c[e.data("property")]=e.val()}),c.widget_id=h,p=new l(c),m=new s({el:d,syncContainer:o,model:p}),u=function(){n.hasClass("open")?m.render():setTimeout(u,50)},u(),e.modelCollection.add([p]),e.widgetControls[p.get("widget_id")]=m)},e.setupAccessibleMode=function t(){var i,n,d,o,a,r,s,l,c;i=$(".editwidget > form"),0!==i.length&&(d=i.find("> .widget-control-actions > .id_base").val(),(a=e.controlConstructors[d])&&(n=i.find("> .widget-control-actions > .widget-id").val(),r=e.modelConstructors[d]||e.MediaWidgetModel,l=$("<div></div>"),c=i.find("> .widget-inside"),c.before(l),s={},c.find(".media-widget-instance-property").each(function(){var e=$(this);s[e.data("property")]=e.val()}),s.widget_id=n,o=new a({el:l,syncContainer:c,model:new r(s)}),e.modelCollection.add([o.model]),e.widgetControls[o.model.get("widget_id")]=o,o.render()))},e.handleWidgetUpdated=function t(i,n){var d,o,a,r,s={};d=n.find("> .widget-inside > .form, > .widget-inside > form"),a=d.find("> .widget-id").val(),(r=e.widgetControls[a])&&(o=d.find("> .widget-content"),o.find(".media-widget-instance-property").each(function(){var e=$(this).data("property");s[e]=$(this).val()}),r.stopListening(r.model,"change",r.syncModelToInputs),r.model.set(s),r.listenTo(r.model,"change",r.syncModelToInputs))},e.init=function t(){var i=$(document);i.on("widget-added",e.handleWidgetAdded),i.on("widget-synced widget-updated",e.handleWidgetUpdated),$(function t(){var i;"widgets"===window.pagenow&&(i=$(".widgets-holder-wrap:not(#available-widgets)").find("div.widget"),i.one("click.toggle-widget-expanded",function t(){var i=$(this);e.handleWidgetAdded(new jQuery.Event("widget-added"),i)}),$(window).on("load",function(){e.setupAccessibleMode()}))})},e}(jQuery);