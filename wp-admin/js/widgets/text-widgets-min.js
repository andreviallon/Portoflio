wp.textWidgets=function($){"use strict";var t={dismissedPointers:[],idBases:["text"]};return t.TextWidgetControl=Backbone.View.extend({events:{},initialize:function t(e){var i=this;if(!e.el)throw new Error("Missing options.el");if(!e.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(i,e),i.syncContainer=e.syncContainer,i.$el.addClass("text-widget-fields"),i.$el.html(wp.template("widget-text-control-fields")),i.customHtmlWidgetPointer=i.$el.find(".wp-pointer.custom-html-widget-pointer"),i.customHtmlWidgetPointer.length&&(i.customHtmlWidgetPointer.find(".close").on("click",function(t){t.preventDefault(),i.customHtmlWidgetPointer.hide(),$("#"+i.fields.text.attr("id")+"-html").focus(),i.dismissPointers(["text_widget_custom_html"])}),i.customHtmlWidgetPointer.find(".add-widget").on("click",function(t){t.preventDefault(),i.customHtmlWidgetPointer.hide(),i.openAvailableWidgetsPanel()})),i.pasteHtmlPointer=i.$el.find(".wp-pointer.paste-html-pointer"),i.pasteHtmlPointer.length&&i.pasteHtmlPointer.find(".close").on("click",function(t){t.preventDefault(),i.pasteHtmlPointer.hide(),i.editor.focus(),i.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])}),i.fields={title:i.$el.find(".title"),text:i.$el.find(".text")},_.each(i.fields,function(t,e){t.on("input change",function n(){var d=i.syncContainer.find(".sync-input."+e);d.val()!==t.val()&&(d.val(t.val()),d.trigger("change"))}),t.val(i.syncContainer.find(".sync-input."+e).val())})},dismissPointers:function e(i){_.each(i,function(e){wp.ajax.post("dismiss-wp-pointer",{pointer:e}),t.dismissedPointers.push(e)})},openAvailableWidgetsPanel:function t(){var e;wp.customize.section.each(function(t){t.extended(wp.customize.Widgets.SidebarSection)&&t.expanded()&&(e=wp.customize.control("sidebars_widgets["+t.params.sidebarId+"]"))}),e&&setTimeout(function(){wp.customize.Widgets.availableWidgetsPanel.open(e),wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")})},updateFields:function t(){var e=this,i;e.fields.title.is(document.activeElement)||(i=e.syncContainer.find(".sync-input.title"),e.fields.title.val(i.val())),i=e.syncContainer.find(".sync-input.text"),e.fields.text.is(":visible")?e.fields.text.is(document.activeElement)||e.fields.text.val(i.val()):e.editor&&!e.editorFocused&&i.val()!==e.fields.text.val()&&e.editor.setContent(wp.editor.autop(i.val()))},initializeEditor:function e(){function i(){var e,s,r;if(document.getElementById(o)){if(void 0===window.tinymce)return void wp.editor.initialize(o,{quicktags:!0,mediaButtons:!0});if(tinymce.get(o)&&(l=tinymce.get(o).isHidden(),wp.editor.remove(o)),$(document).one("wp-before-tinymce-init.text-widget-init",function(t,e){e.plugins&&(/\bwpview\b/.test(e.plugins)||(e.plugins+=",wpview"))}),wp.editor.initialize(o,{tinymce:{wpautop:!0},quicktags:!0,mediaButtons:!0}),r=function(t){t.show(),t.find(".close").focus(),wp.a11y.speak(t.find("h3, p").map(function(){return $(this).text()}).get().join("\n\n"))},!(e=window.tinymce.get(o)))throw new Error("Failed to initialize editor");s=function(){$(e.getWin()).on("unload",function(){_.defer(i)}),l&&switchEditors.go(o,"html"),$("#"+o+"-html").on("click",function(){n.pasteHtmlPointer.hide(),-1===t.dismissedPointers.indexOf("text_widget_custom_html")&&r(n.customHtmlWidgetPointer)}),$("#"+o+"-tmce").on("click",function(){n.customHtmlWidgetPointer.hide()}),e.on("pastepreprocess",function(e){var i=e.content;-1===t.dismissedPointers.indexOf("text_widget_paste_html")&&i&&/&lt;\w+.*?&gt;/.test(i)&&_.delay(function(){r(n.pasteHtmlPointer)},250)})},e.initialized?s():e.on("init",s),n.editorFocused=!1,e.on("focus",function t(){n.editorFocused=!0}),e.on("paste",function t(){e.setDirty(!0),a()}),e.on("NodeChange",function t(){c=!0}),e.on("NodeChange",_.debounce(a,d)),e.on("blur hide",function t(){n.editorFocused=!1,a()}),n.editor=e}}var n=this,d=1e3,o,s,a,l=!1,c=!1,r;s=n.fields.text,o=s.attr("id"),r=s.val(),a=function(){var t=300;n.editor.isDirty()&&(wp.customize&&wp.customize.state&&(wp.customize.state("processing").set(wp.customize.state("processing").get()+1),_.delay(function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)},300)),n.editor.isHidden()||n.editor.save()),c&&r!==s.val()&&(s.trigger("change"),c=!1,r=s.val())},n.syncContainer.closest(".widget").find("[name=savewidget]:first").on("click",function t(){a()}),i()}}),t.widgetControls={},t.handleWidgetAdded=function e(i,n){var d,o,s,a,l=50,c,r,u;d=n.find("> .widget-inside > .form, > .widget-inside > form"),o=d.find("> .id_base").val(),-1!==t.idBases.indexOf(o)&&(a=d.find(".widget-id").val(),t.widgetControls[a]||d.find(".visual").val()&&(r=$("<div></div>"),u=n.find(".widget-content:first"),u.before(r),s=new t.TextWidgetControl({el:r,syncContainer:u}),t.widgetControls[a]=s,(c=function(){n.hasClass("open")?s.initializeEditor():setTimeout(c,50)})()))},t.setupAccessibleMode=function e(){var i,n,d,o,s;i=$(".editwidget > form"),0!==i.length&&(n=i.find("> .widget-control-actions > .id_base").val(),-1!==t.idBases.indexOf(n)&&i.find(".visual").val()&&(o=$("<div></div>"),s=i.find("> .widget-inside"),s.before(o),d=new t.TextWidgetControl({el:o,syncContainer:s}),d.initializeEditor()))},t.handleWidgetUpdated=function e(i,n){var d,o,s,a;d=n.find("> .widget-inside > .form, > .widget-inside > form"),a=d.find("> .id_base").val(),-1!==t.idBases.indexOf(a)&&(o=d.find("> .widget-id").val(),(s=t.widgetControls[o])&&s.updateFields())},t.init=function e(){var i=$(document);i.on("widget-added",t.handleWidgetAdded),i.on("widget-synced widget-updated",t.handleWidgetUpdated),$(function e(){var i;"widgets"===window.pagenow&&(i=$(".widgets-holder-wrap:not(#available-widgets)").find("div.widget"),i.one("click.toggle-widget-expanded",function e(){var i=$(this);t.handleWidgetAdded(new jQuery.Event("widget-added"),i)}),$(window).on("load",function(){t.setupAccessibleMode()}))})},t}(jQuery);