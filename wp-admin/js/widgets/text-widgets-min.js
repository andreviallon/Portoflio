wp.textWidgets=function(t){"use strict";var e={dismissedPointers:[],idBases:["text"]};return e.TextWidgetControl=Backbone.View.extend({events:{},initialize:function e(i){var n=this;if(!i.el)throw new Error("Missing options.el");if(!i.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(n,i),n.syncContainer=i.syncContainer,n.$el.addClass("text-widget-fields"),n.$el.html(wp.template("widget-text-control-fields")),n.customHtmlWidgetPointer=n.$el.find(".wp-pointer.custom-html-widget-pointer"),n.customHtmlWidgetPointer.length&&(n.customHtmlWidgetPointer.find(".close").on("click",function(e){e.preventDefault(),n.customHtmlWidgetPointer.hide(),t("#"+n.fields.text.attr("id")+"-html").focus(),n.dismissPointers(["text_widget_custom_html"])}),n.customHtmlWidgetPointer.find(".add-widget").on("click",function(t){t.preventDefault(),n.customHtmlWidgetPointer.hide(),n.openAvailableWidgetsPanel()})),n.pasteHtmlPointer=n.$el.find(".wp-pointer.paste-html-pointer"),n.pasteHtmlPointer.length&&n.pasteHtmlPointer.find(".close").on("click",function(t){t.preventDefault(),n.pasteHtmlPointer.hide(),n.editor.focus(),n.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])}),n.fields={title:n.$el.find(".title"),text:n.$el.find(".text")},_.each(n.fields,function(t,e){t.on("input change",function i(){var d=n.syncContainer.find(".sync-input."+e);d.val()!==t.val()&&(d.val(t.val()),d.trigger("change"))}),t.val(n.syncContainer.find(".sync-input."+e).val())})},dismissPointers:function t(i){_.each(i,function(t){wp.ajax.post("dismiss-wp-pointer",{pointer:t}),e.dismissedPointers.push(t)})},openAvailableWidgetsPanel:function t(){var e;wp.customize.section.each(function(t){t.extended(wp.customize.Widgets.SidebarSection)&&t.expanded()&&(e=wp.customize.control("sidebars_widgets["+t.params.sidebarId+"]"))}),e&&setTimeout(function(){wp.customize.Widgets.availableWidgetsPanel.open(e),wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")})},updateFields:function t(){var e=this,i;this.fields.title.is(document.activeElement)||(i=this.syncContainer.find(".sync-input.title"),this.fields.title.val(i.val())),i=this.syncContainer.find(".sync-input.text"),this.fields.text.is(":visible")?this.fields.text.is(document.activeElement)||this.fields.text.val(i.val()):this.editor&&!this.editorFocused&&i.val()!==this.fields.text.val()&&this.editor.setContent(wp.editor.autop(i.val()))},initializeEditor:function i(){function n(){var i,a,u;if(document.getElementById(s))if(void 0!==window.tinymce){if(tinymce.get(s)&&(c=tinymce.get(s).isHidden(),wp.editor.remove(s)),t(document).one("wp-before-tinymce-init.text-widget-init",function(t,e){e.plugins&&(/\bwpview\b/.test(e.plugins)||(e.plugins+=",wpview"))}),wp.editor.initialize(s,{tinymce:{wpautop:!0},quicktags:!0,mediaButtons:!0}),u=function(e){e.show(),e.find(".close").focus(),wp.a11y.speak(e.find("h3, p").map(function(){return t(this).text()}).get().join("\n\n"))},!(i=window.tinymce.get(s)))throw new Error("Failed to initialize editor");a=function(){t(i.getWin()).on("unload",function(){_.defer(n)}),c&&switchEditors.go(s,"html"),t("#"+s+"-html").on("click",function(){d.pasteHtmlPointer.hide(),-1===e.dismissedPointers.indexOf("text_widget_custom_html")&&u(d.customHtmlWidgetPointer)}),t("#"+s+"-tmce").on("click",function(){d.customHtmlWidgetPointer.hide()}),i.on("pastepreprocess",function(t){var i=t.content;-1===e.dismissedPointers.indexOf("text_widget_paste_html")&&i&&/&lt;\w+.*?&gt;/.test(i)&&_.delay(function(){u(d.pasteHtmlPointer)},250)})},i.initialized?a():i.on("init",a),d.editorFocused=!1,i.on("focus",function t(){d.editorFocused=!0}),i.on("paste",function t(){i.setDirty(!0),l()}),i.on("NodeChange",function t(){r=!0}),i.on("NodeChange",_.debounce(l,o)),i.on("blur hide",function t(){d.editorFocused=!1,l()}),d.editor=i}else wp.editor.initialize(s,{quicktags:!0,mediaButtons:!0})}var d=this,o=1e3,s,a,l,c=!1,r=!1,u;a=d.fields.text,s=a.attr("id"),u=a.val(),l=function(){var t=300;d.editor.isDirty()&&(wp.customize&&wp.customize.state&&(wp.customize.state("processing").set(wp.customize.state("processing").get()+1),_.delay(function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)},300)),d.editor.isHidden()||d.editor.save()),r&&u!==a.val()&&(a.trigger("change"),r=!1,u=a.val())},d.syncContainer.closest(".widget").find("[name=savewidget]:first").on("click",function t(){l()}),n()}}),e.widgetControls={},e.handleWidgetAdded=function i(n,d){var o,s,a,l,c=50,r,u,f;s=(o=d.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),-1!==e.idBases.indexOf(s)&&(l=o.find(".widget-id").val(),e.widgetControls[l]||o.find(".visual").val()&&(u=t("<div></div>"),(f=d.find(".widget-content:first")).before(u),a=new e.TextWidgetControl({el:u,syncContainer:f}),e.widgetControls[l]=a,(r=function(){d.hasClass("open")?a.initializeEditor():setTimeout(r,50)})()))},e.setupAccessibleMode=function i(){var n,d,o,s,a;0!==(n=t(".editwidget > form")).length&&(d=n.find("> .widget-control-actions > .id_base").val(),-1!==e.idBases.indexOf(d)&&n.find(".visual").val()&&(s=t("<div></div>"),(a=n.find("> .widget-inside")).before(s),(o=new e.TextWidgetControl({el:s,syncContainer:a})).initializeEditor()))},e.handleWidgetUpdated=function t(i,n){var d,o,s,a;a=(d=n.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),-1!==e.idBases.indexOf(a)&&(o=d.find("> .widget-id").val(),(s=e.widgetControls[o])&&s.updateFields())},e.init=function i(){var n=t(document);n.on("widget-added",e.handleWidgetAdded),n.on("widget-synced widget-updated",e.handleWidgetUpdated),t(function i(){var n;"widgets"===window.pagenow&&((n=t(".widgets-holder-wrap:not(#available-widgets)").find("div.widget")).one("click.toggle-widget-expanded",function i(){var n=t(this);e.handleWidgetAdded(new jQuery.Event("widget-added"),n)}),t(window).on("load",function(){e.setupAccessibleMode()}))})},e}(jQuery);