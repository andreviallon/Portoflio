wp.customHtmlWidgets=function($){"use strict";var e={idBases:["custom_html"],codeEditorSettings:{},l10n:{errorNotice:{singular:"",plural:""}}};return e.CustomHtmlWidgetControl=Backbone.View.extend({events:{},initialize:function t(i){var n=this;if(!i.el)throw new Error("Missing options.el");if(!i.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(n,i),n.syncContainer=i.syncContainer,n.widgetIdBase=n.syncContainer.parent().find(".id_base").val(),n.widgetNumber=n.syncContainer.parent().find(".widget_number").val(),n.customizeSettingId="widget_"+n.widgetIdBase+"["+String(n.widgetNumber)+"]",n.$el.addClass("custom-html-widget-fields"),n.$el.html(wp.template("widget-custom-html-control-fields")({codeEditorDisabled:e.codeEditorSettings.disabled})),n.errorNoticeContainer=n.$el.find(".code-editor-error-container"),n.currentErrorAnnotations=[],n.saveButton=n.syncContainer.add(n.syncContainer.parent().find(".widget-control-actions")).find(".widget-control-save, #savewidget"),n.saveButton.addClass("custom-html-widget-save-button"),n.fields={title:n.$el.find(".title"),content:n.$el.find(".content")},_.each(n.fields,function(e,t){e.on("input change",function i(){var o=n.syncContainer.find(".sync-input."+t);o.val()!==e.val()&&(o.val(e.val()),o.trigger("change"))}),e.val(n.syncContainer.find(".sync-input."+t).val())})},updateFields:function e(){var t=this,i;t.fields.title.is(document.activeElement)||(i=t.syncContainer.find(".sync-input.title"),t.fields.title.val(i.val())),t.contentUpdateBypassed=t.fields.content.is(document.activeElement)||t.editor&&t.editor.codemirror.state.focused||0!==t.currentErrorAnnotations,t.contentUpdateBypassed||(i=t.syncContainer.find(".sync-input.content"),t.fields.content.val(i.val()).trigger("change"))},updateErrorNotice:function(t){var i=this,n,o="",d;1===t.length?o=e.l10n.errorNotice.singular.replace("%d","1"):t.length>1&&(o=e.l10n.errorNotice.plural.replace("%d",String(t.length))),i.fields.content[0].setCustomValidity&&i.fields.content[0].setCustomValidity(o),wp.customize&&wp.customize.has(i.customizeSettingId)?(d=wp.customize(i.customizeSettingId),d.notifications.remove("htmlhint_error"),0!==t.length&&d.notifications.add("htmlhint_error",new wp.customize.Notification("htmlhint_error",{message:o,type:"error"}))):0!==t.length?(n=$('<div class="inline notice notice-error notice-alt"></div>'),n.append($("<p></p>",{text:o})),i.errorNoticeContainer.empty(),i.errorNoticeContainer.append(n),i.errorNoticeContainer.slideDown("fast"),wp.a11y.speak(o)):i.errorNoticeContainer.slideUp("fast")},initializeEditor:function t(){var i=this,n;e.codeEditorSettings.disabled||(n=_.extend({},e.codeEditorSettings,{onTabPrevious:function e(){i.fields.title.focus()},onTabNext:function e(){i.syncContainer.add(i.syncContainer.parent().find(".widget-position, .widget-control-actions")).find(":tabbable").first().focus()},onChangeLintingErrors:function e(t){i.currentErrorAnnotations=t},onUpdateErrorNotice:function e(t){i.saveButton.toggleClass("validation-blocked disabled",t.length),i.updateErrorNotice(t)}}),i.editor=wp.codeEditor.initialize(i.fields.content,n),$(i.editor.codemirror.display.lineDiv).attr({role:"textbox","aria-multiline":"true","aria-labelledby":i.fields.content[0].id+"-label","aria-describedby":"editor-keyboard-trap-help-1 editor-keyboard-trap-help-2 editor-keyboard-trap-help-3 editor-keyboard-trap-help-4"}),$("#"+i.fields.content[0].id+"-label").on("click",function(){i.editor.codemirror.focus()}),i.fields.content.on("change",function(){this.value!==i.editor.codemirror.getValue()&&i.editor.codemirror.setValue(this.value)}),i.editor.codemirror.on("change",function(){var e=i.editor.codemirror.getValue();e!==i.fields.content.val()&&i.fields.content.val(e).trigger("change")}),i.editor.codemirror.on("blur",function(){i.contentUpdateBypassed&&i.syncContainer.find(".sync-input.content").trigger("change")}),wp.customize&&i.editor.codemirror.on("keydown",function e(t,i){var n=27;27===i.keyCode&&i.stopPropagation()}))}}),e.widgetControls={},e.handleWidgetAdded=function t(i,n){var o,d,r,a,s=50,l,c,g;o=n.find("> .widget-inside > .form, > .widget-inside > form"),d=o.find("> .id_base").val(),-1!==e.idBases.indexOf(d)&&(a=o.find(".widget-id").val(),e.widgetControls[a]||(c=$("<div></div>"),g=n.find(".widget-content:first"),g.before(c),r=new e.CustomHtmlWidgetControl({el:c,syncContainer:g}),e.widgetControls[a]=r,(l=function(){(wp.customize?n.parent().hasClass("expanded"):n.hasClass("open"))?r.initializeEditor():setTimeout(l,50)})()))},e.setupAccessibleMode=function t(){var i,n,o,d,r;i=$(".editwidget > form"),0!==i.length&&(n=i.find("> .widget-control-actions > .id_base").val(),-1!==e.idBases.indexOf(n)&&(d=$("<div></div>"),r=i.find("> .widget-inside"),r.before(d),o=new e.CustomHtmlWidgetControl({el:d,syncContainer:r}),o.initializeEditor()))},e.handleWidgetUpdated=function t(i,n){var o,d,r,a;o=n.find("> .widget-inside > .form, > .widget-inside > form"),a=o.find("> .id_base").val(),-1!==e.idBases.indexOf(a)&&(d=o.find("> .widget-id").val(),(r=e.widgetControls[d])&&r.updateFields())},e.init=function t(i){var n=$(document);_.extend(e.codeEditorSettings,i),n.on("widget-added",e.handleWidgetAdded),n.on("widget-synced widget-updated",e.handleWidgetUpdated),$(function t(){var i;"widgets"===window.pagenow&&(i=$(".widgets-holder-wrap:not(#available-widgets)").find("div.widget"),i.one("click.toggle-widget-expanded",function t(){var i=$(this);e.handleWidgetAdded(new jQuery.Event("widget-added"),i)}),$(window).on("load",function(){e.setupAccessibleMode()}))})},e}(jQuery);