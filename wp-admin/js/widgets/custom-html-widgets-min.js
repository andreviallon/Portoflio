wp.customHtmlWidgets=function(e){"use strict";var t={idBases:["custom_html"],codeEditorSettings:{},l10n:{errorNotice:{singular:"",plural:""}}};return t.CustomHtmlWidgetControl=Backbone.View.extend({events:{},initialize:function e(i){var n=this;if(!i.el)throw new Error("Missing options.el");if(!i.syncContainer)throw new Error("Missing options.syncContainer");Backbone.View.prototype.initialize.call(n,i),n.syncContainer=i.syncContainer,n.widgetIdBase=n.syncContainer.parent().find(".id_base").val(),n.widgetNumber=n.syncContainer.parent().find(".widget_number").val(),n.customizeSettingId="widget_"+n.widgetIdBase+"["+String(n.widgetNumber)+"]",n.$el.addClass("custom-html-widget-fields"),n.$el.html(wp.template("widget-custom-html-control-fields")({codeEditorDisabled:t.codeEditorSettings.disabled})),n.errorNoticeContainer=n.$el.find(".code-editor-error-container"),n.currentErrorAnnotations=[],n.saveButton=n.syncContainer.add(n.syncContainer.parent().find(".widget-control-actions")).find(".widget-control-save, #savewidget"),n.saveButton.addClass("custom-html-widget-save-button"),n.fields={title:n.$el.find(".title"),content:n.$el.find(".content")},_.each(n.fields,function(e,t){e.on("input change",function i(){var o=n.syncContainer.find(".sync-input."+t);o.val()!==e.val()&&(o.val(e.val()),o.trigger("change"))}),e.val(n.syncContainer.find(".sync-input."+t).val())})},updateFields:function e(){var t=this,i;this.fields.title.is(document.activeElement)||(i=this.syncContainer.find(".sync-input.title"),this.fields.title.val(i.val())),this.contentUpdateBypassed=this.fields.content.is(document.activeElement)||this.editor&&this.editor.codemirror.state.focused||0!==this.currentErrorAnnotations,this.contentUpdateBypassed||(i=this.syncContainer.find(".sync-input.content"),this.fields.content.val(i.val()).trigger("change"))},updateErrorNotice:function(i){var n=this,o,d="",r;1===i.length?d=t.l10n.errorNotice.singular.replace("%d","1"):i.length>1&&(d=t.l10n.errorNotice.plural.replace("%d",String(i.length))),this.fields.content[0].setCustomValidity&&this.fields.content[0].setCustomValidity(d),wp.customize&&wp.customize.has(this.customizeSettingId)?((r=wp.customize(this.customizeSettingId)).notifications.remove("htmlhint_error"),0!==i.length&&r.notifications.add("htmlhint_error",new wp.customize.Notification("htmlhint_error",{message:d,type:"error"}))):0!==i.length?((o=e('<div class="inline notice notice-error notice-alt"></div>')).append(e("<p></p>",{text:d})),this.errorNoticeContainer.empty(),this.errorNoticeContainer.append(o),this.errorNoticeContainer.slideDown("fast"),wp.a11y.speak(d)):this.errorNoticeContainer.slideUp("fast")},initializeEditor:function i(){var n=this,o;t.codeEditorSettings.disabled||(o=_.extend({},t.codeEditorSettings,{onTabPrevious:function e(){n.fields.title.focus()},onTabNext:function e(){var t;n.syncContainer.add(n.syncContainer.parent().find(".widget-position, .widget-control-actions")).find(":tabbable").first().focus()},onChangeLintingErrors:function e(t){n.currentErrorAnnotations=t},onUpdateErrorNotice:function e(t){n.saveButton.toggleClass("validation-blocked disabled",t.length>0),n.updateErrorNotice(t)}}),n.editor=wp.codeEditor.initialize(n.fields.content,o),e(n.editor.codemirror.display.lineDiv).attr({role:"textbox","aria-multiline":"true","aria-labelledby":n.fields.content[0].id+"-label","aria-describedby":"editor-keyboard-trap-help-1 editor-keyboard-trap-help-2 editor-keyboard-trap-help-3 editor-keyboard-trap-help-4"}),e("#"+n.fields.content[0].id+"-label").on("click",function(){n.editor.codemirror.focus()}),n.fields.content.on("change",function(){this.value!==n.editor.codemirror.getValue()&&n.editor.codemirror.setValue(this.value)}),n.editor.codemirror.on("change",function(){var e=n.editor.codemirror.getValue();e!==n.fields.content.val()&&n.fields.content.val(e).trigger("change")}),n.editor.codemirror.on("blur",function(){n.contentUpdateBypassed&&n.syncContainer.find(".sync-input.content").trigger("change")}),wp.customize&&n.editor.codemirror.on("keydown",function e(t,i){var n=27;27===i.keyCode&&i.stopPropagation()}))}}),t.widgetControls={},t.handleWidgetAdded=function i(n,o){var d,r,a,s,l=50,c,g,u;r=(d=o.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),-1!==t.idBases.indexOf(r)&&(s=d.find(".widget-id").val(),t.widgetControls[s]||(g=e("<div></div>"),(u=o.find(".widget-content:first")).before(g),a=new t.CustomHtmlWidgetControl({el:g,syncContainer:u}),t.widgetControls[s]=a,(c=function(){(wp.customize?o.parent().hasClass("expanded"):o.hasClass("open"))?a.initializeEditor():setTimeout(c,50)})()))},t.setupAccessibleMode=function i(){var n,o,d,r,a;0!==(n=e(".editwidget > form")).length&&(o=n.find("> .widget-control-actions > .id_base").val(),-1!==t.idBases.indexOf(o)&&(r=e("<div></div>"),(a=n.find("> .widget-inside")).before(r),(d=new t.CustomHtmlWidgetControl({el:r,syncContainer:a})).initializeEditor()))},t.handleWidgetUpdated=function e(i,n){var o,d,r,a;a=(o=n.find("> .widget-inside > .form, > .widget-inside > form")).find("> .id_base").val(),-1!==t.idBases.indexOf(a)&&(d=o.find("> .widget-id").val(),(r=t.widgetControls[d])&&r.updateFields())},t.init=function i(n){var o=e(document);_.extend(t.codeEditorSettings,n),o.on("widget-added",t.handleWidgetAdded),o.on("widget-synced widget-updated",t.handleWidgetUpdated),e(function i(){var n;"widgets"===window.pagenow&&((n=e(".widgets-holder-wrap:not(#available-widgets)").find("div.widget")).one("click.toggle-widget-expanded",function i(){var n=e(this);t.handleWidgetAdded(new jQuery.Event("widget-added"),n)}),e(window).on("load",function(){t.setupAccessibleMode()}))})},t}(jQuery);