wp.customize.widgetsPreview=wp.customize.WidgetCustomizerPreview=function($,e,t,i){var r;return r={renderedSidebars:{},renderedWidgets:{},registeredSidebars:[],registeredWidgets:{},widgetSelectors:[],preview:null,l10n:{widgetTooltip:""},selectiveRefreshableWidgets:{}},r.init=function(){var t=this;t.preview=i.preview,e.isEmpty(t.selectiveRefreshableWidgets)||t.addPartials(),t.buildWidgetSelectors(),t.highlightControls(),t.preview.bind("highlight-widget",t.highlightWidget),i.preview.bind("active",function(){t.highlightControls()}),i.preview.bind("refresh-widget-partial",function(e){var r="widget["+e+"]";i.selectiveRefresh.partial.has(r)?i.selectiveRefresh.partial(r).refresh():t.renderedWidgets[e]&&i.preview.send("refresh")})},r.WidgetPartial=i.selectiveRefresh.Partial.extend({initialize:function(t,n){var a=this,d;if(!(d=t.match(/^widget\[(.+)]$/)))throw new Error("Illegal id for widget partial.");a.widgetId=d[1],a.widgetIdParts=r.parseWidgetId(a.widgetId),n=n||{},n.params=e.extend({settings:[r.getWidgetSettingId(a.widgetId)],containerInclusive:!0},n.params||{}),i.selectiveRefresh.Partial.prototype.initialize.call(a,t,n)},refresh:function(){var e=this,t;return r.selectiveRefreshableWidgets[e.widgetIdParts.idBase]?i.selectiveRefresh.Partial.prototype.refresh.call(e):(t=$.Deferred(),t.reject(),e.fallback(),t.promise())},renderContent:function(e){var t=this;i.selectiveRefresh.Partial.prototype.renderContent.call(t,e)&&(i.preview.send("widget-updated",t.widgetId),i.selectiveRefresh.trigger("widget-updated",t))}}),r.SidebarPartial=i.selectiveRefresh.Partial.extend({initialize:function(t,r){var n=this,a;if(!(a=t.match(/^sidebar\[(.+)]$/)))throw new Error("Illegal id for sidebar partial.");if(n.sidebarId=a[1],r=r||{},r.params=e.extend({settings:["sidebars_widgets["+n.sidebarId+"]"]},r.params||{}),i.selectiveRefresh.Partial.prototype.initialize.call(n,t,r),!n.params.sidebarArgs)throw new Error("The sidebarArgs param was not provided.");if(n.params.settings.length>1)throw new Error("Expected SidebarPartial to only have one associated setting")},ready:function(){var t=this;e.each(t.settings(),function(r){i(r).bind(e.bind(t.handleSettingChange,t))}),i.selectiveRefresh.bind("partial-content-rendered",function(n){n.partial.extended(r.WidgetPartial)&&-1!==e.indexOf(t.getWidgetIds(),n.partial.widgetId)&&i.selectiveRefresh.trigger("sidebar-updated",t)}),i.bind("change",function(i){var n,a;(a=r.parseWidgetSettingId(i.id))&&(n=a.idBase,a.number&&(n+="-"+String(a.number)),-1!==e.indexOf(t.getWidgetIds(),n)&&t.ensureWidgetPlacementContainers(n))})},findDynamicSidebarBoundaryNodes:function(){var t=this,i,r={},n;return i=/^(dynamic_sidebar_before|dynamic_sidebar_after):(.+):(\d+)$/,n=function(a){e.each(a,function(a){var d;if(8===a.nodeType){if(!(d=a.nodeValue.match(i))||d[2]!==t.sidebarId)return;e.isUndefined(r[d[3]])&&(r[d[3]]={before:null,after:null,instanceNumber:parseInt(d[3],10)}),"dynamic_sidebar_before"===d[1]?r[d[3]].before=a:r[d[3]].after=a}else 1===a.nodeType&&n(a.childNodes)})},n(document.body.childNodes),e.values(r)},placements:function(){var t=this;return e.map(t.findDynamicSidebarBoundaryNodes(),function(e){return new i.selectiveRefresh.Placement({partial:t,container:null,startNode:e.before,endNode:e.after,context:{instanceNumber:e.instanceNumber}})})},getWidgetIds:function(){var t=this,r,n;if(!(r=t.settings()[0]))throw new Error("Missing associated setting.");if(!i.has(r))throw new Error("Setting does not exist.");if(n=i(r).get(),!e.isArray(n))throw new Error("Expected setting to be array of widget IDs");return n.slice(0)},reflowWidgets:function(){var t=this,r,n,a,d=[];return n=t.getWidgetIds(),r=t.placements(),a={},e.each(n,function(e){var t=i.selectiveRefresh.partial("widget["+e+"]");t&&(a[e]=t)}),e.each(r,function(t){var r=[],n=!1,s,o=-1;e.each(a,function(i){e.each(i.placements(),function(e){t.context.instanceNumber===e.context.sidebar_instance_number&&(s=e.container.index(),r.push({partial:i,placement:e,position:s}),s<o&&(n=!0),o=s)})}),n&&(e.each(r,function(e){t.endNode.parentNode.insertBefore(e.placement.container[0],t.endNode),i.selectiveRefresh.trigger("partial-content-moved",e.placement)}),d.push(t))}),d.length>0&&i.selectiveRefresh.trigger("sidebar-updated",t),d},ensureWidgetPlacementContainers:function(t){var n=this,a,d=!1,s="widget["+t+"]";return a=i.selectiveRefresh.partial(s),a||(a=new r.WidgetPartial(s,{params:{}})),e.each(n.placements(),function(i){var r,s;(r=e.find(a.placements(),function(e){return e.context.sidebar_instance_number===i.context.instanceNumber}))||(s=$(n.params.sidebarArgs.before_widget.replace(/%1\$s/g,t).replace(/%2\$s/g,"widget")+n.params.sidebarArgs.after_widget),s[0]&&(s.attr("data-customize-partial-id",a.id),s.attr("data-customize-partial-type","widget"),s.attr("data-customize-widget-id",t),s.data("customize-partial-placement-context",{sidebar_id:n.sidebarId,sidebar_instance_number:i.context.instanceNumber}),i.endNode.parentNode.insertBefore(s[0],i.endNode),d=!0))}),i.selectiveRefresh.partial.add(a),d&&n.reflowWidgets(),a},handleSettingChange:function(t,n){var a=this,d,s,o,c=[];if(d=n.length>0&&0===t.length||t.length>0&&0===n.length)return void a.fallback();s=e.difference(n,t),e.each(s,function(t){var n=i.selectiveRefresh.partial("widget["+t+"]");n&&e.each(n.placements(),function(e){(e.context.sidebar_id===a.sidebarId||e.context.sidebar_args&&e.context.sidebar_args.id===a.sidebarId)&&e.container.remove()}),delete r.renderedWidgets[t]}),o=e.difference(t,n),e.each(o,function(e){var t=a.ensureWidgetPlacementContainers(e);c.push(t),r.renderedWidgets[e]=!0}),e.each(c,function(e){e.refresh()}),i.selectiveRefresh.trigger("sidebar-updated",a)},refresh:function(){var t=this,r=$.Deferred();return r.fail(function(){t.fallback()}),0===t.placements().length?r.reject():(e.each(t.reflowWidgets(),function(e){i.selectiveRefresh.trigger("partial-content-rendered",e)}),r.resolve()),r.promise()}}),i.selectiveRefresh.partialConstructor.sidebar=r.SidebarPartial,i.selectiveRefresh.partialConstructor.widget=r.WidgetPartial,r.addPartials=function(){e.each(r.registeredSidebars,function(e){var t,n="sidebar["+e.id+"]";(t=i.selectiveRefresh.partial(n))||(t=new r.SidebarPartial(n,{params:{sidebarArgs:e}}),i.selectiveRefresh.partial.add(t))})},r.buildWidgetSelectors=function(){var e=this;$.each(e.registeredSidebars,function(t,i){var r=[i.before_widget,i.before_title,i.after_title,i.after_widget].join(""),n,a,d;n=$(r),a=n.prop("tagName")||"",(d=n.prop("className")||"")&&(d=d.replace(/\S*%[12]\$s\S*/g,""),d=d.replace(/^\s+|\s+$/g,""),d&&(a+="."+d.split(/\s+/).join(".")),e.widgetSelectors.push(a))})},r.highlightWidget=function(e){var t=$(document.body),i=$("#"+e);t.find(".widget-customizer-highlighted-widget").removeClass("widget-customizer-highlighted-widget"),i.addClass("widget-customizer-highlighted-widget"),setTimeout(function(){i.removeClass("widget-customizer-highlighted-widget")},500)},r.highlightControls=function(){var e=this,t=this.widgetSelectors.join(",");i.settings.channel&&($(t).attr("title",this.l10n.widgetTooltip),$(document).on("mouseenter",t,function(){e.preview.send("highlight-widget-control",$(this).prop("id"))}),$(document).on("click",t,function(t){t.shiftKey&&(t.preventDefault(),e.preview.send("focus-widget-control",$(this).prop("id")))}))},r.parseWidgetId=function(e){var t,i={idBase:"",number:null};return t=e.match(/^(.+)-(\d+)$/),t?(i.idBase=t[1],i.number=parseInt(t[2],10)):i.idBase=e,i},r.parseWidgetSettingId=function(e){var t,i={idBase:"",number:null};return(t=e.match(/^widget_([^\[]+?)(?:\[(\d+)])?$/))?(i.idBase=t[1],t[2]&&(i.number=parseInt(t[2],10)),i):null},r.getWidgetSettingId=function(e){var t=this.parseWidgetId(e),i;return i="widget_"+t.idBase,t.number&&(i+="["+String(t.number)+"]"),i},i.bind("preview-ready",function(){$.extend(r,_wpWidgetCustomizerPreviewSettings),r.init()}),r}(jQuery,_,wp,wp.customize);