wp.customize.selectiveRefresh=function($,e){"use strict";var t,n,r;return t={ready:$.Deferred(),editShortcutVisibility:new e.Value,data:{partials:{},renderQueryVar:"",l10n:{shiftClickToEdit:""}},currentRequest:null},_.extend(t,e.Events),n=t.Partial=e.Class.extend({id:null,defaults:{selector:null,primarySetting:null,containerInclusive:!1,fallbackRefresh:!0},initialize:function(e,t){var n=this;t=t||{},n.id=e,n.params=_.extend({settings:[]},n.defaults,t.params||t),n.deferred={},n.deferred.ready=$.Deferred(),n.deferred.ready.done(function(){n.ready()})},ready:function(){var e=this;_.each(e.placements(),function(n){$(n.container).attr("title",t.data.l10n.shiftClickToEdit),e.createEditShortcutForPlacement(n)}),$(document).on("click",e.params.selector,function(t){t.shiftKey&&(t.preventDefault(),_.each(e.placements(),function(n){$(n.container).is(t.currentTarget)&&e.showControl()}))})},createEditShortcutForPlacement:function(e){var t=this,n,r,a,i;e.container&&(r=$(e.container),a="head",i="area, audio, base, bdi, bdo, br, button, canvas, col, colgroup, command, datalist, embed, head, hr, html, iframe, img, input, keygen, label, link, map, math, menu, meta, noscript, object, optgroup, option, param, progress, rp, rt, ruby, script, select, source, style, svg, table, tbody, textarea, tfoot, thead, title, tr, track, video, wbr",!r.length||r.is(i)||r.closest(a).length||(n=t.createEditShortcut(),n.on("click",function(e){e.preventDefault(),e.stopPropagation(),t.showControl()}),t.addEditShortcutToPlacement(e,n)))},addEditShortcutToPlacement:function(e,t){var n=$(e.container);n.prepend(t),n.is(":visible")&&"none"!==n.css("display")||t.addClass("customize-partial-edit-shortcut-hidden")},getEditShortcutClassName:function(){var e=this,t;return"customize-partial-edit-shortcut-"+(t=e.id.replace(/]/g,"").replace(/\[/g,"-"))},getEditShortcutTitle:function(){var e=this,n=t.data.l10n;switch(e.getType()){case"widget":return n.clickEditWidget;case"blogname":return n.clickEditTitle;case"blogdescription":return n.clickEditTitle;case"nav_menu":return n.clickEditMenu;default:return n.clickEditMisc}},getType:function(){var e=this,t;return t=e.params.primarySetting||_.first(e.settings())||"unknown",e.params.type?e.params.type:t.match(/^nav_menu_instance\[/)?"nav_menu":t.match(/^widget_.+\[\d+]$/)?"widget":t},createEditShortcut:function(){var e=this,t,n,r,a;return t=e.getEditShortcutTitle(),n=$("<span>",{class:"customize-partial-edit-shortcut "+e.getEditShortcutClassName()}),r=$("<button>",{"aria-label":t,title:t,class:"customize-partial-edit-shortcut-button"}),a=$('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M13.89 3.39l2.71 2.72c.46.46.42 1.24.03 1.64l-8.01 8.02-5.56 1.16 1.16-5.58s7.6-7.63 7.99-8.03c.39-.39 1.22-.39 1.68.07zm-2.73 2.79l-5.59 5.61 1.11 1.11 5.54-5.65zm-2.97 8.23l5.58-5.6-1.07-1.08-5.59 5.6z"/></svg>'),r.append(a),n.append(r),n},placements:function(){var e=this,t;return t=e.params.selector||"",t&&(t+=", "),t+='[data-customize-partial-id="'+e.id+'"]',$(t).map(function(){var t=$(this),n;if(n=t.data("customize-partial-placement-context"),_.isString(n)&&"{"===n.substr(0,1))throw new Error("context JSON parse error");return new r({partial:e,container:t,context:n})}).get()},settings:function(){var e=this;return e.params.settings&&0!==e.params.settings.length?e.params.settings:e.params.primarySetting?[e.params.primarySetting]:[e.id]},isRelatedSetting:function(t){var n=this;return _.isString(t)&&(t=e(t)),!!t&&-1!==_.indexOf(n.settings(),t.id)},showControl:function(){var t=this,n=t.params.primarySetting;n||(n=_.first(t.settings())),"nav_menu"===t.getType()&&(t.params.navMenuArgs.theme_location?n="nav_menu_locations["+t.params.navMenuArgs.theme_location+"]":t.params.navMenuArgs.menu&&(n="nav_menu["+String(t.params.navMenuArgs.menu)+"]")),e.preview.send("focus-control-for-setting",n)},preparePlacement:function(e){$(e.container).addClass("customize-partial-refreshing")},_pendingRefreshPromise:null,refresh:function(){var e=this,n;return n=t.requestPartial(e),e._pendingRefreshPromise||(_.each(e.placements(),function(t){e.preparePlacement(t)}),n.done(function(t){_.each(t,function(t){e.renderContent(t)})}),n.fail(function(t,n){e.fallback(t,n)}),e._pendingRefreshPromise=n,n.always(function(){e._pendingRefreshPromise=null})),n},renderContent:function(e){var n=this,r,a;if(!e.container)return n.fallback(new Error("no_container"),[e]),!1;if(e.container=$(e.container),!1===e.addedContent)return n.fallback(new Error("missing_render"),[e]),!1;if(!_.isString(e.addedContent))return n.fallback(new Error("non_string_content"),[e]),!1;t.orginalDocumentWrite=document.write,document.write=function(){throw new Error(t.data.l10n.badDocumentWrite)};try{if(r=e.addedContent,wp.emoji&&wp.emoji.parse&&!$.contains(document.head,e.container[0])&&(r=wp.emoji.parse(r)),n.params.containerInclusive)a=$(r),e.context=_.extend(e.context,a.data("customize-partial-placement-context")||{}),a.data("customize-partial-placement-context",e.context),e.removedNodes=e.container,e.container=a,e.removedNodes.replaceWith(e.container),e.container.attr("title",t.data.l10n.shiftClickToEdit);else{for(e.removedNodes=document.createDocumentFragment();e.container[0].firstChild;)e.removedNodes.appendChild(e.container[0].firstChild);e.container.html(r)}e.container.removeClass("customize-render-content-error")}catch(t){"undefined"!=typeof console&&console.error&&console.error(n.id,t),n.fallback(t,[e])}return document.write=t.orginalDocumentWrite,t.orginalDocumentWrite=null,n.createEditShortcutForPlacement(e),e.container.removeClass("customize-partial-refreshing"),e.container.data("customize-partial-content-rendered",!0),wp.mediaelement&&wp.mediaelement.initialize(),t.trigger("partial-content-rendered",e),!0},fallback:function(){this.params.fallbackRefresh&&t.requestFullRefresh()}}),t.Placement=r=e.Class.extend({partial:null,container:null,startNode:null,endNode:null,context:null,addedContent:null,removedNodes:null,initialize:function(e){var t=this;if(e=_.extend({},e||{}),!e.partial||!e.partial.extended(n))throw new Error("Missing partial");e.context=e.context||{},e.container&&(e.container=$(e.container)),_.extend(t,e)}}),t.partialConstructor={},t.partial=new e.Values({defaultConstructor:n}),t.getCustomizeQuery=function(){var t={};return e.each(function(e,n){e._dirty&&(t[n]=e())}),{wp_customize:"on",nonce:e.settings.nonce.preview,customize_theme:e.settings.theme.stylesheet,customized:JSON.stringify(t),customize_changeset_uuid:e.settings.changeset.uuid}},t._pendingPartialRequests={},t._debouncedTimeoutId=null,t._currentRequest=null,t.requestFullRefresh=function(){e.preview.send("refresh")},t.requestPartial=function(n){var a;return t._debouncedTimeoutId&&(clearTimeout(t._debouncedTimeoutId),t._debouncedTimeoutId=null),t._currentRequest&&(t._currentRequest.abort(),t._currentRequest=null),a=t._pendingPartialRequests[n.id],a&&"pending"===a.deferred.state()||(a={deferred:$.Deferred(),partial:n},t._pendingPartialRequests[n.id]=a),n=null,t._debouncedTimeoutId=setTimeout(function(){var n,a,i,o;t._debouncedTimeoutId=null,n=t.getCustomizeQuery(),i={},a={},_.each(t._pendingPartialRequests,function(e,n){i[n]=e.partial.placements(),t.partial.has(n)?a[n]=_.map(i[n],function(e){return e.context||{}}):e.deferred.rejectWith(e.partial,[new Error("partial_removed"),i[n]])}),n.partials=JSON.stringify(a),n[t.data.renderQueryVar]="1",o=t._currentRequest=wp.ajax.send(null,{data:n,url:e.settings.url.self}),o.done(function(e){t.trigger("render-partials-response",e),e.errors&&"undefined"!=typeof console&&console.warn&&_.each(e.errors,function(e){console.warn(e)}),_.each(t._pendingPartialRequests,function(t,n){var a;_.isArray(e.contents[n])?(a=_.map(e.contents[n],function(e,a){var o=i[n][a];return o?o.addedContent=e:o=new r({partial:t.partial,addedContent:e}),o}),t.deferred.resolveWith(t.partial,[a])):t.deferred.rejectWith(t.partial,[new Error("unrecognized_partial"),i[n]])}),t._pendingPartialRequests={}}),o.fail(function(e,n){"abort"!==n&&(_.each(t._pendingPartialRequests,function(t,n){t.deferred.rejectWith(t.partial,[e,i[n]])}),t._pendingPartialRequests={})})},e.settings.timeouts.selectiveRefresh),a.deferred.promise()},t.addPartials=function(e,n){var a;e||(e=document.documentElement),e=$(e),n=_.extend({triggerRendered:!0},n||{}),a=e.find("[data-customize-partial-id]"),e.is("[data-customize-partial-id]")&&(a=a.add(e)),a.each(function(){var e=$(this),a,i,o,s,c,d;(o=e.data("customize-partial-id"))&&(d=e.data("customize-partial-placement-context")||{},a=t.partial(o),a||(c=e.data("customize-partial-options")||{},c.constructingContainerContext=e.data("customize-partial-placement-context")||{},s=t.partialConstructor[e.data("customize-partial-type")]||t.Partial,a=new s(o,c),t.partial.add(a)),n.triggerRendered&&!e.data("customize-partial-content-rendered")&&(i=new r({partial:a,context:d,container:e}),$(i.container).attr("title",t.data.l10n.shiftClickToEdit),a.createEditShortcutForPlacement(i),t.trigger("partial-content-rendered",i)),e.data("customize-partial-content-rendered",!0))})},e.bind("preview-ready",function(){var n,r,a;_.extend(t.data,_customizePartialRefreshExports),_.each(t.data.partials,function(e,n){var r,a=t.partial(n);a?_.extend(a.params,e):(r=t.partialConstructor[e.type]||t.Partial,a=new r(n,_.extend({params:e},e)),t.partial.add(a))}),n=function(e,n){var r=this;t.partial.each(function(t){t.isRelatedSetting(r,e,n)&&t.refresh()})},r=function(e){n.call(e,e(),null),e.bind(n)},a=function(e){n.call(e,null,e()),e.unbind(n)},e.bind("add",r),e.bind("remove",a),e.each(function(e){e.bind(n)}),t.addPartials(document.documentElement,{triggerRendered:!1}),"undefined"!=typeof MutationObserver&&(t.mutationObserver=new MutationObserver(function(e){_.each(e,function(e){t.addPartials($(e.target))})}),t.mutationObserver.observe(document.documentElement,{childList:!0,subtree:!0})),e.selectiveRefresh.bind("partial-content-rendered",function(e){e.container&&t.addPartials(e.container)}),e.selectiveRefresh.bind("render-partials-response",function t(n){n.setting_validities&&e.preview.send("selective-refresh-setting-validities",n.setting_validities)}),e.preview.bind("edit-shortcut-visibility",function(t){e.selectiveRefresh.editShortcutVisibility.set(t)}),e.selectiveRefresh.editShortcutVisibility.bind(function(e){var t=$(document.body),n;n="hidden"===e&&t.hasClass("customize-partial-edit-shortcuts-shown")&&!t.hasClass("customize-partial-edit-shortcuts-hidden"),t.toggleClass("customize-partial-edit-shortcuts-hidden",n),t.toggleClass("customize-partial-edit-shortcuts-shown","visible"===e)}),e.preview.bind("active",function(){t.partial.each(function(e){e.deferred.ready.resolve()}),t.partial.bind("add",function(e){e.deferred.ready.resolve()})})}),t}(jQuery,wp.customize);