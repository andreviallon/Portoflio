wp.customize.selectiveRefresh=function(e,t){"use strict";var n,i,r;return n={ready:e.Deferred(),editShortcutVisibility:new t.Value,data:{partials:{},renderQueryVar:"",l10n:{shiftClickToEdit:""}},currentRequest:null},_.extend(n,t.Events),i=n.Partial=t.Class.extend({id:null,defaults:{selector:null,primarySetting:null,containerInclusive:!1,fallbackRefresh:!0},initialize:function(t,n){var i=this;n=n||{},i.id=t,i.params=_.extend({settings:[]},i.defaults,n.params||n),i.deferred={},i.deferred.ready=e.Deferred(),i.deferred.ready.done(function(){i.ready()})},ready:function(){var t=this;_.each(t.placements(),function(i){e(i.container).attr("title",n.data.l10n.shiftClickToEdit),t.createEditShortcutForPlacement(i)}),e(document).on("click",t.params.selector,function(n){n.shiftKey&&(n.preventDefault(),_.each(t.placements(),function(i){e(i.container).is(n.currentTarget)&&t.showControl()}))})},createEditShortcutForPlacement:function(t){var n=this,i,r,a,s;t.container&&(a="head",s="area, audio, base, bdi, bdo, br, button, canvas, col, colgroup, command, datalist, embed, head, hr, html, iframe, img, input, keygen, label, link, map, math, menu, meta, noscript, object, optgroup, option, param, progress, rp, rt, ruby, script, select, source, style, svg, table, tbody, textarea, tfoot, thead, title, tr, track, video, wbr",!(r=e(t.container)).length||r.is(s)||r.closest("head").length||((i=n.createEditShortcut()).on("click",function(e){e.preventDefault(),e.stopPropagation(),n.showControl()}),n.addEditShortcutToPlacement(t,i)))},addEditShortcutToPlacement:function(t,n){var i=e(t.container);i.prepend(n),i.is(":visible")&&"none"!==i.css("display")||n.addClass("customize-partial-edit-shortcut-hidden")},getEditShortcutClassName:function(){var e=this,t;return"customize-partial-edit-shortcut-"+(t=this.id.replace(/]/g,"").replace(/\[/g,"-"))},getEditShortcutTitle:function(){var e=this,t=n.data.l10n;switch(this.getType()){case"widget":return t.clickEditWidget;case"blogname":return t.clickEditTitle;case"blogdescription":return t.clickEditTitle;case"nav_menu":return t.clickEditMenu;default:return t.clickEditMisc}},getType:function(){var e=this,t;return t=this.params.primarySetting||_.first(this.settings())||"unknown",this.params.type?this.params.type:t.match(/^nav_menu_instance\[/)?"nav_menu":t.match(/^widget_.+\[\d+]$/)?"widget":t},createEditShortcut:function(){var t=this,n,i,r,a;return n=this.getEditShortcutTitle(),i=e("<span>",{class:"customize-partial-edit-shortcut "+this.getEditShortcutClassName()}),r=e("<button>",{"aria-label":n,title:n,class:"customize-partial-edit-shortcut-button"}),a=e('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M13.89 3.39l2.71 2.72c.46.46.42 1.24.03 1.64l-8.01 8.02-5.56 1.16 1.16-5.58s7.6-7.63 7.99-8.03c.39-.39 1.22-.39 1.68.07zm-2.73 2.79l-5.59 5.61 1.11 1.11 5.54-5.65zm-2.97 8.23l5.58-5.6-1.07-1.08-5.59 5.6z"/></svg>'),r.append(a),i.append(r),i},placements:function(){var t=this,n;return(n=t.params.selector||"")&&(n+=", "),n+='[data-customize-partial-id="'+t.id+'"]',e(n).map(function(){var n=e(this),i;if(i=n.data("customize-partial-placement-context"),_.isString(i)&&"{"===i.substr(0,1))throw new Error("context JSON parse error");return new r({partial:t,container:n,context:i})}).get()},settings:function(){var e=this;return this.params.settings&&0!==this.params.settings.length?this.params.settings:this.params.primarySetting?[this.params.primarySetting]:[this.id]},isRelatedSetting:function(e){var n=this;return _.isString(e)&&(e=t(e)),!!e&&-1!==_.indexOf(this.settings(),e.id)},showControl:function(){var e=this,n=this.params.primarySetting;n||(n=_.first(this.settings())),"nav_menu"===this.getType()&&(this.params.navMenuArgs.theme_location?n="nav_menu_locations["+this.params.navMenuArgs.theme_location+"]":this.params.navMenuArgs.menu&&(n="nav_menu["+String(this.params.navMenuArgs.menu)+"]")),t.preview.send("focus-control-for-setting",n)},preparePlacement:function(t){e(t.container).addClass("customize-partial-refreshing")},_pendingRefreshPromise:null,refresh:function(){var e=this,t;return t=n.requestPartial(e),e._pendingRefreshPromise||(_.each(e.placements(),function(t){e.preparePlacement(t)}),t.done(function(t){_.each(t,function(t){e.renderContent(t)})}),t.fail(function(t,n){e.fallback(t,n)}),e._pendingRefreshPromise=t,t.always(function(){e._pendingRefreshPromise=null})),t},renderContent:function(t){var i=this,r,a;if(!t.container)return this.fallback(new Error("no_container"),[t]),!1;if(t.container=e(t.container),!1===t.addedContent)return this.fallback(new Error("missing_render"),[t]),!1;if(!_.isString(t.addedContent))return this.fallback(new Error("non_string_content"),[t]),!1;n.orginalDocumentWrite=document.write,document.write=function(){throw new Error(n.data.l10n.badDocumentWrite)};try{if(r=t.addedContent,wp.emoji&&wp.emoji.parse&&!e.contains(document.head,t.container[0])&&(r=wp.emoji.parse(r)),this.params.containerInclusive)a=e(r),t.context=_.extend(t.context,a.data("customize-partial-placement-context")||{}),a.data("customize-partial-placement-context",t.context),t.removedNodes=t.container,t.container=a,t.removedNodes.replaceWith(t.container),t.container.attr("title",n.data.l10n.shiftClickToEdit);else{for(t.removedNodes=document.createDocumentFragment();t.container[0].firstChild;)t.removedNodes.appendChild(t.container[0].firstChild);t.container.html(r)}t.container.removeClass("customize-render-content-error")}catch(e){"undefined"!=typeof console&&console.error&&console.error(this.id,e),this.fallback(e,[t])}return document.write=n.orginalDocumentWrite,n.orginalDocumentWrite=null,this.createEditShortcutForPlacement(t),t.container.removeClass("customize-partial-refreshing"),t.container.data("customize-partial-content-rendered",!0),wp.mediaelement&&wp.mediaelement.initialize(),wp.playlist&&wp.playlist.initialize(),n.trigger("partial-content-rendered",t),!0},fallback:function(){var e=this;this.params.fallbackRefresh&&n.requestFullRefresh()}}),n.Placement=r=t.Class.extend({partial:null,container:null,startNode:null,endNode:null,context:null,addedContent:null,removedNodes:null,initialize:function(t){var n=this;if(!(t=_.extend({},t||{})).partial||!t.partial.extended(i))throw new Error("Missing partial");t.context=t.context||{},t.container&&(t.container=e(t.container)),_.extend(this,t)}}),n.partialConstructor={},n.partial=new t.Values({defaultConstructor:i}),n.getCustomizeQuery=function(){var e={};return t.each(function(t,n){t._dirty&&(e[n]=t())}),{wp_customize:"on",nonce:t.settings.nonce.preview,customize_theme:t.settings.theme.stylesheet,customized:JSON.stringify(e),customize_changeset_uuid:t.settings.changeset.uuid}},n._pendingPartialRequests={},n._debouncedTimeoutId=null,n._currentRequest=null,n.requestFullRefresh=function(){t.preview.send("refresh")},n.requestPartial=function(i){var a;return n._debouncedTimeoutId&&(clearTimeout(n._debouncedTimeoutId),n._debouncedTimeoutId=null),n._currentRequest&&(n._currentRequest.abort(),n._currentRequest=null),(a=n._pendingPartialRequests[i.id])&&"pending"===a.deferred.state()||(a={deferred:e.Deferred(),partial:i},n._pendingPartialRequests[i.id]=a),i=null,n._debouncedTimeoutId=setTimeout(function(){var e,i,a,s;n._debouncedTimeoutId=null,e=n.getCustomizeQuery(),a={},i={},_.each(n._pendingPartialRequests,function(e,t){a[t]=e.partial.placements(),n.partial.has(t)?i[t]=_.map(a[t],function(e){return e.context||{}}):e.deferred.rejectWith(e.partial,[new Error("partial_removed"),a[t]])}),e.partials=JSON.stringify(i),e[n.data.renderQueryVar]="1",(s=n._currentRequest=wp.ajax.send(null,{data:e,url:t.settings.url.self})).done(function(e){n.trigger("render-partials-response",e),e.errors&&"undefined"!=typeof console&&console.warn&&_.each(e.errors,function(e){console.warn(e)}),_.each(n._pendingPartialRequests,function(t,n){var i;_.isArray(e.contents[n])?(i=_.map(e.contents[n],function(e,i){var s=a[n][i];return s?s.addedContent=e:s=new r({partial:t.partial,addedContent:e}),s}),t.deferred.resolveWith(t.partial,[i])):t.deferred.rejectWith(t.partial,[new Error("unrecognized_partial"),a[n]])}),n._pendingPartialRequests={}}),s.fail(function(e,t){"abort"!==t&&(_.each(n._pendingPartialRequests,function(t,n){t.deferred.rejectWith(t.partial,[e,a[n]])}),n._pendingPartialRequests={})})},t.settings.timeouts.selectiveRefresh),a.deferred.promise()},n.addPartials=function(t,i){var a;t||(t=document.documentElement),t=e(t),i=_.extend({triggerRendered:!0},i||{}),a=t.find("[data-customize-partial-id]"),t.is("[data-customize-partial-id]")&&(a=a.add(t)),a.each(function(){var t=e(this),a,s,o,c,d,l;(o=t.data("customize-partial-id"))&&(l=t.data("customize-partial-placement-context")||{},(a=n.partial(o))||((d=t.data("customize-partial-options")||{}).constructingContainerContext=t.data("customize-partial-placement-context")||{},a=new(c=n.partialConstructor[t.data("customize-partial-type")]||n.Partial)(o,d),n.partial.add(a)),i.triggerRendered&&!t.data("customize-partial-content-rendered")&&(s=new r({partial:a,context:l,container:t}),e(s.container).attr("title",n.data.l10n.shiftClickToEdit),a.createEditShortcutForPlacement(s),n.trigger("partial-content-rendered",s)),t.data("customize-partial-content-rendered",!0))})},t.bind("preview-ready",function(){var i,r,a;_.extend(n.data,_customizePartialRefreshExports),_.each(n.data.partials,function(e,t){var i,r=n.partial(t);r?_.extend(r.params,e):(r=new(i=n.partialConstructor[e.type]||n.Partial)(t,_.extend({params:e},e)),n.partial.add(r))}),i=function(e,t){var i=this;n.partial.each(function(n){n.isRelatedSetting(i,e,t)&&n.refresh()})},r=function(e){i.call(e,e(),null),e.bind(i)},a=function(e){i.call(e,null,e()),e.unbind(i)},t.bind("add",r),t.bind("remove",a),t.each(function(e){e.bind(i)}),n.addPartials(document.documentElement,{triggerRendered:!1}),"undefined"!=typeof MutationObserver&&(n.mutationObserver=new MutationObserver(function(t){_.each(t,function(t){n.addPartials(e(t.target))})}),n.mutationObserver.observe(document.documentElement,{childList:!0,subtree:!0})),t.selectiveRefresh.bind("partial-content-rendered",function(e){e.container&&n.addPartials(e.container)}),t.selectiveRefresh.bind("render-partials-response",function e(n){n.setting_validities&&t.preview.send("selective-refresh-setting-validities",n.setting_validities)}),t.preview.bind("edit-shortcut-visibility",function(e){t.selectiveRefresh.editShortcutVisibility.set(e)}),t.selectiveRefresh.editShortcutVisibility.bind(function(t){var n=e(document.body),i;i="hidden"===t&&n.hasClass("customize-partial-edit-shortcuts-shown")&&!n.hasClass("customize-partial-edit-shortcuts-hidden"),n.toggleClass("customize-partial-edit-shortcuts-hidden",i),n.toggleClass("customize-partial-edit-shortcuts-shown","visible"===t)}),t.preview.bind("active",function(){n.partial.each(function(e){e.deferred.ready.resolve()}),n.partial.bind("add",function(e){e.deferred.ready.resolve()})})}),n}(jQuery,wp.customize);