wp.customize.widgetsPreview=wp.customize.WidgetCustomizerPreview=function(e,t,i,r){var a;return(a={renderedSidebars:{},renderedWidgets:{},registeredSidebars:[],registeredWidgets:{},widgetSelectors:[],preview:null,l10n:{widgetTooltip:""},selectiveRefreshableWidgets:{}}).init=function(){var e=this;e.preview=r.preview,t.isEmpty(e.selectiveRefreshableWidgets)||e.addPartials(),e.buildWidgetSelectors(),e.highlightControls(),e.preview.bind("highlight-widget",e.highlightWidget),r.preview.bind("active",function(){e.highlightControls()}),r.preview.bind("refresh-widget-partial",function(t){var i="widget["+t+"]";r.selectiveRefresh.partial.has(i)?r.selectiveRefresh.partial(i).refresh():e.renderedWidgets[t]&&r.preview.send("refresh")})},a.WidgetPartial=r.selectiveRefresh.Partial.extend({initialize:function(e,i){var n,d=this;if(!(n=e.match(/^widget\[(.+)]$/)))throw new Error("Illegal id for widget partial.");d.widgetId=n[1],d.widgetIdParts=a.parseWidgetId(d.widgetId),(i=i||{}).params=t.extend({settings:[a.getWidgetSettingId(d.widgetId)],containerInclusive:!0},i.params||{}),r.selectiveRefresh.Partial.prototype.initialize.call(d,e,i)},refresh:function(){var t,i=this;return a.selectiveRefreshableWidgets[i.widgetIdParts.idBase]?r.selectiveRefresh.Partial.prototype.refresh.call(i):((t=e.Deferred()).reject(),i.fallback(),t.promise())},renderContent:function(e){var t=this;r.selectiveRefresh.Partial.prototype.renderContent.call(t,e)&&(r.preview.send("widget-updated",t.widgetId),r.selectiveRefresh.trigger("widget-updated",t))}}),a.SidebarPartial=r.selectiveRefresh.Partial.extend({initialize:function(e,i){var a,n=this;if(!(a=e.match(/^sidebar\[(.+)]$/)))throw new Error("Illegal id for sidebar partial.");if(n.sidebarId=a[1],(i=i||{}).params=t.extend({settings:["sidebars_widgets["+n.sidebarId+"]"]},i.params||{}),r.selectiveRefresh.Partial.prototype.initialize.call(n,e,i),!n.params.sidebarArgs)throw new Error("The sidebarArgs param was not provided.");if(n.params.settings.length>1)throw new Error("Expected SidebarPartial to only have one associated setting")},ready:function(){var e=this;t.each(e.settings(),function(i){r(i).bind(t.bind(e.handleSettingChange,e))}),r.selectiveRefresh.bind("partial-content-rendered",function(i){var n;i.partial.extended(a.WidgetPartial)&&-1!==t.indexOf(e.getWidgetIds(),i.partial.widgetId)&&r.selectiveRefresh.trigger("sidebar-updated",e)}),r.bind("change",function(i){var r,n;(n=a.parseWidgetSettingId(i.id))&&(r=n.idBase,n.number&&(r+="-"+String(n.number)),-1!==t.indexOf(e.getWidgetIds(),r)&&e.ensureWidgetPlacementContainers(r))})},findDynamicSidebarBoundaryNodes:function(){var e,i,r=this,a={};return e=/^(dynamic_sidebar_before|dynamic_sidebar_after):(.+):(\d+)$/,(i=function(n){t.each(n,function(n){var d;if(8===n.nodeType){if(!(d=n.nodeValue.match(e))||d[2]!==r.sidebarId)return;t.isUndefined(a[d[3]])&&(a[d[3]]={before:null,after:null,instanceNumber:parseInt(d[3],10)}),"dynamic_sidebar_before"===d[1]?a[d[3]].before=n:a[d[3]].after=n}else 1===n.nodeType&&i(n.childNodes)})})(document.body.childNodes),t.values(a)},placements:function(){var e=this;return t.map(e.findDynamicSidebarBoundaryNodes(),function(t){return new r.selectiveRefresh.Placement({partial:e,container:null,startNode:t.before,endNode:t.after,context:{instanceNumber:t.instanceNumber}})})},getWidgetIds:function(){var e,i,a;if(!(e=this.settings()[0]))throw new Error("Missing associated setting.");if(!r.has(e))throw new Error("Setting does not exist.");if(i=r(e).get(),!t.isArray(i))throw new Error("Expected setting to be array of widget IDs");return i.slice(0)},reflowWidgets:function(){var e,i,a,n=this,d=[];return i=n.getWidgetIds(),e=n.placements(),a={},t.each(i,function(e){var t=r.selectiveRefresh.partial("widget["+e+"]");t&&(a[e]=t)}),t.each(e,function(e){var i,n=[],s=!1,o=-1;t.each(a,function(r){t.each(r.placements(),function(t){e.context.instanceNumber===t.context.sidebar_instance_number&&(i=t.container.index(),n.push({partial:r,placement:t,position:i}),i<o&&(s=!0),o=i)})}),s&&(t.each(n,function(t){e.endNode.parentNode.insertBefore(t.placement.container[0],e.endNode),r.selectiveRefresh.trigger("partial-content-moved",t.placement)}),d.push(e))}),d.length>0&&r.selectiveRefresh.trigger("sidebar-updated",n),d},ensureWidgetPlacementContainers:function(i){var n,d=this,s=!1,o="widget["+i+"]";return(n=r.selectiveRefresh.partial(o))||(n=new a.WidgetPartial(o,{params:{}})),t.each(d.placements(),function(r){var a,o;(a=t.find(n.placements(),function(e){return e.context.sidebar_instance_number===r.context.instanceNumber}))||(o=e(d.params.sidebarArgs.before_widget.replace(/%1\$s/g,i).replace(/%2\$s/g,"widget")+d.params.sidebarArgs.after_widget))[0]&&(o.attr("data-customize-partial-id",n.id),o.attr("data-customize-partial-type","widget"),o.attr("data-customize-widget-id",i),o.data("customize-partial-placement-context",{sidebar_id:d.sidebarId,sidebar_instance_number:r.context.instanceNumber}),r.endNode.parentNode.insertBefore(o[0],r.endNode),s=!0)}),r.selectiveRefresh.partial.add(n),s&&d.reflowWidgets(),n},handleSettingChange:function(e,i){var n,d,s,o=this,c=[];return(n=i.length>0&&0===e.length||e.length>0&&0===i.length)?void o.fallback():(d=t.difference(i,e),t.each(d,function(e){var i=r.selectiveRefresh.partial("widget["+e+"]");i&&t.each(i.placements(),function(e){var t;(e.context.sidebar_id===o.sidebarId||e.context.sidebar_args&&e.context.sidebar_args.id===o.sidebarId)&&e.container.remove()}),delete a.renderedWidgets[e]}),s=t.difference(e,i),t.each(s,function(e){var t=o.ensureWidgetPlacementContainers(e);c.push(t),a.renderedWidgets[e]=!0}),t.each(c,function(e){e.refresh()}),void r.selectiveRefresh.trigger("sidebar-updated",o))},refresh:function(){var i=this,a=e.Deferred();return a.fail(function(){i.fallback()}),0===i.placements().length?a.reject():(t.each(i.reflowWidgets(),function(e){r.selectiveRefresh.trigger("partial-content-rendered",e)}),a.resolve()),a.promise()}}),r.selectiveRefresh.partialConstructor.sidebar=a.SidebarPartial,r.selectiveRefresh.partialConstructor.widget=a.WidgetPartial,a.addPartials=function(){t.each(a.registeredSidebars,function(e){var t,i="sidebar["+e.id+"]";(t=r.selectiveRefresh.partial(i))||(t=new a.SidebarPartial(i,{params:{sidebarArgs:e}}),r.selectiveRefresh.partial.add(t))})},a.buildWidgetSelectors=function(){var t=this;e.each(t.registeredSidebars,function(i,r){var a,n,d,s=[r.before_widget,r.before_title,r.after_title,r.after_widget].join("");n=(a=e(s)).prop("tagName")||"",(d=a.prop("className")||"")&&((d=(d=d.replace(/\S*%[12]\$s\S*/g,"")).replace(/^\s+|\s+$/g,""))&&(n+="."+d.split(/\s+/).join(".")),t.widgetSelectors.push(n))})},a.highlightWidget=function(t){var i=e(document.body),r=e("#"+t);i.find(".widget-customizer-highlighted-widget").removeClass("widget-customizer-highlighted-widget"),r.addClass("widget-customizer-highlighted-widget"),setTimeout(function(){r.removeClass("widget-customizer-highlighted-widget")},500)},a.highlightControls=function(){var t=this,i=this.widgetSelectors.join(",");r.settings.channel&&(e(i).attr("title",this.l10n.widgetTooltip),e(document).on("mouseenter",i,function(){t.preview.send("highlight-widget-control",e(this).prop("id"))}),e(document).on("click",i,function(i){i.shiftKey&&(i.preventDefault(),t.preview.send("focus-widget-control",e(this).prop("id")))}))},a.parseWidgetId=function(e){var t,i={idBase:"",number:null};return(t=e.match(/^(.+)-(\d+)$/))?(i.idBase=t[1],i.number=parseInt(t[2],10)):i.idBase=e,i},a.parseWidgetSettingId=function(e){var t,i={idBase:"",number:null};return(t=e.match(/^widget_([^\[]+?)(?:\[(\d+)])?$/))?(i.idBase=t[1],t[2]&&(i.number=parseInt(t[2],10)),i):null},a.getWidgetSettingId=function(e){var t,i=this.parseWidgetId(e);return t="widget_"+i.idBase,i.number&&(t+="["+String(i.number)+"]"),t},r.bind("preview-ready",function(){e.extend(a,_wpWidgetCustomizerPreviewSettings),a.init()}),a}(jQuery,_,wp,wp.customize);