tinymce.PluginManager.add("wpeditimage",function(e){function t(t){return!(!e.dom.getAttrib(t,"data-mce-placeholder")&&!e.dom.getAttrib(t,"data-mce-object"))}function n(t){var n=e.$(t).parents("[contenteditable]");return n&&"false"===n.attr("contenteditable")}function a(t){return t.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(t,n,a){var i,o,r,c,l,d;return(i=n.match(/id=['"]([^'"]*)['"] ?/))&&(n=n.replace(i[0],"")),(o=n.match(/align=['"]([^'"]*)['"] ?/))&&(n=n.replace(o[0],"")),(r=n.match(/class=['"]([^'"]*)['"] ?/))&&(n=n.replace(r[0],"")),(d=n.match(/width=['"]([0-9]*)['"] ?/))&&(n=n.replace(d[0],"")),(l=(a=h(a)).match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&l[2]?(c=h(l[2]),l=h(l[1])):(c=h(n).replace(/caption=['"]/,"").replace(/['"]$/,""),l=a),i=i&&i[1]?i[1].replace(/[<>&]+/g,""):"",o=o&&o[1]?o[1]:"alignnone",r=r&&r[1]?" "+r[1].replace(/[<>&]+/g,""):"",!d&&l&&(d=l.match(/width=['"]([0-9]*)['"]/)),d&&d[1]&&(d=d[1]),d&&c?(d=parseInt(d,10),e.getParam("wpeditimage_html5_captions")||(d+=10),'<div class="mceTemp"><dl id="'+i+'" class="wp-caption '+o+r+'" style="width: '+d+'px"><dt class="wp-caption-dt">'+l+'</dt><dd class="wp-caption-dd">'+c+"</dd></dl></div>"):a})}function i(e){return e.replace(/(?:<div [^>]+mceTemp[^>]+>)?\s*(<dl [^>]+wp-caption[^>]+>[\s\S]+?<\/dl>)\s*(?:<\/div>)?/g,function(e,t){var n="";return-1===t.indexOf("<img ")||-1!==t.indexOf("</p>")?t.replace(/<d[ldt]( [^>]+)?>/g,"").replace(/<\/d[ldt]>/g,""):(-1===(n=t.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(e,t,n,a){var i,o,r,c;return c=(c=n.match(/width="([0-9]*)"/))&&c[1]?c[1]:"",r=(o=(o=t.match(/class="([^"]*)"/))&&o[1]?o[1]:"").match(/align[a-z]+/i)||"alignnone",c&&a?(i=(i=t.match(/id="([^"]*)"/))&&i[1]?i[1]:"",(o=o.replace(/wp-caption ?|align[a-z]+ ?/gi,""))&&(o=' class="'+o+'"'),'[caption id="'+i+'" align="'+r+'" width="'+c+'"'+o+"]"+n+" "+(a=(a=a.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(e){return e.replace(/[\r\n\t]+/," ")})).replace(/\s*\n\s*/g,"<br />"))+"[/caption]"):("alignnone"!==r[0]&&(n=n.replace(/><img/,' class="'+r[0]+'"><img')),n)})).indexOf("[caption")&&(n=t.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2")),n)})}function o(t){var n,a,i,o,r,c,l,d,s=[],m=e.dom,p=/^\d+$/;return(i={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""}).url=m.getAttrib(t,"src"),i.alt=m.getAttrib(t,"alt"),i.title=m.getAttrib(t,"title"),l=m.getAttrib(t,"width"),d=m.getAttrib(t,"height"),(!p.test(l)||parseInt(l,10)<1)&&(l=t.naturalWidth||t.width),(!p.test(d)||parseInt(d,10)<1)&&(d=t.naturalHeight||t.height),i.customWidth=i.width=l,i.customHeight=i.height=d,n=tinymce.explode(t.className," "),a=[],tinymce.each(n,function(e){/^wp-image/.test(e)?i.attachment_id=parseInt(e.replace("wp-image-",""),10):/^align/.test(e)?i.align=e.replace("align",""):/^size/.test(e)?i.size=e.replace("size-",""):a.push(e)}),i.extraClasses=a.join(" "),(o=m.getParents(t,".wp-caption")).length&&(n=(o=o[0]).className.split(" "),tinymce.each(n,function(e){/^align/.test(e)?i.align=e.replace("align",""):e&&"wp-caption"!==e&&s.push(e)}),i.captionClassName=s.join(" "),(r=m.select("dd.wp-caption-dd",o)).length&&(r=r[0],i.caption=e.serializer.serialize(r).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,""))),t.parentNode&&"A"===t.parentNode.nodeName&&(c=t.parentNode,i.linkUrl=m.getAttrib(c,"href"),i.linkTargetBlank="_blank"===m.getAttrib(c,"target"),i.linkRel=m.getAttrib(c,"rel"),i.linkClassName=c.className),i}function r(e){return e&&!!(e.textContent||e.innerText).replace(/\ufeff/g,"")}function c(t){return!t||-1===t.indexOf("<")&&-1===t.indexOf(">")?t:(p||(p=new tinymce.html.Serializer({},e.schema)),p.serialize(e.parser.parse(t,{forced_root_block:!1})))}function l(t,n){var a,i,o,l,d,s,m,p,g,u,f,h,w,v,N,b,_,C,y,A=e.dom;(a=tinymce.explode(n.extraClasses," "))||(a=[]),n.caption||a.push("align"+n.align),n.attachment_id&&(a.push("wp-image-"+n.attachment_id),n.size&&"custom"!==n.size&&a.push("size-"+n.size)),v=n.width,N=n.height,"custom"===n.size&&(v=n.customWidth,N=n.customHeight),h={src:n.url,width:v||null,height:N||null,title:n.title||null,class:a.join(" ")||null},A.setAttribs(t,h),e.$(t).attr("alt",n.alt||""),w={href:n.linkUrl,rel:n.linkRel||null,target:n.linkTargetBlank?"_blank":null,class:n.linkClassName||null},t.parentNode&&"A"===t.parentNode.nodeName&&!r(t.parentNode)?n.linkUrl?A.setAttribs(t.parentNode,w):A.remove(t.parentNode,!0):n.linkUrl&&((m=A.getParent(t,"a"))&&A.insertAfter(t,m),m=A.create("a",w),t.parentNode.insertBefore(m,t),m.appendChild(t)),p=e.dom.getParent(t,".mceTemp"),o=t.parentNode&&"A"===t.parentNode.nodeName&&!r(t.parentNode)?t.parentNode:t,n.caption?(n.caption=c(n.caption),f=n.attachment_id?"attachment_"+n.attachment_id:null,i="wp-caption "+(b="align"+(n.align||"none")),n.captionClassName&&(i+=" "+n.captionClassName.replace(/[<>&]+/g,"")),e.getParam("wpeditimage_html5_captions")||(v=parseInt(v,10),v+=10),p?((u=A.select("dl.wp-caption",p)).length&&A.setAttribs(u,{id:f,class:i,style:"width: "+v+"px"}),(g=A.select(".wp-caption-dd",p)).length&&A.setHTML(g[0],n.caption)):(l="<dl "+(f=f?'id="'+f+'" ':"")+'class="'+i+'" style="width: '+v+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+n.caption+"</dd></dl>",s=A.create("div",{class:"mceTemp"},l),(d=A.getParent(o,"p"))?d.parentNode.insertBefore(s,d):o.parentNode.insertBefore(s,o),e.$(s).find("dt.wp-caption-dt").append(o),d&&A.isEmpty(d)&&A.remove(d))):p&&(d=A.create("p"),p.parentNode.insertBefore(d,p),d.appendChild(o),A.remove(p)),C=(_=e.$(t)).attr("srcset"),y=_.attr("src"),C&&y&&(y=y.replace(/[?#].*/,""),-1===C.indexOf(y)&&_.attr("srcset",null).attr("sizes",null)),wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:e,metadata:n,image:t}),e.nodeChanged()}function d(t){var n,a,i;return"undefined"!=typeof wp&&wp.media?(i=o(t),wp.media.events.trigger("editor:image-edit",{editor:e,metadata:i,image:t}),n=wp.media({frame:"image",state:"image-details",metadata:i}),wp.media.events.trigger("editor:frame-create",{frame:n}),a=function(a){e.focus(),e.undoManager.transact(function(){l(t,a)}),n.detach()},n.state("image-details").on("update",a),n.state("replace-image").on("replace",a),n.on("close",function(){e.focus(),n.detach()}),void n.open()):void e.execCommand("mceImage")}function s(t){var n=e.dom.getParent(t,"div.mceTemp");n||"IMG"!==t.nodeName||(n=e.dom.getParent(t,"a")),n?(n.nextSibling?e.selection.select(n.nextSibling):n.previousSibling?e.selection.select(n.previousSibling):e.selection.select(n.parentNode),e.selection.collapse(!0),e.dom.remove(n)):e.dom.remove(t),e.nodeChanged(),e.undoManager.add()}var m,p,g,u,f=tinymce.each,h=tinymce.trim,w=tinymce.Env.iOS;return e.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){s(e.selection.getNode())}}),e.addButton("wp_img_edit",{tooltip:"Edit|button",icon:"dashicon dashicons-edit",onclick:function(){d(e.selection.getNode())}}),f({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(t,n){var a=n.slice(5);e.addButton("wp_img_"+n,{tooltip:t,icon:"dashicon dashicons-align-"+a,cmd:"alignnone"===n?"wpAlignNone":"Justify"+a.slice(0,1).toUpperCase()+a.slice(1),onPostRender:function(){var t=this;e.on("NodeChange",function(a){var i;"IMG"===a.element.nodeName&&(i=e.dom.getParent(a.element,".wp-caption")||a.element,"alignnone"===n?t.active(!/\balign(left|center|right)\b/.test(i.className)):t.active(e.dom.hasClass(i,n)))})}})}),e.once("preinit",function(){e.wp&&e.wp._createToolbar&&(m=e.wp._createToolbar(["wp_img_alignleft","wp_img_aligncenter","wp_img_alignright","wp_img_alignnone","wp_img_edit","wp_img_remove"]))}),e.on("wptoolbar",function(e){"IMG"!==e.element.nodeName||t(e.element)||(e.toolbar=m)}),w&&e.on("init",function(){e.on("touchstart",function(e){"IMG"!==e.target.nodeName||n(e.target)||(g=!0)}),e.dom.bind(e.getDoc(),"touchmove",function(){g=!1}),e.on("touchend",function(t){if(g&&"IMG"===t.target.nodeName&&!n(t.target)){var a=t.target;g=!1,window.setTimeout(function(){e.selection.select(a),e.nodeChanged()},100)}else m&&m.hide()})}),e.on("init",function(){var t=e.dom,n=e.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";t.addClass(e.getBody(),n),tinymce.Env.ie&&tinymce.Env.ie>10&&t.bind(e.getBody(),"mscontrolselect",function(n){"IMG"===n.target.nodeName&&t.getParent(n.target,".wp-caption")?e.getBody().focus():"DL"===n.target.nodeName&&t.hasClass(n.target,"wp-caption")&&n.target.focus()})}),e.on("ObjectResized",function(t){var n=t.target;"IMG"===n.nodeName&&e.undoManager.transact(function(){var a,i,o=e.dom;n.className=n.className.replace(/\bsize-[^ ]+/,""),(a=o.getParent(n,".wp-caption"))&&((i=t.width||o.getAttrib(n,"width"))&&(i=parseInt(i,10),e.getParam("wpeditimage_html5_captions")||(i+=10),o.setStyle(a,"width",i+"px")))})}),e.on("pastePostProcess",function(t){e.dom.getParent(e.selection.getNode(),"dd.wp-caption-dd")&&(e.$("img, audio, video, object, embed, iframe, script, style",t.node).remove(),e.$("*",t.node).each(function(t,n){e.dom.isBlock(n)&&(tinymce.trim(n.textContent||n.innerText)?(e.dom.insertAfter(e.dom.create("br"),n),e.dom.remove(n,!0)):e.dom.remove(n))}),e.$("br",t.node).each(function(t,n){n.nextSibling&&"BR"!==n.nextSibling.nodeName&&n.previousSibling&&"BR"!==n.previousSibling.nodeName||e.dom.remove(n)}),u=!0)}),e.on("BeforeExecCommand",function(t){var n,a,i,o,r,c,l=t.command,d=e.dom;if("mceInsertContent"===l||"Indent"===l||"Outdent"===l){if(n=e.selection.getNode(),c=d.getParent(n,"div.mceTemp")){if("mceInsertContent"!==l)return t.preventDefault(),t.stopImmediatePropagation(),!1;if(u)return void(u=!1);a=d.create("p"),d.insertAfter(a,c),e.selection.setCursorLocation(a,0),"IMG"===n.nodeName&&e.$(c).remove(),e.nodeChanged()}}else if("JustifyLeft"===l||"JustifyRight"===l||"JustifyCenter"===l||"wpAlignNone"===l){if(n=e.selection.getNode(),o="align"+l.slice(7).toLowerCase(),i=e.dom.getParent(n,".wp-caption"),"IMG"!==n.nodeName&&!i)return;n=i||n,r=e.dom.hasClass(n,o)?" alignnone":" "+o,n.className=h(n.className.replace(/ ?align(left|center|right|none)/g,"")+r),e.nodeChanged(),t.preventDefault(),m&&m.reposition(),e.fire("ExecCommand",{command:l,ui:t.ui,value:t.value})}}),e.on("keydown",function(t){var n,a,i,o,r=e.selection,c=t.keyCode,l=e.dom,d=tinymce.util.VK;if(c===d.ENTER)n=r.getNode(),(a=l.getParent(n,"div.mceTemp"))&&(l.events.cancel(t),tinymce.each(l.select("dt, dd",a),function(e){l.isEmpty(e)&&l.remove(e)}),o=tinymce.Env.ie&&tinymce.Env.ie<11?"":'<br data-mce-bogus="1" />',i=l.create("p",null,o),"DD"===n.nodeName?l.insertAfter(i,a):a.parentNode.insertBefore(i,a),e.nodeChanged(),r.setCursorLocation(i,0));else if((c===d.DELETE||c===d.BACKSPACE)&&("DIV"===(n=r.getNode()).nodeName&&l.hasClass(n,"mceTemp")?a=n:"IMG"!==n.nodeName&&"DT"!==n.nodeName&&"A"!==n.nodeName||(a=l.getParent(n,"div.mceTemp")),a))return l.events.cancel(t),s(n),!1}),tinymce.Env.gecko&&e.on("undo redo",function(){"IMG"===e.selection.getNode().nodeName&&e.selection.collapse()}),e.wpSetImgCaption=function(e){return a(e)},e.wpGetImgCaption=function(e){return i(e)},e.on("beforeGetContent",function(t){"raw"!==t.format&&e.$('img[id="__wp-temp-img-id"]').attr("id",null)}),e.on("BeforeSetContent",function(t){"raw"!==t.format&&(t.content=e.wpSetImgCaption(t.content))}),e.on("PostProcess",function(t){t.get&&(t.content=e.wpGetImgCaption(t.content))}),function(){var t;e.on("dragstart",function(){var n=e.selection.getNode();"IMG"===n.nodeName&&((t=e.dom.getParent(n,".mceTemp"))||"A"!==n.parentNode.nodeName||r(n.parentNode)||(t=n.parentNode))}),e.on("drop",function(n){var a=e.dom,i=tinymce.dom.RangeUtils.getCaretRangeFromPoint(n.clientX,n.clientY,e.getDoc());i&&a.getParent(i.startContainer,".mceTemp")?n.preventDefault():t&&(n.preventDefault(),e.undoManager.transact(function(){i&&e.selection.setRng(i),e.selection.setNode(t),a.remove(t)})),t=null})}(),e.wp=e.wp||{},e.wp.isPlaceholder=t,{_do_shcode:a,_get_shcode:i}});